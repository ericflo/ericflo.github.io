
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Writing an Markov-Chain IRC Bot with Twisted and Python - Eric Florenzano's Blog</title>
  <meta name="author" content="Eric Florenzano">

  
  <meta name="description" content="Twisted is one of Python&#8217;s great secret weapons. It is an absolute workhorse,
allowing for insanely fast network applications to be written &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://eflorenzano.com/blog/2008/11/16/writing-markov-chain-irc-bot-twisted-and-python">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Eric Florenzano's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1959803-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Eric Florenzano's Blog</a></h1>
  
    <h2>I am me.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:eflorenzano.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Writing an Markov-Chain IRC Bot With Twisted and Python</h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-16T21:59:34-08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2008</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a class="reference external" href="http://twistedmatrix.com/trac/">Twisted</a> is one of Python&#8217;s great secret weapons.  It is an absolute workhorse,
allowing for insanely fast network applications to be written with very little
effort.  So let&#8217;s do what everyone does when they want to learn more about
Twisted: let&#8217;s write an IRC bot!  This bot is going to use <a class="reference external" href="http://en.wikipedia.org/wiki/Markov_chain">Markov Chains</a> to
simulate human speech.  For whatever reason, I named this bot &quot;YourMomDotCom&quot;.</p>
<p>First let&#8217;s create a skeleton on top of which the rest of the bot will be
created:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">twisted.words.protocols</span> <span class="kn">import</span> <span class="n">irc</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MomBot</span><span class="p">(</span><span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">_get_nickname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">nickname</span>
</span><span class="line">    <span class="n">nickname</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_nickname</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">signedOn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Signed on as </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nickname</span><span class="p">,)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">joined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Joined </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">channel</span><span class="p">,)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">privmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="n">msg</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MomBotFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>
</span><span class="line">    <span class="n">protocol</span> <span class="o">=</span> <span class="n">MomBot</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">nickname</span><span class="o">=</span><span class="s">&#39;YourMomDotCom&#39;</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">nickname</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">clientConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Lost connection (</span><span class="si">%s</span><span class="s">), reconnecting.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reason</span><span class="p">,)</span>
</span><span class="line">        <span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">clientConnectionFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Could not connect: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reason</span><span class="p">,)</span>
</span></code></pre></td></tr></table></div></figure><p>We&#8217;ve now created an <tt class="docutils literal">IRCClient</tt> subclass which will hold our application
logic, and we&#8217;ve also written a factory class which will create instances of
that <tt class="docutils literal">MomBot</tt> client.  Let&#8217;s tie these together and start the event loop:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class="line">    <span class="n">chan</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line">    <span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="s">&#39;irc.freenode.net&#39;</span><span class="p">,</span> <span class="mi">6667</span><span class="p">,</span> <span class="n">MomBotFactory</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="n">chan</span><span class="p">))</span>
</span><span class="line">    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure><p>Now already we have a complete working IRC bot.  Right now all it will do is
connect to an IRC channel and echo all of the output to the command line.  Not
bad for how little code we&#8217;ve written. Now all we have to do is implement our
application logic.  Let&#8217;s first start by creating the &#8216;brain&#8217; of our Markov
chain responder, and adding a function to train the brain:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span><span class="line">
</span><span class="line"><span class="n">markov</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span class="line"><span class="n">STOP_WORD</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">add_to_brain</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">chain_length</span><span class="p">,</span> <span class="n">write_to_file</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span class="line">    <span class="k">if</span> <span class="n">write_to_file</span><span class="p">:</span>
</span><span class="line">        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;training_text.txt&#39;</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">STOP_WORD</span><span class="p">]</span> <span class="o">*</span> <span class="n">chain_length</span>
</span><span class="line">    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
</span><span class="line">        <span class="n">markov</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">buf</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</span><span class="line">        <span class="k">del</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</span><span class="line">    <span class="n">markov</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">buf</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">STOP_WORD</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>In this, we are creating a defaultdict of lists.  For every n-word sliding
window, the word after that window is appended to the list of possible words.
Here&#8217;s an image which hopefully depicts better than words how the algorithm
populates the brain:</p>
<img alt="http://media.eflorenzano.com/img/markov.png" src="http://media.eflorenzano.com/img/markov.png" />
<p>But what good is a brain like this if we can&#8217;t get words back from it.  We&#8217;re
going to need to write a function to generate sentences from that brain:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">generate_sentence</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">chain_length</span><span class="p">,</span> <span class="n">max_words</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
</span><span class="line">    <span class="n">buf</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="n">chain_length</span><span class="p">]</span>
</span><span class="line">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">chain_length</span><span class="p">:</span>
</span><span class="line">        <span class="n">message</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:]</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">message</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">chain_length</span><span class="p">):</span>
</span><span class="line">            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">markov</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">markov</span><span class="o">.</span><span class="n">keys</span><span class="p">())]))</span>
</span><span class="line">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">max_words</span><span class="p">):</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="n">next_word</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">markov</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">buf</span><span class="p">)])</span>
</span><span class="line">        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span class="line">            <span class="k">continue</span>
</span><span class="line">        <span class="k">if</span> <span class="n">next_word</span> <span class="o">==</span> <span class="n">STOP_WORD</span><span class="p">:</span>
</span><span class="line">            <span class="k">break</span>
</span><span class="line">        <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_word</span><span class="p">)</span>
</span><span class="line">        <span class="k">del</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_word</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>We start out our seed buffer with the first few words of the message, and if the
message wasn&#8217;t long enough, we fill the seed buffer with some random words from
the markov&#8217;s brain.  Then we use the buffer as a key into the markov brain and
randomly pick one of the values as our next word.  Then we slide that buffer
so that the chosen word is now the next word in the buffer (ejecting the oldest
word in the buffer).  If we ever see a stop word, we stop and return the
generated sentence.</p>
<p>Now it&#8217;s a matter of expanding our bot to take advantage of our markov brain.
The first change we will need to make is to modify the <tt class="docutils literal">MomBotFactory</tt> to take
more parameters in its <tt class="docutils literal">__init__</tt> method:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">MomBotFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>
</span><span class="line">    <span class="n">protocol</span> <span class="o">=</span> <span class="n">MomBot</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">nickname</span><span class="o">=</span><span class="s">&#39;YourMomDotCom&#39;</span><span class="p">,</span> <span class="n">chain_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span class="line">        <span class="n">chattiness</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_words</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">nickname</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">=</span> <span class="n">chain_length</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">chattiness</span> <span class="o">=</span> <span class="n">chattiness</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">max_words</span> <span class="o">=</span> <span class="n">max_words</span>
</span><span class="line">
</span><span class="line">    <span class="c"># ...</span>
</span></code></pre></td></tr></table></div></figure><p>Now that it has all of that new information, we can add the final bit of
functionality to <tt class="docutils literal">MomBot</tt> responding using sentences generated from the
markov brain by updating the <tt class="docutils literal">privmsg</tt> method:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">MomBot</span><span class="p">(</span><span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="c"># ...</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">privmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span class="line">            <span class="k">return</span>
</span><span class="line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
</span><span class="line">            <span class="n">msg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">+</span> <span class="s">&quot;[:,]* ?&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span class="line">            <span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line">        <span class="n">add_to_brain</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">chain_length</span><span class="p">,</span> <span class="n">write_to_file</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">chattiness</span><span class="p">:</span>
</span><span class="line">            <span class="n">sentence</span> <span class="o">=</span> <span class="n">generate_sentence</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">chain_length</span><span class="p">,</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">max_words</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="n">sentence</span><span class="p">:</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">sentence</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>If it gets a message from a non-user, we don&#8217;t care about it, so we just
disregard that message.  Otherwise, if it&#8217;s a message directed at the bot, we
want to respond to the sending user so we add the user as a prefix to our next
message.  Then we grab a sentence from the markov brain and send it to the
channel.</p>
<p>Not so bad.  Now lets modify our startup portion of the script to re-train the
brain with anything learned during the course of the bot&#8217;s life.  Here&#8217;s how
the new script will look:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">chan</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line">    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Please specify a channel name.&quot;</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Example:&quot;</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;  python yourmomdotcom.py django-hotclub&quot;</span>
</span><span class="line">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;training_text.txt&#39;</span><span class="p">):</span>
</span><span class="line">        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;training_text.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">            <span class="n">add_to_brain</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">chain_length</span><span class="p">)</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&#39;Brain Reloaded&#39;</span>
</span><span class="line">        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">    <span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="s">&#39;irc.freenode.net&#39;</span><span class="p">,</span> <span class="mi">6667</span><span class="p">,</span> <span class="n">MomBotFactory</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="n">chan</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;YourMomDotCom&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">chattiness</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
</span><span class="line">    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure><p>I have found personally that, counter-intuitively, a length of <strong>2</strong> seems to
produce the most realistic-looking responses.  We&#8217;ve really accomplished a lot
in a very little amount of code.  Instead of my normal closing remarks, let me
simply close with a snippet of conversation recently had with YourMomDotCom:</p>
<pre class="literal-block">
[9:57pm] ericflo: YourMomDotCom: Hello, I'd like to show you off for the readers of my blog.
[9:57pm] YourMomDotCom: ericflo: Hello, I'd like to do, after checking with another.
[9:57pm] ericflo: YourMomDotCom: I'm not exactly sure what you mean by that.
[9:57pm] YourMomDotCom: ericflo: I'm not sure, but I'm in &quot;Easter mode&quot; already I think.
[9:58pm] ericflo: YourMomDotCom: That's funny since we aren't really very close to easter.
[9:58pm] YourMomDotCom: ericflo: That's funny since i missed much of a ForeignKey field?
[9:58pm] ericflo: YourMomDotCom: I miss ForeignKey fields all the time
[9:58pm] YourMomDotCom: ericflo: I miss that
[9:58pm] ericflo: YourMomDotCom: We both agree, then.
[9:58pm] YourMomDotCom: ericflo: We both agree, then.
[9:58pm] ericflo: YourMomDotCom: yay!
</pre></div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Eric Florenzano</span></span>

      








  


<time datetime="2008-11-16T21:59:34-08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2008</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/bot/'>Bot</a>, <a class='category' href='/blog/categories/irc/'>IRC</a>, <a class='category' href='/blog/categories/markov-chains/'>Markov Chains</a>, <a class='category' href='/blog/categories/python/'>Python</a>, <a class='category' href='/blog/categories/twisted/'>Twisted</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://eflorenzano.com/blog/2008/11/16/writing-markov-chain-irc-bot-twisted-and-python/" data-via="ericflo" data-counturl="http://eflorenzano.com/blog/2008/11/16/writing-markov-chain-irc-bot-twisted-and-python/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2008/11/15/exploring-erlangs-genserver/" title="Previous Post: Exploring Erlang's gen_server">&laquo; Exploring Erlang's gen_server</a>
      
      
        <a class="basic-alignment right" href="/blog/2008/11/17/wsgi-middlware-awesome-django-use-it-more/" title="next Post: WSGI middleware is awesome, and Django should use it more">WSGI middleware is awesome, and Django should use it more &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/04/18/using-twitter-ios5-integration-single-sign-on/">Using Twitter's iOS5 Integration for Single Sign-On</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/01/01/reducing-code-nesting/">Reducing Code Nesting</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/02/16/technology-behind-convore/">The Technology Behind Convore</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/10/10/object-lesson-how-respond-criticism/">An Object Lesson in How to Respond to Criticism</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/09/27/why-node-disappoints-me/">Why node.js disappoints me</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("ericflo", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/ericflo" class="twitter-follow-button" data-show-count="false">Follow @ericflo</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/109591387819364984777?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Eric Florenzano -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
