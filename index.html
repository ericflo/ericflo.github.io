
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title></title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <link href="/atom.xml" rel="alternate" title="Eric Florenzano's Blog" type="application/atom+xml">

    <link href="/static/css/bootstrap.css" rel="stylesheet">
    <link href="/static/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/static/css/code.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/static/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    
  </head>

  <body>
    <div class="container">
      <div class="center-column">
        <h1 class="blog-header"><a href="/">Eric Florenzano&rsquo;s Blog</a></h1>
        <ul class="blog-header-links">
          <li>Home</li>
          <li><a href="/blog/archives/">Archives</a></li>
          <li><a href="https://twitter.com/ericflo" class="twitter-follow-button" data-show-count="false">Follow @ericflo</a></li>
          <li class="feed"><a onclick="(function(){var z=document.createElement('script');z.src='https://www.subtome.com/load.js';document.body.appendChild(z);})(); return false" href="/atom.xml" ><img src="/static/img/feed-icon-28x28.png" width="20" height="20" alt="Subscribe to this blog" /></a></li>
        </ul>
        

  <h3><a href="/blog/2014/04/12/an-idea-for-android-hybrid-native-html/">An idea for an alternative Android hybrid native/html approach</a></h3>
<p class="datetime">Apr 12, 2014</p>
<div class="document">
<p>I've been doing Android development again recently, and right after doing so
much work using React.js, it's made me really aware of how we handle state and
state transitions.  The way React handles it is handy and I was thinking, it
would be nice if there were something in the Android world to help manage that.</p>
<p>Then I went to edit one of my layout XML files and had an epiphany: React.js
renders out HTML to be interpreted by the browser, but these layout XML files
aren't very different at all from HTML.  If we could just write a diff engine
on the Android side to apply view hierarchy changes, we could render fully
native widgets with React.js components.</p>
<p>Here's an example layout XML file that could come from some kind of funny
images app, where it shows an image alongside some text representing that
image's 'tags':</p>
<pre class="code xml literal-block">
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;RelativeLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
    <span class="na">android:paddingLeft=</span><span class="s">&quot;64dp&quot;</span>
    <span class="na">android:paddingRight=</span><span class="s">&quot;64dp&quot;</span>
    <span class="na">android:paddingTop=</span><span class="s">&quot;4dp&quot;</span>
    <span class="na">android:paddingBottom=</span><span class="s">&quot;16dp&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ImageView</span>
      <span class="na">android:id=</span><span class="s">&quot;&#64;+id/image&quot;</span>
      <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
      <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
      <span class="na">android:scaleType=</span><span class="s">&quot;centerCrop&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;TextView</span>
      <span class="na">android:id=</span><span class="s">&quot;&#64;+id/tags&quot;</span>
      <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
      <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
      <span class="na">android:layout_below=</span><span class="s">&quot;&#64;id/image&quot;</span>
      <span class="na">android:gravity=</span><span class="s">&quot;center&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/RelativeLayout&gt;</span>
</pre>
<p>Android developers write Java classes which inflate this XML, attach to the
subviews it cares about ('image' and 'tags', in this case) and set the correct
text and image bitmaps.  Here's a simple version of what that looks like:</p>
<pre class="code java literal-block">
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FunnyImage</span> <span class="n">extendds</span> <span class="n">RelativeLayout</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">ImageView</span> <span class="n">mImage</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">TextView</span> <span class="n">mTags</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">FunnyImage</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">LayoutInflater</span> <span class="n">inflater</span> <span class="o">=</span> <span class="o">(</span><span class="n">LayoutInflater</span><span class="o">)</span>
      <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">LAYOUT_INFLATER_SERVICE</span><span class="o">);</span>
    <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">funny_image</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">mImage</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">image</span><span class="o">);</span>
    <span class="n">mTags</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">tags</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTags</span><span class="o">(</span><span class="n">String</span> <span class="n">tags</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mTags</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">tags</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setImageBitmap</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">bitmap</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mImage</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>What if we could write this same thing in React.js style?</p>
<pre class="code as literal-block">
<span class="k">var</span> <span class="nx">FunnyImage</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">({</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">RelativeLayout</span>
        <span class="nx">layoutWidth</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
        <span class="nx">layoutHeight</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
        <span class="nx">paddingLeft</span><span class="o">=</span><span class="s2">&quot;64dp&quot;</span>
        <span class="nx">paddingRight</span><span class="o">=</span><span class="s2">&quot;64dp&quot;</span>
        <span class="nx">paddingTop</span><span class="o">=</span><span class="s2">&quot;4dp&quot;</span>
        <span class="nx">paddingBottom</span><span class="o">=</span><span class="s2">&quot;16dp&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">ImageView</span>
          <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;&#64;+id/image&quot;</span>
          <span class="nx">layoutWidth</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
          <span class="nx">layoutHeight</span><span class="o">=</span><span class="s2">&quot;wrap_content&quot;</span>
          <span class="nx">scaleType</span><span class="o">=</span><span class="s2">&quot;centerCrop&quot;</span>
          <span class="nx">src</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">bitmap</span><span class="p">}</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">TextView</span>
          <span class="nx">layoutWidth</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
          <span class="nx">layoutHeight</span><span class="o">=</span><span class="s2">&quot;wrap_content&quot;</span>
          <span class="nx">layoutBelow</span><span class="o">=</span><span class="s2">&quot;&#64;id/image&quot;</span>
          <span class="nx">gravity</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
          <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">tags</span><span class="p">}</span> <span class="o">/&gt;</span>
      <span class="o">&lt;/</span><span class="nx">RelativeLayout</span><span class="o">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre>
<p>I quite like this declarative style.  But we haven't really accomplished much
here yet.  How about we take it further, and take a URL and load a bitmap,
updating the state and using a loading drawable in the meantime:</p>
<pre class="code as literal-block">
<span class="k">var</span> <span class="nx">FunnyImage</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">({</span>
  <span class="nx">getInitialData</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">bitmap</span><span class="o">:</span> <span class="kc">null</span><span class="p">};</span>
  <span class="p">}</span><span class="o">,</span>

  <span class="nx">componentDidMount</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">HttpUtils</span><span class="p">.</span><span class="nx">getImageBitmap</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">url</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleBitmapLoaded</span><span class="p">);</span>
  <span class="p">}</span><span class="o">,</span>

  <span class="nx">handleBitmapLoaded</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="o">,</span> <span class="nx">bitmap</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">bitmap</span><span class="o">:</span> <span class="nx">bitmap</span><span class="p">});</span>
  <span class="p">}</span><span class="o">,</span>

  <span class="nx">getLoadingDrawable</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ResourceUtils</span><span class="p">.</span><span class="nx">getDrawable</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">loading</span><span class="p">);</span>
  <span class="p">}</span><span class="o">,</span>

  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">RelativeLayout</span>
        <span class="nx">layoutWidth</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
        <span class="nx">layoutHeight</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
        <span class="nx">paddingLeft</span><span class="o">=</span><span class="s2">&quot;64dp&quot;</span>
        <span class="nx">paddingRight</span><span class="o">=</span><span class="s2">&quot;64dp&quot;</span>
        <span class="nx">paddingTop</span><span class="o">=</span><span class="s2">&quot;4dp&quot;</span>
        <span class="nx">paddingBottom</span><span class="o">=</span><span class="s2">&quot;16dp&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">ImageView</span>
          <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;&#64;+id/image&quot;</span>
          <span class="nx">layoutWidth</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
          <span class="nx">layoutHeight</span><span class="o">=</span><span class="s2">&quot;wrap_content&quot;</span>
          <span class="nx">scaleType</span><span class="o">=</span><span class="s2">&quot;centerCrop&quot;</span>
          <span class="nx">src</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">bitmap</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">getLoadingDrawable</span><span class="p">()}</span> <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">TextView</span>
          <span class="nx">layoutWidth</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
          <span class="nx">layoutHeight</span><span class="o">=</span><span class="s2">&quot;wrap_content&quot;</span>
          <span class="nx">layoutBelow</span><span class="o">=</span><span class="s2">&quot;&#64;id/image&quot;</span>
          <span class="nx">gravity</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
          <span class="nx">text</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">tags</span><span class="p">}</span> <span class="o">/&gt;</span>
      <span class="o">&lt;/</span><span class="nx">RelativeLayout</span><span class="o">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre>
<p>Let's pull it all together and create an app that fetches these images from
a public data feed:</p>
<pre class="code as literal-block">
<span class="k">var</span> <span class="nx">FunnyImages</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">({</span>
  <span class="nx">getInitialData</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">images</span><span class="o">:</span> <span class="p">[]};</span>
  <span class="p">}</span><span class="o">,</span>

  <span class="nx">componentDidMount</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">HttpUtils</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">'http://puppygifs.net/api/read/json'</span><span class="o">,</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">handleImagesLoaded</span><span class="p">);</span>
  <span class="p">}</span><span class="o">,</span>

  <span class="nx">handleImagesLoaded</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="o">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">AlertDialog</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="s1">'Could not fetch puppies: '</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="nx">images</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">post</span><span class="p">[</span><span class="s1">'photo-url-500'</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">image</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">images</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="nx">image</span><span class="o">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="nx">post</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)});</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">images</span><span class="o">:</span> <span class="nx">images</span><span class="p">});</span>
  <span class="p">}</span><span class="o">,</span>

  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">RelativeLayout</span>
        <span class="nx">layoutWidth</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span>
        <span class="nx">layoutHeight</span><span class="o">=</span><span class="s2">&quot;match_parent&quot;</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">image</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">(</span>
            <span class="o">&lt;</span><span class="nx">FunnyImage</span>
              <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">image</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span>
              <span class="nx">image</span><span class="o">=</span><span class="p">{</span><span class="nx">image</span><span class="p">}</span>
              <span class="nx">loading</span><span class="o">=</span><span class="s2">&quot;&#64;drawable/loading&quot;</span> <span class="o">/&gt;;</span>
          <span class="p">);</span>
        <span class="p">})}</span>
      <span class="o">&lt;/</span><span class="nx">RelativeLayout</span><span class="o">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre>
<p>Alas this is it for now.  I haven't written that diff engine to prove this is
even possible.  Hopefully on a rainy day I'll have a chance to hack on it and
see whether there's merit.  But for now, I just had to get the idea out of my
brain and at least into words and pseudocode, and to get feedback.  Am I off my
rocker here, or does this sound genuinely cool?</p>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/react/">React</a></li>
      
        <li><a href="/blog/categories/reactjs/">ReactJS</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/android/">Android</a></li>
      
    </ul>
  </div>
  <hr />

  <h3><a href="/blog/2014/04/11/react-part-3-frontend-server/">Server/Client With React, Part 3: Frontend Server</a></h3>
<p class="datetime">Apr 11, 2014</p>
<div class="document">
<p>In the past two posts, we <a class="reference external" href="http://eflorenzano.com/blog/2014/04/09/react-part-1-getting-started/">started writing the client code</a>, and then
<a class="reference external" href="http://eflorenzano.com/blog/2014/04/10/react-part-2-build-system/">made it build</a>.  What's stopping us from loading it in our browser?  It's not
being served yet!  Let's fix that, starting with installing <a class="reference external" href="http://www.senchalabs.org/connect/">Connect</a> -- the
middleware we'll use to build our http server.</p>
<pre class="code console literal-block">
<span class="go">npm install --save connect</span>
</pre>
<p>Why not some other thing like <a class="reference external" href="http://koajs.com/">Koa</a>, <a class="reference external" href="https://github.com/spumko/hapi">hapi</a>, or <a class="reference external" href="https://github.com/mjijackson/mach">mach</a>?  No real reason.  Our
needs are simple and any one of those would work well.  I chose <a class="reference external" href="http://www.senchalabs.org/connect/">Connect</a>
because it's popular, it'd been around a while, and it seemed to work well
enough.</p>
<p>Now let's create a file <tt class="docutils literal">server.js</tt> right at the root of our project,
starting with the basics, and we'll fill in more as we go:</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'connect'</span><span class="p">);</span>

<span class="c1">// Set up the application and run it
</span><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">(</span><span class="p">);</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/build'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">csrf</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
</pre>
<p>Running this file will start up a server listening on port 5000, serving any
static files that are found in /build, which knows how to parse querystrings,
form submissions, and json, and is protected against CSRF attacks.  So far, so
easy.  Now let's add cookie sessions, where I've found that <tt class="docutils literal">maxAge</tt> needs to
be set per-request in <a class="reference external" href="http://www.senchalabs.org/connect/">Connect</a> for some reason:</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'connect'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">IRLMOJI_COOKIE_SECRET</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="s1">'IRLMOJI_COOKIE_SECRET'</span><span class="p">];</span>

<span class="kd">function</span> <span class="nx">fixConnectCookieSessionHandler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">maxAge</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Set up the application and run it
</span><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">(</span><span class="p">);</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/build'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">cookieSession</span><span class="p">(</span><span class="p">{</span>
    <span class="nx">secret</span><span class="o">:</span> <span class="nx">IRLMOJI_COOKIE_SECRET</span><span class="p">,</span>
    <span class="nx">cookie</span><span class="o">:</span> <span class="p">{</span><span class="nx">maxAge</span><span class="o">:</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="nx">proxy</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span>
  <span class="p">}))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">fixConnectCookieSessionHandler</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">csrf</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
</pre>
<p>Now we're up and running with a cookie-based session system, but we're not yet
using it.  In fact, we're not using any of this yet, because we're not rendering
or serving the main site yet.  We can write that now:</p>
<pre class="code js literal-block">
<span class="c1">// Note that we're importing from the build directory
</span><span class="kd">var</span> <span class="nx">makeRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./build/javascript/router'</span><span class="p">).</span><span class="nx">makeRouter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./build/javascript/routes'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">reactHandler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Render implemented here so it can capture req/res in its closure
</span>  <span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">reactComp</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We'll implement this next
</span>  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">render</span><span class="o">:</span> <span class="nx">render</span><span class="p">,</span>
    <span class="nx">isServer</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">getUrl</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">proto</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">'x-forwarded-proto'</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'http'</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">proto</span> <span class="o">+</span> <span class="s1">'://'</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">getPath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">makeRouter</span><span class="p">(</span>
    <span class="nx">routes</span><span class="p">.</span><span class="nx">getRoutes</span><span class="p">(</span><span class="nx">app</span><span class="p">),</span>
    <span class="nx">routes</span><span class="p">.</span><span class="nx">getNotFound</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
  <span class="p">);</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">getPath</span><span class="p">(</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// ...
</span>
<span class="c1">// Set up the application and run it
</span><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">connect</span><span class="p">(</span><span class="p">);</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/build'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="p">))</span>
  <span class="c1">// ...
</span>  <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">reactHandler</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
</pre>
<p>The basic idea here is to build an <tt class="docutils literal">app</tt> object that exactly mimics the
functionality available on the app object in <tt class="docutils literal">frontend/javascript/client.js</tt>
that we built in <a class="reference external" href="http://eflorenzano.com/blog/2014/04/09/react-part-1-getting-started/">part 1</a>.  To do so, we create this object on-the-fly using
the information available to us from the request.  Then we import that same
simple router we used before, and tell the router to route and render its
contents by calling the <tt class="docutils literal">go</tt> function with the current path as a parameter.</p>
<p>How do we actually render it though?  We left that function blank.  Before we
work on that, we need some sort of HTML template to work from.   Let's
build our basic HTML page template in <tt class="docutils literal">frontend/page.html</tt>:</p>
<pre class="code html+django literal-block">
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">content=</span><span class="s">&quot;IE=edge,chrome=1&quot;</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;Take a pic that looks like an emoji!&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;author&quot;</span> <span class="na">content=</span><span class="s">&quot;IRLMoji&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">content=</span><span class="s">&quot;yes&quot;</span> <span class="na">name=</span><span class="s">&quot;apple-mobile-web-app-capable&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span><span class="cp">{{</span> <span class="nv">PAGE_TITLE</span> <span class="cp">}}</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//cdnjs.cloudflare.com/ajax/libs/es5-shim/2.2.0/es5-shim.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//cdnjs.cloudflare.com/ajax/libs/es5-shim/2.2.0/es5-sham.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">STYLE_PATH</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">BODY_CLASS</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;react-root&quot;</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="nv">BODY_CONTENT</span> <span class="cp">}}</span><span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">style=</span><span class="s">&quot;display: none&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">id=</span><span class="s">&quot;csrftoken&quot;</span> <span class="na">name=</span><span class="s">&quot;csrf&quot;</span> <span class="na">value=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">CSRF_TOKEN</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">SCRIPT_PATH</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre>
<p>This &quot;template&quot; has no real logic (it's just a frame) so we can
use basic variable substitution -- in this case, in the style of Django
templates.  So that's what our render function will have to do: determine what
should be inserted for e.g. <tt class="docutils literal">BODY_CONTENT</tt> and <tt class="docutils literal">PAGE_TITLE</tt>, render the
template with that content, and serve it up to the user.  Here's a first stab
at it:</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'lodash/dist/lodash.underscore'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">NODE_ENV</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="s1">'NODE_ENV'</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">PROD</span> <span class="o">=</span> <span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="s1">'production'</span><span class="p">;</span>

<span class="c1">// Read the whole template into memory, no need to re-read it every request
</span><span class="kd">var</span> <span class="nx">PAGE_TEMPLATE</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">'frontend/page.html'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">reactComp</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{</span><span class="p">};</span>

    <span class="c1">// Render the React component to a string
</span>    <span class="kd">var</span> <span class="nx">bodyContent</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">renderComponentToString</span><span class="p">(</span><span class="nx">reactComp</span><span class="p">);</span>

    <span class="c1">// Build up the list of variable substitutions
</span>    <span class="kd">var</span> <span class="nx">sub</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">BODY_CLASS</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">bodyClass</span> <span class="o">||</span> <span class="s1">''</span><span class="p">,</span>
      <span class="nx">BODY_CONTENT</span><span class="o">:</span> <span class="nx">bodyContent</span><span class="p">,</span>
      <span class="nx">CSRF_TOKEN</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">csrfToken</span><span class="p">(</span><span class="p">),</span>
      <span class="nx">SCRIPT_PATH</span><span class="o">:</span> <span class="s1">'/javascript/compiled'</span> <span class="o">+</span> <span class="p">(</span><span class="nx">PROD</span> <span class="o">?</span> <span class="s1">'.min'</span> <span class="o">:</span> <span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'.js'</span><span class="p">,</span>
      <span class="nx">STYLE_PATH</span><span class="o">:</span> <span class="s1">'/styles/main'</span> <span class="o">+</span> <span class="p">(</span><span class="nx">PROD</span> <span class="o">?</span> <span class="s1">'.min'</span> <span class="o">:</span> <span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'.css'</span><span class="p">,</span>
      <span class="nx">PAGE_TITLE</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="s1">'IRLMoji'</span>
    <span class="p">};</span>

    <span class="c1">// Create a regex out of the variable substituion object
</span>    <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'{{ ('</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">sub</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'|'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">') }}'</span><span class="p">,</span> <span class="s1">'g'</span><span class="p">);</span>

    <span class="c1">// Start the response
</span>    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">||</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'text/html'</span><span class="p">});</span>

    <span class="c1">// Substitute all the variables and write it to the response to finish
</span>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="p">(</span><span class="s1">''</span> <span class="o">+</span> <span class="nx">PAGE_TEMPLATE</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">sub</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)];</span>
    <span class="p">}));</span>
<span class="p">}</span>
</pre>
<p>We could have used any templating language, but as you can see, most
of what's going on happens inside of <tt class="docutils literal"><span class="pre">react-root</span></tt>, so this is all we'll need.</p>
<p>Hey, we're live!  If we start up our server by running:</p>
<pre class="literal-block">
gulp watch
</pre>
<p>We'll see build directory cleaned up, then the files generated, then the server
will start up.  Cool!  Let's open the browser to <a class="reference external" href="http://127.0.0.1:5000">http://127.0.0.1:5000</a>, and
it should say &quot;Hello, World!&quot;, as that's what we have in our <tt class="docutils literal">handleIndex()</tt>
function in <tt class="docutils literal">frontend/javascript/routes.js</tt>.</p>
<p>You can check out what the fully-built demo site is doing in <tt class="docutils literal">server.js</tt> by
<a class="reference external" href="https://github.com/ericflo/irlmoji/blob/master/server.js">visiting the code on github</a>.</p>
<div class="section" id="what-is-happening-here">
<h4>What is happening here?</h4>
<p>Now that we've got the basic structure of our site set up, what all is
happening?</p>
<ul class="simple">
<li>The server looks at the URL, routes to the right React component, and renders
our hello world component to a string.</li>
<li>Then it interpolates that string into the html page template and servers it
up to the user.</li>
<li>In that template, we've told the browser to load a script which is the
browserified (and potentially minified) version of <tt class="docutils literal">client.js</tt>, which is an
implementation of the app that was used to render the page. (Whoa.)</li>
<li>The browser downloads and executes that script, which in turn runs its router
on the client side and routes to the same component.</li>
<li>React does a fast checksum and notices that, hey, the markup we just
generated on the client matches what was just served from the server, so it
doesn't change the DOM.</li>
</ul>
<p>So now we've loaded a javascript implementation of the website frontend, and
attached it to the existing markup that was served down the wire.  Pretty cool,
but right now we're not taking advantage of that.  Soon we will :)</p>
</div>
<div class="section" id="what-s-next">
<h4>What's Next?</h4>
<ul class="simple">
<li>Build the communications layer between the frontend and the API</li>
<li>Ensure that the client re-uses the same data the server used when it rendered</li>
<li>Build a basic IRLMoji timeline</li>
<li>Implement camera upload by interfacing with non-React JavaScript
<a class="reference external" href="http://www.dropzonejs.com/">Dropzone.js</a></li>
<li>Finish building the app and deploy it</li>
</ul>
</div>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/react/">React</a></li>
      
        <li><a href="/blog/categories/reactjs/">ReactJS</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/server/">Server</a></li>
      
        <li><a href="/blog/categories/client/">Client</a></li>
      
        <li><a href="/blog/categories/javascript/">Javascript</a></li>
      
    </ul>
  </div>
  <hr />

  <h3><a href="/blog/2014/04/10/react-part-2-build-system/">Server/Client With React, Part 2: The Build System</a></h3>
<p class="datetime">Apr 10, 2014</p>
<div class="document">
<p>In the <a class="reference external" href="http://eflorenzano.com/blog/2014/04/09/react-part-1-getting-started/">last post</a>, we started writing the client glue code and our first React
component.  But we're using things like <tt class="docutils literal">require()</tt> for something that should
be run on the client, how will that work?  <a class="reference external" href="http://browserify.org/">Browserify</a> can take a look at our
<tt class="docutils literal">client.js</tt>, walk the dependencies, and spit out something that browsers can
actually execute.  Let's set that up!</p>
<p>But first a bit about how we'll structure the app.  This is how things look
currently:</p>
<pre class="literal-block">
frontend/
    javascript/
        client.js
        routes.js
        components/
            common.js
</pre>
<p>But these JavaScript files need processing.  Some of them have JSX in them,
which needs to be converted to pure JavaScript.  It all needs to be transformed
to work in the browser.  Additionally, we may have other non-JS files that we
want to preprocess.  To address this, we'll do all this processing and save it
in a directory adjacent to <tt class="docutils literal">frontend</tt> named <tt class="docutils literal">build</tt>.</p>
<p>Here's the basic idea of how things will look after this blog post:</p>
<pre class="literal-block">
build/
    images/
    javascript/
        compiled.js
        compiled.min.js
        client.js
        client.min.js
        routes.js
        routes.min.js
        components/
            common.js
            common.min.js
    styles/
        main.js
        main.min.js
frontend/
    images/
    javascript/
        client.js
        routes.js
        components/
            common.js
    styles/
        main.less
    tests/
gulpfile.js
package.json
</pre>
<p>First make sure you have a <tt class="docutils literal">package.json</tt> file.  If you're not familiar with
this file, here's <a class="reference external" href="http://docs.nodejitsu.com/articles/getting-started/npm/what-is-the-file-package-json">some light reading</a> about it.  We're going to use <a class="reference external" href="http://gulpjs.com/">Gulp</a> to
do our processing, and we need a number of plugins to make that work.  These
commands should get you started:</p>
<pre class="code console literal-block">
<span class="go">npm install --save react react-tools lodash
npm install --save-dev browserify envify gulp gulp-util gulp-uglify \
    gulp-clean gulp-rename gulp-browserify gulp-less gulp-react \
    gulp-minify-css gulp-nodemon</span>
</pre>
<p>Now that we have the dependencies installed, let's create a file named
<tt class="docutils literal">gulpfile.js</tt> which will describe to <a class="reference external" href="http://gulpjs.com/">Gulp</a> how to build the app:</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">clean</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-clean'</span><span class="p">);</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'clean'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="p">[</span><span class="s1">'build/*'</span><span class="p">],</span> <span class="p">{</span><span class="nx">read</span><span class="o">:</span> <span class="kc">false</span><span class="p">}).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">clean</span><span class="p">(</span><span class="p">));</span>
<span class="p">});</span>
</pre>
<p>So far it's not that impressive, all we're doing is deleting anything inside
the <tt class="docutils literal">build/</tt>, directory, which doesn't even exist.  We noted earlier that
some of the JavaScript had JSX in it, and would need to be processed, so let's
set that up by adding this to <tt class="docutils literal">gulpfile.js</tt>:</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">react</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-react'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">uglify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-uglify'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">rename</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-rename'</span><span class="p">);</span>

<span class="c1">// Parse and compress JS and JSX files
</span>
<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'javascript'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Listen to every JS file in ./frontend/javascript
</span>  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">'frontend/javascript/**/*.js'</span><span class="p">)</span>
    <span class="c1">// Turn React JSX syntax into regular javascript
</span>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">react</span><span class="p">(</span><span class="p">))</span>
    <span class="c1">// Output each file into the ./build/javascript/ directory
</span>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'build/javascript/'</span><span class="p">))</span>
    <span class="c1">// Optimize each JavaScript file
</span>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">uglify</span><span class="p">(</span><span class="p">))</span>
    <span class="c1">// Add .min.js to the end of each optimized file
</span>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="p">{</span><span class="nx">suffix</span><span class="o">:</span> <span class="s1">'.min'</span><span class="p">}))</span>
    <span class="c1">// Output each optimized .min.js file into the ./build/javascript/ dir
</span>    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'build/javascript/'</span><span class="p">));</span>
<span class="p">});</span>
</pre>
<p>Now let's set up browserify to transform the <tt class="docutils literal">require()</tt> calls into
JavaScript the browser understands.  You'll notice this matches the structure
of the previous code block almost exactly, except we're swapping out a
call to <tt class="docutils literal">browserify()</tt> instead of a call to <tt class="docutils literal">react()</tt>:</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">browserify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-browserify'</span><span class="p">);</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'browserify'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'javascript'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">'build/javascript/client.js'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">browserify</span><span class="p">(</span><span class="p">{</span><span class="nx">transform</span><span class="o">:</span> <span class="p">[</span><span class="s1">'envify'</span><span class="p">]}))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="s1">'compiled.js'</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'build/javascript/'</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">uglify</span><span class="p">(</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="p">{</span><span class="nx">suffix</span><span class="o">:</span> <span class="s1">'.min'</span><span class="p">}))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'build/javascript/'</span><span class="p">));</span>
<span class="p">});</span>
</pre>
<p>And like I mentioned, there are things other than JavaScript which need to be
processed too!</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">less</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-less'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">minifycss</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-minify-css'</span><span class="p">);</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'styles'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">'frontend/**/*.less'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">less</span><span class="p">(</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'build/'</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">minifycss</span><span class="p">(</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="p">{</span><span class="nx">suffix</span><span class="o">:</span> <span class="s1">'.min'</span><span class="p">}))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'build/'</span><span class="p">));</span>
<span class="p">});</span>
</pre>
<p>But no <tt class="docutils literal">gulpfile.js</tt> is complete without a <tt class="docutils literal">default</tt> task that will run
when the user types just <tt class="docutils literal">gulp</tt> in their console:</p>
<pre class="code js literal-block">
<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'default'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'clean'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">'browserify'</span><span class="p">,</span> <span class="s1">'styles'</span><span class="p">);</span>
<span class="p">});</span>
</pre>
<p>This says to run <tt class="docutils literal">clean</tt> as a dependency, then to run the <tt class="docutils literal">browserify</tt> and
<tt class="docutils literal">styles</tt> tasks in parallel, and finish when everything returns.  So just to
hammer this point home, all you need to do to build everything is to open
a terminal, navigate to your project directory and type:</p>
<pre class="code console literal-block">
<span class="go">gulp</span>
</pre>
<div class="section" id="local-development">
<h4>Local Development</h4>
<p>Doing local development is slightly more tricky, but not so bad to set up.
What we'd like is to be able to run a command, and then have it watch for
changes and automatically rebuild the parts that have changed.  Let's add a
<tt class="docutils literal">watch</tt> task which does this:</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">nodemon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-nodemon'</span><span class="p">);</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'watch'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'clean'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">watching</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">gulp</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="s1">'browserify'</span><span class="p">,</span> <span class="s1">'styles'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Protect against this function being called twice. (Bug?)
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">watching</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">watching</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="c1">// Watch for changes in frontend js and run the 'javascript' task
</span>      <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">'frontend/**/*.js'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'javascript'</span><span class="p">]);</span>

      <span class="c1">// Run the 'browserify_nodep' task when client.js changes
</span>      <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">'build/javascript/client.js'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'browserify_nodep'</span><span class="p">]);</span>

      <span class="c1">// Watch for .less file changes and re-run the 'styles' task
</span>      <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">'frontend/**/*.less'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'styles'</span><span class="p">]);</span>

      <span class="c1">// Start up the server and have it reload when anything in the
</span>      <span class="c1">// ./build/ directory changes
</span>      <span class="nx">nodemon</span><span class="p">(</span><span class="p">{</span><span class="nx">script</span><span class="o">:</span> <span class="s1">'server.js'</span><span class="p">,</span> <span class="nx">watch</span><span class="o">:</span> <span class="s1">'build'</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre>
<p>Most of this is fairly self-explanatory except two things:</p>
<ul class="simple">
<li>What is 'browserify_nodep'?</li>
<li>We haven't built <tt class="docutils literal">server.js</tt> yet.</li>
</ul>
<p>The latter we'll tackle in the next post, but the reason for 'browserify_nodep'
is that we don't need/want all the javascript to be rebuilt every time just
client.js changes.  We have something already watching for that.  So let's
modify our <tt class="docutils literal">browserify</tt> task and split it into <tt class="docutils literal">browserify</tt> and
<tt class="docutils literal">browserify_nodep</tt>:</p>
<pre class="code js literal-block">
<span class="kd">function</span> <span class="nx">browserifyTask</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="s1">'build/javascript/client.js'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">browserify</span><span class="p">(</span><span class="p">{</span>
      <span class="nx">transform</span><span class="o">:</span> <span class="p">[</span><span class="s1">'envify'</span><span class="p">]</span>
    <span class="p">}))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="s1">'compiled.js'</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'build/javascript/'</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">uglify</span><span class="p">(</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">rename</span><span class="p">(</span><span class="p">{</span><span class="nx">suffix</span><span class="o">:</span> <span class="s1">'.min'</span><span class="p">}))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s1">'build/javascript/'</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'browserify'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'javascript'</span><span class="p">],</span> <span class="nx">browserifyTask</span><span class="p">);</span>
<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'browserify_nodep'</span><span class="p">,</span> <span class="nx">browserifyTask</span><span class="p">);</span>
</pre>
<p>This is why it's awesome that Gulpfiles are just javascript files: we can break
out common functionality into a function, and apply it to different tasks.  If
you ever want to see the fully finished gulpfile.js for the final project, you
can <a class="reference external" href="https://github.com/ericflo/irlmoji/blob/master/gulpfile.js">check it out here</a>.</p>
</div>
<div class="section" id="what-s-next">
<h4>What's Next?</h4>
<ul class="simple">
<li>Write the <tt class="docutils literal">server.js</tt> that mimics the <tt class="docutils literal">client.js</tt> we've been building and
acts as http server.</li>
<li>Build the communications layer between the frontend and the API</li>
<li>Ensure that the client re-uses the same data the server used when it rendered</li>
<li>Oh yeah, write our app :)</li>
</ul>
</div>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/react/">React</a></li>
      
        <li><a href="/blog/categories/reactjs/">ReactJS</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/server/">Server</a></li>
      
        <li><a href="/blog/categories/client/">Client</a></li>
      
        <li><a href="/blog/categories/javascript/">Javascript</a></li>
      
    </ul>
  </div>
  <hr />

  <h3><a href="/blog/2014/04/09/react-part-1-getting-started/">Server/Client With React, Part 1: Getting Started</a></h3>
<p class="datetime">Apr 09, 2014</p>
<div class="document">
<p>A few months ago <a class="reference external" href="http://eflorenzano.com/blog/2014/01/23/react-finally-server-client">I wrote about</a> how React.js has made it possible (and
relatively easy) to write code that renders markup quickly on the server, and
also can be executed on the client to perform all page updates.  Now that we
know what the goal is, we can explore how to put all these pieces together, or
how I've managed to do it anyway.</p>
<div class="section" id="let-s-build-something">
<h4>Let's Build Something!</h4>
<p>It's easiest to talk about concepts if we can also work on something concrete,
so in the next few posts we'll build a little example site called IRLMoji,
which asks users to post pictures that look like emoji.  All credit goes to
<a class="reference external" href="https://twitter.com/dwiskus">&#64;dwiskus</a> for originally starting this <a class="reference external" href="http://betterelevation.com/irlmoji/">meme on Twitter</a>.  But we're going
to turn it into its own app for demo purposes, which will look something like
this:</p>
<a class="reference external image-reference" href="https://www.irlmoji.com/"><img alt="A screenshot of what we are building" src="http://eflorenzano.com.s3-us-west-2.amazonaws.com/irlmoji-screenshot.jpg" style="width: 200px;" /></a>
<p>It's definitely not pretty (sorry), but it's got all the stuff we need to learn
about React including auth, content creation, server communication, integration
with third-party JS libraries, etc.  If you'd like to follow along and see the
code for the finished site, it's all up on GitHub:
<a class="reference external" href="https://github.com/ericflo/irlmoji">https://github.com/ericflo/irlmoji</a>.</p>
</div>
<div class="section" id="let-s-begin">
<h4>Let's Begin</h4>
<p>There will be two entry points to our app: <tt class="docutils literal">server.js</tt>, which will sit at the
project's top level, and <tt class="docutils literal">frontend/javascript/client.js</tt>.  Let's start with
the client, because it's a bit simpler.  First let's start small and build a
<tt class="docutils literal">render()</tt> function, which will take a React component and some options, and
render it to the page:</p>
<pre class="code js literal-block">
<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">reactComp</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{</span><span class="p">};</span>
  <span class="kd">var</span> <span class="nx">elt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'react-root'</span><span class="p">);</span>
  <span class="nx">React</span><span class="p">.</span><span class="nx">renderComponent</span><span class="p">(</span><span class="nx">reactComp</span><span class="p">,</span> <span class="nx">elt</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>All we're doing here is calling <tt class="docutils literal">React.renderComponent</tt> on the component that
was passed in, rendering the component into that <cite>#react-root</cite> DOM element.
We'll end up making this function do a bit more work in a future post, but for
now let's move on to writing some handlers, and hooking them up to URL routes.</p>
<p>In the past I've used <a class="reference external" href="https://github.com/flatiron/director">director</a> to handle URL routing, but eventually I wrote
<a class="reference external" href="https://github.com/ericflo/irlmoji/blob/master/frontend/javascript/router.js">a small router</a> which escews <a class="reference external" href="http://www.webmonkey.com/2011/02/gawker-learns-the-hard-way-why-hash-bang-urls-are-evil/">hashbang-style</a> URLs in favor of HTML5
pushState.  If needed, we can always fall back to full page reloads, rather
than resort to hashbangs.  Now we've got this router to work with, let's put it
to use, starting with a new file at <tt class="docutils literal">frontend/javascript/routes.js</tt>:</p>
<pre class="code as literal-block">
<span class="cm">/** &#64;jsx React.DOM */</span>

<span class="c1">// Lodash is a fast/light underscore replacement that works better for me
</span><span class="k">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'lodash/dist/lodash.underscore'</span><span class="p">);</span>
<span class="k">var</span> <span class="nx">common</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./components/common'</span><span class="p">);</span>

<span class="c1">// Renders the index page, for now just &quot;Hello, World!&quot;
</span><span class="kd">function</span> <span class="nx">handleIndex</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="o">,</span> <span class="nx">World</span><span class="o">!&lt;/</span><span class="nx">p</span><span class="o">&gt;,</span> <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">'Welcome'</span><span class="o">,</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Prepares a handler for use. For now all we're doing is making sure
// that 'app' is passed as the first argument to the handler function.
</span><span class="kd">function</span> <span class="nx">prepareHandler</span><span class="p">(</span><span class="nx">app</span><span class="o">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">partial</span><span class="p">(</span><span class="nx">handler</span><span class="o">,</span> <span class="nx">app</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Gets a list of routes to be passed to the router
</span><span class="kd">function</span> <span class="nx">getRoutes</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'/'</span><span class="o">,</span> <span class="nx">prepareHandler</span><span class="p">(</span><span class="nx">app</span><span class="o">,</span> <span class="nx">handleIndex</span><span class="p">)]</span>
  <span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Gets a function that should be called when no routes match
</span><span class="kd">function</span> <span class="nx">getNotFound</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// At the time this post was written, JSX does not allow namespacing,
</span>    <span class="c1">// so we need to grab a reference to the NotFound component class.
</span>    <span class="k">var</span> <span class="nx">NotFound</span> <span class="o">=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">NotFound</span><span class="o">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">NotFound</span> <span class="o">/&gt;,</span> <span class="p">{</span><span class="nx">statusCode</span><span class="o">:</span> <span class="mi">404</span><span class="p">});</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">getRoutes</span><span class="o">:</span> <span class="nx">getRoutes</span><span class="o">,</span>
  <span class="nx">getNotFound</span><span class="o">:</span> <span class="nx">getNotFound</span>
<span class="p">};</span>
</pre>
<p>&quot;Wait a minute,&quot; you may be thinking.  What is this <tt class="docutils literal">app</tt> thing that every
function seems to refer to?  The <tt class="docutils literal">app</tt> is what I've chosen to call the object
that is used to tie everything together.  It's because of this object that
we're able to use one codebase for both server and client.  Right now all we're
using is the <tt class="docutils literal">render</tt> function that we created earlier, but through the
interface of this <tt class="docutils literal">app</tt> object.  Let's go back to <tt class="docutils literal">client.js</tt> and create
a basic app object.</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">render</span><span class="o">:</span> <span class="nx">render</span><span class="p">,</span>
  <span class="nx">isServer</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">getUrl</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">''</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">getPath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre>
<p>Here we've got a basic <tt class="docutils literal">app</tt> object, with access to a render function and a
few helpers like the ability to get the current path or get the full URL or to
detect whether we're on the server or the client.  We're building this in
<tt class="docutils literal">client.js</tt>, so we know we're not on the server, and can just return false.</p>
<p>Now that we have our app, and our routes, let's tie them together:</p>
<pre class="code js literal-block">
<span class="c1">// Import the routes we created earlier
</span><span class="kd">var</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./routes'</span><span class="p">);</span>
<span class="c1">// ...and the simple router we're using
</span><span class="kd">var</span> <span class="nx">makeRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./router'</span><span class="p">).</span><span class="nx">makeRouter</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="nx">makeRouter</span><span class="p">(</span><span class="nx">routes</span><span class="p">.</span><span class="nx">getRoutes</span><span class="p">(</span><span class="nx">app</span><span class="p">),</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">getNotFound</span><span class="p">(</span><span class="nx">app</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="p">);</span>
</pre>
<p>To finish up this part, we still have to create that NotFound React component,
so let's create a new file in <tt class="docutils literal">frontend/javascript/components/common.js</tt> with
this as its content:</p>
<pre class="code as literal-block">
<span class="cm">/** &#64;jsx React.DOM */</span>

<span class="k">var</span> <span class="nx">React</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'react/addons'</span><span class="p">);</span>

<span class="k">var</span> <span class="nx">NotFound</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">That</span> <span class="nx">page</span> <span class="nx">could</span> <span class="nx">not</span> <span class="nx">be</span> <span class="nx">found</span><span class="p">.</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span><span class="nx">NotFound</span><span class="o">:</span> <span class="nx">NotFound</span><span class="p">};</span>
</pre>
</div>
<div class="section" id="what-s-next">
<h4>What's Next?</h4>
<p>It would be great if we could fire up our browsers now and see in action what
we've built so far.  Unfortunately, however, we haven't built the server yet.
Here are some of the high level things that we're going to cover next:</p>
<ul class="simple">
<li>Set up <a class="reference external" href="http://gulpjs.com/">Gulp</a> and <a class="reference external" href="http://browserify.org/">Browserify</a> to compile our node JavaScript into Browser JS</li>
<li>Write the <tt class="docutils literal">server.js</tt> that mimics the <tt class="docutils literal">client.js</tt> we've been building and
acts as http server.</li>
<li>Build the communications layer between the frontend and the API</li>
<li>Ensure that the client re-uses the same data the server used when it rendered</li>
<li>Oh yeah, write our app :)</li>
</ul>
</div>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/react/">React</a></li>
      
        <li><a href="/blog/categories/reactjs/">ReactJS</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/server/">Server</a></li>
      
        <li><a href="/blog/categories/client/">Client</a></li>
      
        <li><a href="/blog/categories/javascript/">Javascript</a></li>
      
    </ul>
  </div>
  <hr />

  <h3><a href="/blog/2014/01/23/react-finally-server-client/">React: Finally, a great server/client web stack</a></h3>
<p class="datetime">Jan 23, 2014</p>
<div class="document">
<p>We started with static websites, simple pages that could link between each
other.  Then we started constructing those pages on demand, customizing the
contents of the page for each individual user.  Next we started using
Javascript to add more interactivity, and these pages started to become more
like applications.  But now we have XMLHttpRequest, and most new projects are
moving towards building their pages entirely in the browser.</p>
<p>But when we do it purely in the browser, we have to make quite a few
concessions: search engines have a hard time indexing that content, for
example. It also takes longer for users to see the rendered content (not in
every case, but in many, many cases.)  Also if you're using a lot of plugins
for your favorite library, or a heavyweight MVC framework, sometimes it can
slow down interactivity.</p>
<p>I've thought for a long time (<a class="reference external" href="http://eflorenzano.com/blog/2010/09/27/why-node-disappoints-me/">and blogged about it previously</a>) that the
ideal solution would fully render the markup on the server, deliver it to the
client so that it can be shown to the user instantly.  Then it would
asynchronously load some Javascript that would attach to the rendered markup,
and invisibly promote the page into a full app that can render its own markup.
This code would also have to be fast enough to meet or exceed the performance
of other modern solutions, or it won't be worth it.</p>
<p>What I've discovered is that enough of the pieces have come together, that this
futuristic-sounding web environment is actually surprisingly easy to do now
with <a class="reference external" href="http://facebook.github.io/react/">React.js</a>.  React isn't a full-fledged framework, it's a library, so
you'll have to build your own foundation and write some glue code.  I've been
rewriting an existing website in React (usually a terrible idea, we'll see
about this time), and now that the code is settling down a little bit, I'd like
to share how it works.  This post will just be an overview, but up next I'll
share some of my glue code and lessons learned etc.</p>
<div class="section" id="react-js">
<h4><a class="reference external" href="http://facebook.github.io/react/">React.js</a></h4>
<p>First, a bit about React.  It was released by Facebook and was apparently a
collaboration between the Instagram and Facebook web engineers.  It looks
similar in shape but not in size to Angular.js, but even though it looks
similar, it has a very different philosophy underneath.  React has a few key
ideas: a virtual DOM, a component framework, and a Javascript syntax extension.</p>
<div class="section" id="virtual-dom">
<h2>Virtual DOM</h2>
<p>The key innovation of React is that it has a pure-Javascript reimplementation
of the browser's DOM.  It builds the DOM tree in Javascript and then has two
options for output: a root browser element, or a string.  How can it output
to a root browser element without having horrible performance?  Core to React
is a tree diffing algorithm that can look at the in-memory virtual DOM, and the
real browser DOM, and build the optimal diff.  Then it applies that diff to the
browser's DOM.</p>
<p>The second option for output is equally interesting to me though.  If you can
walk this virtual DOM tree and render to a string, then you can do that all
on the server and then send it down to the client.  And since it's a tree,
React simply stores a checksum in a data attribute on the root node, and if
those checksums match, then React will simply attach its event handlers and do
nothing more.</p>
</div>
<div class="section" id="component-framework">
<h2>Component Framework</h2>
<p>React's component framework is how you construct that virtual DOM.  Each
component has a <tt class="docutils literal">render()</tt> function which returns a virtual DOM node with any
number of children and event handlers attached.  So at its core, React
components are widgets that can render themselves and react to user input.  At
render time, components should only access two instance objects: <tt class="docutils literal">props</tt>, and
<tt class="docutils literal">state</tt>.</p>
<p>Props are passed-in and are immutable, whereas state is assigned and updated
entirely by the component itself.  Callback functions can be passed from parent
node to child node, as <tt class="docutils literal">props</tt>, and attached directly to the virtual DOM
nodes in the <tt class="docutils literal">render()</tt> function.  In fact, that's the primary way that
components communicate with each other.</p>
<p>These components have a lifecycle, and ways to hook into state and prop
changes.  They also support mixins, which can hook into the component lifecycle
and take care of things easily, like canceling timers when a component is
removed from the DOM, for example.</p>
</div>
<div class="section" id="jsx-a-javascript-syntax-extension">
<h2>JSX (A Javascript syntax extension)</h2>
<p>JSX lets you write components without pulling your hair out.  Instead of
writing tedious code like this:</p>
<pre class="code js literal-block">
<span class="nx">React</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="p">{</span><span class="nx">href</span><span class="o">:</span> <span class="s1">'/about'</span><span class="p">},</span> <span class="s1">'About this site'</span><span class="p">)</span>
</pre>
<p>It allows you to just write this right alongside your javascript:</p>
<pre class="code html literal-block">
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/about&quot;</span><span class="nt">&gt;</span>About this site<span class="nt">&lt;/a&gt;</span>
</pre>
<p>The transformer is smart enough to not need any special indicators about where
the markup blocks are, but it also allows you to drop into Javascript, like
so:</p>
<pre class="code html literal-block">
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">{this.props.aboutUrl}</span><span class="nt">&gt;</span>About this site<span class="nt">&lt;/a&gt;</span>
</pre>
<p>You can choose not to use this, but after getting over my initial distaste for
it (&quot;Ack! Who got markup in my code!&quot;), I could never go back to not using it.</p>
</div>
<div class="section" id="next">
<h2>Next</h2>
<p>In a future post, I'll talk about all the other parts you'll need to pull in to
build a fuller framework for your site.</p>
<ul class="simple">
<li>HTTP middleware and server (<a class="reference external" href="http://www.senchalabs.org/connect/">Connect</a>)</li>
<li>API client (<a class="reference external" href="http://visionmedia.github.io/superagent/">Superagent</a> and optionally <a class="reference external" href="https://github.com/nodejitsu/node-http-proxy">node-http-proxy</a>)</li>
<li>URL routing (<a class="reference external" href="https://github.com/flatiron/director">Director</a>)</li>
<li>Asset management</li>
<li>Interfacing with legacy Javascript</li>
<li>Useful mixins for components</li>
</ul>
<p>Also, I'm not sure if this is interesting for anyone else other than myself, so
let me know if I should post that stuff, or any other feedback.  I'm always
yapping on Twitter, so <a class="reference external" href="https://twitter.com/ericflo">catch me over there</a>!</p>
</div>
</div>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/react/">React</a></li>
      
        <li><a href="/blog/categories/reactjs/">ReactJS</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/server/">Server</a></li>
      
        <li><a href="/blog/categories/client/">Client</a></li>
      
        <li><a href="/blog/categories/javascript/">Javascript</a></li>
      
    </ul>
  </div>
  <hr />

<h3 class="archive-link"><a href="/blog/archives/">Blog Archives</a></h3>

      </div>
    </div>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1959803-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
  </body>
</html>