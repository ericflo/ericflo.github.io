
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Eric Florenzano's Blog</title>
  <meta name="author" content="Eric Florenzano">

  
  <meta name="description" content="A few months back, I had a bit of an epiphany. I suspect I was about 5 years
too late with this epiphany, but nevertheless here it is: Microsoft,
Sun &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ericflo.github.com/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Eric Florenzano's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1959803-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Eric Florenzano's Blog</a></h1>
  
    <h2>I am me.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ericflo.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/22/most-widely-available-virtual-machine/">The Most Widely Available Virtual Machine</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-22T21:37:57-08:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few months back, I had a bit of an epiphany.  I suspect I was about 5 years
too late with this epiphany, but nevertheless here it is: Microsoft,
Sun, and Adobe all have these virtual machines that they want everyone to
develop on top of.  For Microsoft it&#8217;s the <a class="reference external" href="http://en.wikipedia.org/wiki/Common_Language_Runtime">CLR</a>, for Sun it&#8217;s the <a class="reference external" href="http://en.wikipedia.org/wiki/Java_virtual_machine">JVM</a>, and for
Adobe it&#8217;s <a class="reference external" href="http://www.adobe.com/devnet/actionscript/">AVM</a>.  The problem that each of them have is that not everyone goes
out of their way to install all of these VMs, so each vendor only has a subset
of the entire computing space.</p>
<p>My epiphany was that there is one VM which nearly every modern computer has
access to.  It&#8217;s JavaScript.  Every browser developed in the past 10 years
ships with some variation of it, and some systems even come with it as a
command-line option.  Whilst they do have a big problem in terms of
standardization (or lack thereof), there is certainly a lowest common
denominator that could be useful for writing apps on top of.</p>
<p>That being the case, why don&#8217;t we see more language implementations on top of
JavaScript?  There is <a class="reference external" href="http://ejohn.org/blog/processingjs/">Processing.js</a>, a port of the <a class="reference external" href="http://processing.org/">Processing</a> programming
language.  There is also <a class="reference external" href="http://cappuccino.org/">Objective J and Cappuccino</a>, a port of Objective C
and Cocoa, respectively.  Each of those language implementations have received
quite a bit of attention (both positive and negative, mind you).</p>
<p>So why don&#8217;t we see Ruby, Python, or other languages implemented on top of
JavaScript?  For that matter, why don&#8217;t we see more ports of apps to JavaScript?
I know that in the Python world, PyPy has a JavaScript backend, but to the best
of my knowledge that backend has been all-but-abandoned.  I think it would be
really cool if we were to see more applications and programming languages
targeting the most widely adopted virtual machine ever: JavaScript.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/21/are-pure-client-side-web-apps-wave-future/">Are Pure Client-side Web Apps the Wave of the Future?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-21T19:11:49-08:00" pubdate data-updated="true">Nov 21<span>st</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It seems that the world of computing is always oscillating between offloading
more work to the server, and offloading more work to the client.  In the very
early days of dumb terminals, we had most of the actual computation being done
on big mainframes.  Then personal computers became more powerful, allowing for
much richer applications to be created.</p>
<p>With the advent of the internet, the landscape of computing architectures
shifted again to being done focused on the server.  Now, however, JavaScript has
become more powerful.  Combined with things like SVG and the canvas tag, we can
create extremely rich applications that take place solely in the browser.</p>
<p>Projects like <a class="reference external" href="http://incubator.apache.org/couchdb/">CouchDB</a> are even starting to open the door for
<a class="reference external" href="http://jchris.mfdz.com/code/2008/11/my_couch_or_yours__shareable_ap">truly peer-to-peer web applications</a>.  With all of this taking place, it seems
that client-side web applications are poised to see some fairly strong growth.
This is especially evident now that companies as big as Google seem interested
in the idea, with its <a class="reference external" href="http://gears.google.com/">Google Gears</a> product that allows you to &quot;work offline&quot;.
But there are certain things that need to be satisfied first.</p>
<p>We need a way of enforcing security across these apps.  It looks like some
combination of OpenID and OAuth are going to be the winners in this space, but
I&#8217;ve never seen a seamless implementation of either of these protocols, even by
the companies most invested in the technology.  There is a lot of work to go on
usability before authentication and authorization are ubiquitous through these
open protocols.</p>
<p>We also need to standardize more on the data interchange formats that we use to
shuttle information back and forth between these different apps.  <a class="reference external" href="http://en.wikipedia.org/wiki/Atom_(standard)">Atom</a> goes a
long way towards describing the data that we use, but its adoption is nowhere
near ubiquitous, and some sites still rely on older, more outdated, RSS
syndication formats that aren&#8217;t quite up to the task.</p>
<p>But even if we standardize on some application platform (be it Google Gears or
CouchDB or some other container), security, and data interchange formats, there
are certain things that need to be considered.  For one, there are some
applications that just aren&#8217;t practical to be implemented on the client.  Video
editing comes to mind (and I would know, considering I interned for <a class="reference external" href="http://eyespot.com/">eyespot</a>, a
company which was attempting to do just that).</p>
<p>Another concern is that, as we&#8217;ve seen with the emergence of standards for CSS
and HTML, a certain amount of rigidness is good, but a strict conformist
attitude leads to significantly stifled innovation.  If you were to write an app
that doesn&#8217;t fall within the boundaries of what&#8217;s possible given the agreed-upon
standards, would you still be able to go forward with the development of the
app, or would you run into resistance from those who have a stake in those
standards?</p>
<p>In all, I have a feeling that we are going to move more and more to a hybrid
approach, with much more logic being computed on the side of the client
(especially in terms of visual components and interactivity), and that much more
of the server side is going to be involved in slicing and serving up just the
raw data.  We can see this happening today with technologies like AJAX being
touted as the centerpiece of some &quot;Web Two Point Oh&quot; sites.  I&#8217;m excited to see
where this will all go, and more than excited that, being a developer during
this time, get to help shape that direction.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/20/blog-updated-now-more-couchdb/">Blog Updated (Now With More CouchDB)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-20T21:56:20-08:00" pubdate data-updated="true">Nov 20<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I posted a while back about <a class="reference external" href="http://www.eflorenzano.com/blog/post/using-couchdb-django/">using CouchDB with Django</a>, talking about how one might build a lifestreaming application combining the flexibility and power of <a class="reference external" href="http://incubator.apache.org/couchdb/">CouchDB</a> with the ease of use and utility of <a class="reference external" href="http://www.djangoproject.com/">Django</a>.  I even linked to <a class="reference external" href="http://github.com/ericflo/django-couch-lifestream/tree/master">the project on github</a>.  At the time I was taking a hard look at the Django-based software that was running this blog.  It needed some work, to say the least.  So I did a bit of cleanup, a LOT of reorganization, and integrated this CouchDB-based lifestreaming application into the mix.</p>
<p>There&#8217;s no visual refresh&#8211;that will come some other time.  For right now, it&#8217;s just a backend refresh, so for the most part nobody will notice anything.  But I can rest much easier knowing that the backend is just a little bit less of a mess.  It&#8217;s also a LOT easier to deploy.  I&#8217;ve integrated a <a class="reference external" href="http://www.nongnu.org/fab/">Fabric</a> deployment script so that all I need to do is type:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">fab deploy
</span></code></pre></td></tr></table></div></figure><p>And everything gets zipped up, sent to the server, unziped, and all of the relevant processes get restarted.  Pretty cool!  That&#8217;s going to allow for much more rapid iteration on the site, so changes can come more often and bugs can be fixed.</p>
<p>Because of that, expect more experimentation.  As I&#8217;m experimenting with Django stuff, I&#8217;ll do a lot more public demos where the experimentations are public for the world to see and play around with.  I&#8217;ve got lots of ideas for Django-y experiments and it&#8217;s going to be really fun to see how they shape up.</p>
<p>So what do you think?  Is the new lifestreaming stuff annoying or cool?</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/19/lambda-calculus/">Lambda Calculus</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-19T21:00:09-08:00" pubdate data-updated="true">Nov 19<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It seems that people either love things like <a class="reference external" href="http://en.wikipedia.org/wiki/Lambda_calculus">lambda calculus</a> and eat it up,
or their eyes gloss over and they don&#8217;t care or want to learn about it.  I was
firmly part of the latter group, until I took a class in college that forced
me to learn about it.  The thing is, once you learn more about a subject like
this, the less you&#8217;ll understand why you were so averse to learning about it.</p>
<p>In the spirit of broadening our horizons, let&#8217;s explore the lambda calculus and
see if it&#8217;s as hard as it&#8217;s cracked up to be.  I don&#8217;t claim to be a wizard at
this stuff, and by no means am I a theoretical computer scientist, but that&#8217;s
not the goal.  The goal is to cut down on the formality and see if we can expore
this stuff a bit.  First, let&#8217;s look at a very basic function: addition.  In
lambda calculus it looks like this:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&gt;&gt; x. x + 1
</span></code></pre></td></tr></table></div></figure><p>That is, a function whose argument is named <tt class="docutils literal">x</tt>, returns the value <tt class="docutils literal">x + 1</tt>.
This looks really similar to some syntax that we have in Python.  Let&#8217;s see
if we can find a corollary to help make things easier:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure><p>Surprisingly, the syntax is almost the same!  It&#8217;s an anonymous function which
takes <tt class="docutils literal">x</tt> as its one argument and returns <tt class="docutils literal">x + 1</tt>.  Lambda calculus doesn&#8217;t
have powerful enough syntax for talking about functions with multiple arguments,
though, so you may think that it&#8217;s not very powerful.  Thanks to a technique
called <a class="reference external" href="http://en.wikipedia.org/wiki/Currying">currying</a>, however, we can express functions with infinite numbers of
arguments.  This is how that might look:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">&gt;&gt; x. &gt;&gt; y. x + y
</span></code></pre></td></tr></table></div></figure><p>This is where I think the syntax starts to get in the way of readability.  Let&#8217;s
see what this would look like in Python:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span></code></pre></td></tr></table></div></figure><p>Hmmm&#8230;it&#8217;s not much more readable, but at least we can open up an interactive
interpreter to see what we&#8217;re doing.  Basically what we&#8217;re doing is creating a
function which returns another function.  That inner function then has access
not only to its single argument, but to its parent&#8217;s argument as well.  Let&#8217;s
demonstrate that this works:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="pycon"><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">)(</span><span class="mi">4</span><span class="p">)</span>
</span><span class="line"><span class="go">9</span>
</span></code></pre></td></tr></table></div></figure><p>Now does this work if we start to change the variable names?  What if I just
decide that I can&#8217;t stand the letter <tt class="docutils literal">x</tt> and don&#8217;t want it inside any more of
my functions.  Well I can simply change the variable name, as long as I change
any uses of that variable.  It would work just the same:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="pycon"><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">z</span> <span class="o">+</span> <span class="n">y</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">)(</span><span class="mi">4</span><span class="p">)</span>
</span><span class="line"><span class="go">9</span>
</span></code></pre></td></tr></table></div></figure><p>In this instance, we have changed all of our instances of <tt class="docutils literal">x</tt> with <tt class="docutils literal">z</tt>.
This ability to change the names of bound variables is the first rule of lambda
calculus, and it&#8217;s called ?-conversion.</p>
<p>As developers, we intuitively understand the idea of function application.  We
understand that a function which takes in an argument replaces all references
to that argument with the given value, and returns a result.  For example, in
the addition function, lets go through the steps for function application:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="pycon"><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">add5</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class="line"><span class="go"># We can envision what&#39;s happening here by replacing x with 5</span>
</span><span class="line"><span class="go"># add5 = lambda 5: lambda y: 5 + y</span>
</span><span class="line"><span class="go"># add5 = lambda y: 5 + y</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">add5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class="line"><span class="go"># And now the final function application, resulting in a value</span>
</span><span class="line"><span class="go"># lambda 4: 5 + 4</span>
</span><span class="line"><span class="go">9</span>
</span></code></pre></td></tr></table></div></figure><p>This idea of function application, in lambda calculus is given the name
2-reduction.  To review, in lambda calculus syntax that process would look like
so:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">(&gt;&gt; x. &gt;&gt; y. x + y) 5
</span><span class="line">(&gt;&gt; y. 5 + y) 4
</span><span class="line">5 + 4
</span><span class="line">9
</span></code></pre></td></tr></table></div></figure><p>Something that we also intuitively know as developers is that functions can do
the exact thing, but have very different implementations.  For example this
function:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;</span> <span class="n">x</span><span class="o">.</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span>
</span></code></pre></td></tr></table></div></figure><p>&#8230;will give the same results for all values as this function:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;</span> <span class="n">x</span><span class="o">.</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure><p>We understand that code which uses the former function can easily swap out the
latter and expect the program the function correctly.  This idea is called
.-conversion in lambda calculus.</p>
<p>See, this is pretty simple stuff!  Obviously there are subtleties that I didn&#8217;t
go into, and it gets a bit more confusing when we start to try to figure out
formally which variables occur bound and which occur free, and as we attempt to
preserve that status while doing ?-conversion, 2-reduction, and .-conversion.</p>
<p>Here&#8217;s some really mind bending food for thought:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">(&gt;&gt; x. x x) (&gt;&gt; x. x x)
</span></code></pre></td></tr></table></div></figure><p>Think about how this would reduce:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">(&gt;&gt; x. x x) (&gt;&gt; x. x x)
</span><span class="line">(&gt;&gt; (&gt;&gt; x. x x). (&gt;&gt; x. x x) (&gt;&gt; x. x x))
</span><span class="line">(&gt;&gt; x. x x) (&gt;&gt; x. x x)
</span></code></pre></td></tr></table></div></figure><p>As you can see, we could do this forever.  This is called the ? combinator,
and it lets us do some really cool things with recursion. Maybe more on that in
a later blog post.</p>
<p>What is all of this good for?  Well, with only this very simple, rigidly
defined ruleset, we can express every possible computer program.  That makes it
very good for doing mathematical proofs and other various scholarly things
when we want to explore algorithms.  It also forms the basis of all programming
languages, and especially functional programming languages.</p>
<p>Of particular interest to me is that we can actually represent numbers, truth,
and logic using only these very basic primitives.  I&#8217;ll explore that in another
post.  To me, all of this is fascinating, and it&#8217;s hard to believe that before
my teacher forced me to learn it, I actively didn&#8217;t want to know about it.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/18/why-you-should-blog/">Why You Should Blog</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-18T21:17:48-08:00" pubdate data-updated="true">Nov 18<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Whenever I tell people that I&#8217;m participating in this blog post per day event,
most people begin laughing hysterically.  Then the next thing that people
typically do, unprompted, is to start making excuses as to why they don&#8217;t blog.
Most of the time it is something like, &quot;I don&#8217;t feel like I have anything
important to say,&quot; and sometimes it&#8217;s more like &quot;I tried it but nobody was
reading it, so I gave up.&quot;  These are valid reasons why someone shouldn&#8217;t blog.</p>
<p>But you shouldn&#8217;t make those excuses, and you should blog anyway.  Firstly,
writing is a valuable skill in any profession.  Simply forcing yourself to
write more helps to improve your writing abilities, and ensures that you&#8217;re
able to organize your thoughts in a way that others can understand.  Even if it
doesn&#8217;t make your writing any better, it will make you more aware of your
shortcomings as a writer.  Myself, for instance: I have found that a big
problem with my writing is that I start too many sentences with conjugations.
I also use way too much of the passive voice and alternate between subjective
personal pronouns.</p>
<p>Another reason why you should blog is because it forces you to look at things
from different perspectives.  I can&#8217;t count how many times I&#8217;ve begun writing
an opinion post, and give up after a while because after putting it into
writing, I realize how weak my actual argument is.  It makes me question some
of my opinions.  Conversely, if the argument comes across as strong and
obvious, then I am even more certain of my opinion.</p>
<p>Finally, blogging is a classic chicken-and-egg problem.  If you don&#8217;t blog,
nobody will read your blog.  If people don&#8217;t read your blog, you won&#8217;t want to
blog.  Fortunately if you just remain steadfast during the beginning portion
of your blogging life (and make sure to participate with other bloggers who
talk about similar things as you), then people will surely start to read your
posts.</p>
<p>Honestly now that I&#8217;m reading through this article, it seems a bit weak.  It&#8217;s
11:15PM and I can&#8217;t think of another subject to write about before midnight,
though, so this post will have to do!</p>
<p>I hope that you guy start/continue to blog, because it really is a good habit
to get into.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/17/wsgi-middlware-awesome-django-use-it-more/">WSGI Middleware Is Awesome, and Django Should Use It More</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-17T19:26:48-08:00" pubdate data-updated="true">Nov 17<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Most people in the Django community are deploying their apps these days with
<a class="reference external" href="http://code.google.com/p/modwsgi/">mod_wsgi</a>.  If not, then you&#8217;re at least using <a class="reference external" href="http://wsgi.org/wsgi/">WSGI</a> as a communication layer
with your application server, in one way or another.  The great thing about
WSGI is that it gives everyone a common interface through which to talk.  It
also has the added benefit of being a common abstraction that many people have
built these great, really useful tools on top of.</p>
<p>Consider <a class="reference external" href="http://repoze.org/">Repoze</a>.  If you navigate to the <a class="reference external" href="http://repoze.org/repoze_components.html#middleware">middleware section</a> of their
website, they have some really cool stuff available!  There are utilities for
logging, authentication, security, profiling, templating, etc.  All of these
pieces of middleware are designed to be totally pluggable, because they are
designed to work solely based on what&#8217;s available through WSGI.</p>
<p>My personal favorite of that lot is <tt class="docutils literal">repoze.profile</tt>.  It accumulates
Python profiling information about whatever app is being run, and allows you to
view that profile information via a web interface by visiting a special URL.
There is absolutely no reason that the Pylons, TurboGears, or CherryPy guys
should be able to get away with keeping this stuff for themselves, so I want to
show just how easy it is to integrate this profiling module with Django.</p>
<p>First, though, here&#8217;s a typical .wsgi file that might be used in conjunction
with <tt class="docutils literal">mod_wsgi</tt>:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
</span><span class="line"><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
</span><span class="line">
</span><span class="line"><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;settings&#39;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">django.core.handlers.wsgi</span>
</span><span class="line">
</span><span class="line"><span class="n">application</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIHandler</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure><p>There&#8217;s really nothing special going on here, and if you would like to learn
more about how to set up this WSGI file, visit
<a class="reference external" href="http://code.google.com/p/modwsgi/wiki/IntegrationWithDjango">mod_wsgi&#8217;s documentation on the subject</a>.  Now if you&#8217;ll notice,
<tt class="docutils literal">application</tt> is simply an instance of <tt class="docutils literal">WSGIHandler</tt>, which is simply a
callable.  A WSGI middleware is just a wrapper around that callable.  Here&#8217;s how
easy it is to add the profiling middleware:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">repoze.profile.profiler</span> <span class="kn">import</span> <span class="n">AccumulatingProfileMiddleware</span>
</span><span class="line"><span class="n">application</span> <span class="o">=</span> <span class="n">AccumulatingProfileMiddleware</span><span class="p">(</span>
</span><span class="line">    <span class="n">application</span><span class="p">,</span>
</span><span class="line">    <span class="n">log_filename</span><span class="o">=</span><span class="s">&#39;/tmp/djangoprofile.log&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">discard_first_request</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
</span><span class="line">    <span class="n">flush_at_shutdown</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
</span><span class="line">    <span class="n">path</span><span class="o">=</span><span class="s">&#39;/__profile__&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>There we go!  We have imported the profiling middleware, and passed the Django
WSGI application as the first argument.  The rest is just setting options for
the middleware.  You can restart apache and the WSGI profiling middleware is
already working.</p>
<p>Sometimes, though, you don&#8217;t want all of Apache just to run some middleware.
You want to be able to do the same thing, but locally.  Believe it or not,
Django&#8217;s local development server is just a WSGI server itself, so one option
would be to do the wrapping directly in django, <a class="reference external" href="http://code.djangoproject.com/browser/django/trunk/django/core/management/commands/runserver.py#L60">right here</a>.  But you really
don&#8217;t want to be hacking inside of Django internals if you don&#8217;t have to.
Fortunately there are many alternative WSGI servers out there.  Brian Rosner
has created a custom management command to use the excellent CherryPy WSGI
server with Django, on <a class="reference external" href="http://oebfare.com/blog/2008/nov/03/writing-custom-management-command/">his blog</a>.</p>
<p>Let&#8217;s say you just want to try this out quickly after reading this blog post,
though.  If you&#8217;re running Python 2.5 or greater, you&#8217;re in luck, because a
script less than 10 lines long can get you up and running:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c">#!/usr/bin/env python</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class="line">    <span class="nb">execfile</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class="line">    <span class="n">httpd</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
</span><span class="line">    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure><p>Now, to run it, simply invoke it like this:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">python runserver.py my_wsgi_file.wsgi
</span></code></pre></td></tr></table></div></figure><p>Now, navigate around your app for a little bit and then point your browser to
<a class="reference external" href="http://localhost:8000/__profile__">the profile url</a> and see how freaking awesome middleware can be.</p>
<p>I&#8217;m not trying to stir up any controversy, I&#8217;m not saying we should stop making
Django middleware or anything like that.  But I seriously, seriously hope that
someone tries this out and realizes the multitudes of great WSGI apps out there
that can be taken advantage of.  <a class="reference external" href="http://compoundthinking.com/blog/">Mark Ramm</a> wasn&#8217;t full of hot air when he
talked about this at DjangoCon or <a class="reference external" href="http://compoundthinking.com/blog/index.php/2008/10/06/wsgi-middleare-is-cool/">blogged about it</a> later.  He was right, and
I for one wish I had listened sooner.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/16/writing-markov-chain-irc-bot-twisted-and-python/">Writing an Markov-Chain IRC Bot With Twisted and Python</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-16T21:59:34-08:00" pubdate data-updated="true">Nov 16<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a class="reference external" href="http://twistedmatrix.com/trac/">Twisted</a> is one of Python&#8217;s great secret weapons.  It is an absolute workhorse,
allowing for insanely fast network applications to be written with very little
effort.  So let&#8217;s do what everyone does when they want to learn more about
Twisted: let&#8217;s write an IRC bot!  This bot is going to use <a class="reference external" href="http://en.wikipedia.org/wiki/Markov_chain">Markov Chains</a> to
simulate human speech.  For whatever reason, I named this bot &quot;YourMomDotCom&quot;.</p>
<p>First let&#8217;s create a skeleton on top of which the rest of the bot will be
created:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">twisted.words.protocols</span> <span class="kn">import</span> <span class="n">irc</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MomBot</span><span class="p">(</span><span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">_get_nickname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">nickname</span>
</span><span class="line">    <span class="n">nickname</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_nickname</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">signedOn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Signed on as </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nickname</span><span class="p">,)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">joined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Joined </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">channel</span><span class="p">,)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">privmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="n">msg</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MomBotFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>
</span><span class="line">    <span class="n">protocol</span> <span class="o">=</span> <span class="n">MomBot</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">nickname</span><span class="o">=</span><span class="s">&#39;YourMomDotCom&#39;</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">nickname</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">clientConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Lost connection (</span><span class="si">%s</span><span class="s">), reconnecting.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reason</span><span class="p">,)</span>
</span><span class="line">        <span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">clientConnectionFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Could not connect: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reason</span><span class="p">,)</span>
</span></code></pre></td></tr></table></div></figure><p>We&#8217;ve now created an <tt class="docutils literal">IRCClient</tt> subclass which will hold our application
logic, and we&#8217;ve also written a factory class which will create instances of
that <tt class="docutils literal">MomBot</tt> client.  Let&#8217;s tie these together and start the event loop:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class="line">    <span class="n">chan</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line">    <span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="s">&#39;irc.freenode.net&#39;</span><span class="p">,</span> <span class="mi">6667</span><span class="p">,</span> <span class="n">MomBotFactory</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="n">chan</span><span class="p">))</span>
</span><span class="line">    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure><p>Now already we have a complete working IRC bot.  Right now all it will do is
connect to an IRC channel and echo all of the output to the command line.  Not
bad for how little code we&#8217;ve written. Now all we have to do is implement our
application logic.  Let&#8217;s first start by creating the &#8216;brain&#8217; of our Markov
chain responder, and adding a function to train the brain:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span><span class="line">
</span><span class="line"><span class="n">markov</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span class="line"><span class="n">STOP_WORD</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">add_to_brain</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">chain_length</span><span class="p">,</span> <span class="n">write_to_file</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span class="line">    <span class="k">if</span> <span class="n">write_to_file</span><span class="p">:</span>
</span><span class="line">        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;training_text.txt&#39;</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">STOP_WORD</span><span class="p">]</span> <span class="o">*</span> <span class="n">chain_length</span>
</span><span class="line">    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
</span><span class="line">        <span class="n">markov</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">buf</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</span><span class="line">        <span class="k">del</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</span><span class="line">    <span class="n">markov</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">buf</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">STOP_WORD</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>In this, we are creating a defaultdict of lists.  For every n-word sliding
window, the word after that window is appended to the list of possible words.
Here&#8217;s an image which hopefully depicts better than words how the algorithm
populates the brain:</p>
<img alt="http://media.eflorenzano.com/img/markov.png" src="http://media.eflorenzano.com/img/markov.png" />
<p>But what good is a brain like this if we can&#8217;t get words back from it.  We&#8217;re
going to need to write a function to generate sentences from that brain:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">generate_sentence</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">chain_length</span><span class="p">,</span> <span class="n">max_words</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
</span><span class="line">    <span class="n">buf</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="n">chain_length</span><span class="p">]</span>
</span><span class="line">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">chain_length</span><span class="p">:</span>
</span><span class="line">        <span class="n">message</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:]</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">message</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">chain_length</span><span class="p">):</span>
</span><span class="line">            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">markov</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">markov</span><span class="o">.</span><span class="n">keys</span><span class="p">())]))</span>
</span><span class="line">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">max_words</span><span class="p">):</span>
</span><span class="line">        <span class="k">try</span><span class="p">:</span>
</span><span class="line">            <span class="n">next_word</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">markov</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">buf</span><span class="p">)])</span>
</span><span class="line">        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span class="line">            <span class="k">continue</span>
</span><span class="line">        <span class="k">if</span> <span class="n">next_word</span> <span class="o">==</span> <span class="n">STOP_WORD</span><span class="p">:</span>
</span><span class="line">            <span class="k">break</span>
</span><span class="line">        <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_word</span><span class="p">)</span>
</span><span class="line">        <span class="k">del</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_word</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>We start out our seed buffer with the first few words of the message, and if the
message wasn&#8217;t long enough, we fill the seed buffer with some random words from
the markov&#8217;s brain.  Then we use the buffer as a key into the markov brain and
randomly pick one of the values as our next word.  Then we slide that buffer
so that the chosen word is now the next word in the buffer (ejecting the oldest
word in the buffer).  If we ever see a stop word, we stop and return the
generated sentence.</p>
<p>Now it&#8217;s a matter of expanding our bot to take advantage of our markov brain.
The first change we will need to make is to modify the <tt class="docutils literal">MomBotFactory</tt> to take
more parameters in its <tt class="docutils literal">__init__</tt> method:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">MomBotFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>
</span><span class="line">    <span class="n">protocol</span> <span class="o">=</span> <span class="n">MomBot</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">nickname</span><span class="o">=</span><span class="s">&#39;YourMomDotCom&#39;</span><span class="p">,</span> <span class="n">chain_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span class="line">        <span class="n">chattiness</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_words</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">nickname</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">chain_length</span> <span class="o">=</span> <span class="n">chain_length</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">chattiness</span> <span class="o">=</span> <span class="n">chattiness</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">max_words</span> <span class="o">=</span> <span class="n">max_words</span>
</span><span class="line">
</span><span class="line">    <span class="c"># ...</span>
</span></code></pre></td></tr></table></div></figure><p>Now that it has all of that new information, we can add the final bit of
functionality to <tt class="docutils literal">MomBot</tt> responding using sentences generated from the
markov brain by updating the <tt class="docutils literal">privmsg</tt> method:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">MomBot</span><span class="p">(</span><span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="p">):</span>
</span><span class="line">
</span><span class="line">    <span class="c"># ...</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">privmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span class="line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
</span><span class="line">            <span class="k">return</span>
</span><span class="line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
</span><span class="line">            <span class="n">msg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">+</span> <span class="s">&quot;[:,]* ?&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span class="line">            <span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
</span><span class="line">        <span class="k">else</span><span class="p">:</span>
</span><span class="line">            <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line">        <span class="n">add_to_brain</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">chain_length</span><span class="p">,</span> <span class="n">write_to_file</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">chattiness</span><span class="p">:</span>
</span><span class="line">            <span class="n">sentence</span> <span class="o">=</span> <span class="n">generate_sentence</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">chain_length</span><span class="p">,</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">max_words</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="n">sentence</span><span class="p">:</span>
</span><span class="line">                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">sentence</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>If it gets a message from a non-user, we don&#8217;t care about it, so we just
disregard that message.  Otherwise, if it&#8217;s a message directed at the bot, we
want to respond to the sending user so we add the user as a prefix to our next
message.  Then we grab a sentence from the markov brain and send it to the
channel.</p>
<p>Not so bad.  Now lets modify our startup portion of the script to re-train the
brain with anything learned during the course of the bot&#8217;s life.  Here&#8217;s how
the new script will look:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">chan</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line">    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Please specify a channel name.&quot;</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;Example:&quot;</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&quot;  python yourmomdotcom.py django-hotclub&quot;</span>
</span><span class="line">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;training_text.txt&#39;</span><span class="p">):</span>
</span><span class="line">        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;training_text.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
</span><span class="line">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">            <span class="n">add_to_brain</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">chain_length</span><span class="p">)</span>
</span><span class="line">        <span class="k">print</span> <span class="s">&#39;Brain Reloaded&#39;</span>
</span><span class="line">        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="line">    <span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="s">&#39;irc.freenode.net&#39;</span><span class="p">,</span> <span class="mi">6667</span><span class="p">,</span> <span class="n">MomBotFactory</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="n">chan</span><span class="p">,</span>
</span><span class="line">        <span class="s">&#39;YourMomDotCom&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">chattiness</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
</span><span class="line">    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure><p>I have found personally that, counter-intuitively, a length of <strong>2</strong> seems to
produce the most realistic-looking responses.  We&#8217;ve really accomplished a lot
in a very little amount of code.  Instead of my normal closing remarks, let me
simply close with a snippet of conversation recently had with YourMomDotCom:</p>
<pre class="literal-block">
[9:57pm] ericflo: YourMomDotCom: Hello, I'd like to show you off for the readers of my blog.
[9:57pm] YourMomDotCom: ericflo: Hello, I'd like to do, after checking with another.
[9:57pm] ericflo: YourMomDotCom: I'm not exactly sure what you mean by that.
[9:57pm] YourMomDotCom: ericflo: I'm not sure, but I'm in &quot;Easter mode&quot; already I think.
[9:58pm] ericflo: YourMomDotCom: That's funny since we aren't really very close to easter.
[9:58pm] YourMomDotCom: ericflo: That's funny since i missed much of a ForeignKey field?
[9:58pm] ericflo: YourMomDotCom: I miss ForeignKey fields all the time
[9:58pm] YourMomDotCom: ericflo: I miss that
[9:58pm] ericflo: YourMomDotCom: We both agree, then.
[9:58pm] YourMomDotCom: ericflo: We both agree, then.
[9:58pm] ericflo: YourMomDotCom: yay!
</pre></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/15/exploring-erlangs-genserver/">Exploring Erlang&#8217;s Gen_server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-15T20:20:40-08:00" pubdate data-updated="true">Nov 15<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I found myself at <a class="reference external" href="http://superhappydevhouse.org/">Super Happy Dev House</a>, amongst a whole house full
of geeks (I say this in the most friendly way possible).  I thought for a while
about working on <a class="reference external" href="http://pinaxproject.com/">Pinax</a> project, which is what I really wanted to do.  However,
it didn&#8217;t seem geeky enough for the occasion.</p>
<p>No, today the call of the geek was too strong.  There was only one place to turn
to achieve maximal geekiness: functional programming.  Not only functional
programming, but I thought this occasion called for a concurrency-oriented
programming language. Yes, today was the perfect day for some Erlang.</p>
<p>I&#8217;ve done a few small projects with Erlang, but never before have I used <a class="reference external" href="http://www.erlang.org/doc/design_principles/part_frame.html">OTP</a>.
So the goal is to write an OTP <tt class="docutils literal">gen_server</tt> which would store a user&#8217;s
&quot;presence&quot; (think <a class="reference external" href="http://twitter.com/">Twitter</a>, <a class="reference external" href="http://pownce.com/">Pownce</a>, etc.) in memory.  No, it&#8217;s not a good idea.
Yes, it&#8217;s kind of fun.  So here we go!</p>
<p>First we need to decide on an API:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="nf">start_link</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">gen_server</span><span class="p">:</span><span class="n">start_link</span><span class="p">({</span><span class="n">local</span><span class="p">,</span> <span class="no">?SERVER</span><span class="p">},</span> <span class="no">?MODULE</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]).</span>
</span><span class="line">
</span><span class="line"><span class="nf">post_presence</span><span class="p">(</span><span class="nv">UserID</span><span class="p">,</span> <span class="nv">Presence</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">gen_server</span><span class="p">:</span><span class="n">cast</span><span class="p">(</span><span class="no">?SERVER</span><span class="p">,</span> <span class="p">{</span><span class="n">post_presence</span><span class="p">,</span> <span class="nv">UserID</span><span class="p">,</span> <span class="nv">Presence</span><span class="p">}).</span>
</span><span class="line">
</span><span class="line"><span class="nf">list_presence</span><span class="p">(</span><span class="nv">UserID</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?SERVER</span><span class="p">,</span> <span class="p">{</span><span class="n">list_presence</span><span class="p">,</span> <span class="nv">UserID</span><span class="p">}).</span>
</span><span class="line">
</span><span class="line"><span class="nf">list_presence</span><span class="p">(</span><span class="nv">UserID</span><span class="p">,</span> <span class="nv">Limit</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?SERVER</span><span class="p">,</span> <span class="p">{</span><span class="n">list_presence</span><span class="p">,</span> <span class="nv">UserID</span><span class="p">,</span> <span class="nv">Limit</span><span class="p">}).</span>
</span><span class="line">
</span><span class="line"><span class="nf">public_list</span><span class="p">(</span><span class="nv">Limit</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">gen_server</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="no">?SERVER</span><span class="p">,</span> <span class="p">{</span><span class="n">public_list</span><span class="p">,</span> <span class="nv">Limit</span><span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure><p><tt class="docutils literal">start_link</tt> will start the server.  <tt class="docutils literal">post_presence</tt> will post a user&#8217;s
current presence to the server.  <tt class="docutils literal">list_presence</tt> with one argument gets all
of the specified user&#8217;s presence information.  With a second argument, it limits
the amount of returned presence information to the specified number. Calling
<tt class="docutils literal">public_list</tt> means that you&#8217;re getting the latest posts from anyone.</p>
<p>Before that, though, let&#8217;s get some of the <tt class="docutils literal">gen_server</tt> cruft out of the way:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">presence_database</span><span class="p">).</span>
</span><span class="line"><span class="p">-</span><span class="ni">behavior</span><span class="p">(</span><span class="n">gen_server</span><span class="p">).</span>
</span><span class="line">
</span><span class="line"><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SERVER</span><span class="p">,</span> <span class="no">?MODULE</span><span class="p">).</span>
</span><span class="line">
</span><span class="line"><span class="c">%% gen_server API</span>
</span><span class="line"><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">handle_cast</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class="line">    <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</span><span class="line">
</span><span class="line"><span class="c">%% presence API</span>
</span><span class="line"><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start_link</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">post_presence</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">list_presence</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">list_presence</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class="line">    <span class="n">public_list</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>
</span><span class="line">
</span><span class="line"><span class="nf">handle_info</span><span class="p">(_</span><span class="nv">Info</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span><span class="line">
</span><span class="line"><span class="nf">terminate</span><span class="p">(_</span><span class="nv">Reason</span><span class="p">,</span> <span class="p">_</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">ok</span><span class="p">.</span>
</span><span class="line">
</span><span class="line"><span class="nf">code_change</span><span class="p">(_</span><span class="nv">OldVersion</span><span class="p">,</span> <span class="nv">State</span><span class="p">,</span> <span class="p">_</span><span class="nv">Extra</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span><span class="line">
</span><span class="line"><span class="nf">init</span><span class="p">([])</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">new</span><span class="p">()}.</span>
</span></code></pre></td></tr></table></div></figure><p>These are mostly things that we need to have in order for things to work.  We
define our module name, the behavior that this module mimics, and define a
constant.  Then, we export the required functions for gen_server and export
our public presence api functions.  Finally we implement really simple functions
for those gen_server functions that we don&#8217;t care much about.</p>
<p>Now since I couldn&#8217;t figure out how to slice a list in Erlang, I wrote my own
slice function.  Make sure to flame me for this.</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="nf">slice</span><span class="p">(</span><span class="nv">List</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="nv">End</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">slice</span><span class="p">(</span><span class="nv">List</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="nv">End</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]).</span>
</span><span class="line">
</span><span class="line"><span class="nf">slice</span><span class="p">([],</span> <span class="p">_</span><span class="nv">Start</span><span class="p">,</span> <span class="p">_</span><span class="nv">End</span><span class="p">,</span> <span class="p">_</span><span class="nv">Index</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">lists</span><span class="p">:</span><span class="n">reverse</span><span class="p">(</span><span class="nv">Acc</span><span class="p">);</span>
</span><span class="line"><span class="nf">slice</span><span class="p">([</span><span class="nv">Item</span> <span class="p">|</span> <span class="nv">Rest</span><span class="p">],</span> <span class="nv">Start</span><span class="p">,</span> <span class="nv">End</span><span class="p">,</span> <span class="nv">Index</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">case</span> <span class="nv">Index</span> <span class="o">&gt;=</span> <span class="nv">Start</span> <span class="k">of</span>
</span><span class="line">        <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="k">case</span> <span class="nv">Index</span> <span class="o">&lt;</span> <span class="nv">End</span> <span class="k">of</span>
</span><span class="line">                <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class="line">                    <span class="n">slice</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="nv">End</span><span class="p">,</span> <span class="nv">Index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nv">Item</span> <span class="p">|</span> <span class="nv">Acc</span><span class="p">]);</span>
</span><span class="line">                <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class="line">                    <span class="n">slice</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="nv">End</span><span class="p">,</span> <span class="nv">Index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span>
</span><span class="line">            <span class="k">end</span><span class="p">;</span>
</span><span class="line">        <span class="p">_</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="n">slice</span><span class="p">(</span><span class="nv">Rest</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="nv">End</span><span class="p">,</span> <span class="nv">Index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure><p>&#8230;and I&#8217;m pretty sure that using <a class="reference external" href="http://www.erlang.org/doc/reference_manual/expressions.html#guards">guard expressions</a> this could be done in one
case statement.  Or maybe it could be done in a single list comprehension.  I
don&#8217;t know.  This works for our purposes.</p>
<p>Now we have to write functions called <tt class="docutils literal">handle_cast</tt> and <tt class="docutils literal">handle_call</tt>.
<tt class="docutils literal">handle_cast</tt> is essentially a server function which you don&#8217;t expect a
response from.  Messages can queue up to this function and they will be handled
sequentially but never return any value to the caller.  <tt class="docutils literal">handle_call</tt> is
exactly the opposite.  The caller is expecting a response, so this is a blocking
operation.</p>
<p>Let&#8217;s use <tt class="docutils literal">handle_cast</tt> to accept new presence notifications:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="nf">handle_cast</span><span class="p">({</span><span class="n">post_presence</span><span class="p">,</span> <span class="nv">UserID</span><span class="p">,</span> <span class="nv">Presence</span><span class="p">},</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="n">is_key</span><span class="p">(</span><span class="nv">UserID</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="k">of</span>
</span><span class="line">        <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">append</span><span class="p">(</span><span class="nv">UserID</span><span class="p">,</span> <span class="p">{</span><span class="nn">erlang</span><span class="p">:</span><span class="n">now</span><span class="p">(),</span> <span class="nv">Presence</span><span class="p">},</span> <span class="nv">State</span><span class="p">)};</span>
</span><span class="line">        <span class="p">_</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nn">dict</span><span class="p">:</span><span class="n">store</span><span class="p">(</span><span class="nv">UserID</span><span class="p">,</span> <span class="p">[{</span><span class="nn">erlang</span><span class="p">:</span><span class="n">now</span><span class="p">(),</span> <span class="nv">Presence</span><span class="p">}],</span> <span class="nv">State</span><span class="p">)}</span>
</span><span class="line">    <span class="k">end</span><span class="p">;</span>
</span><span class="line"><span class="nf">handle_cast</span><span class="p">(_</span><span class="nv">Msg</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="p">{</span><span class="n">noreply</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure><p>In essence, we check to see if the user has registered their presence, and if
so, we add their presence to their presence list.  If they haven&#8217;t submitted
their presence before, we create a new presence list for them and add their
submitted presence to that list.  We have also generated a catchall version
of the function for when the call doesn&#8217;t match the signature
<tt class="docutils literal">{post_presence, UserID, Presence}</tt> for some reason.</p>
<p>Now let&#8217;s do the harder one: the call to get various presence information from
our server:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="nf">userfy_list</span><span class="p">(</span><span class="nv">User</span><span class="p">,</span> <span class="nv">List</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="p">(</span><span class="k">fun</span><span class="p">({</span><span class="nv">Time</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">User</span><span class="p">,</span> <span class="nv">Time</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">}</span> <span class="k">end</span><span class="p">,</span> <span class="nv">List</span><span class="p">).</span>
</span><span class="line">
</span><span class="line"><span class="nf">handle_call</span><span class="p">({</span><span class="n">list_presence</span><span class="p">,</span> <span class="nv">UserID</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="nv">UserID</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="k">of</span>
</span><span class="line">        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nv">Value</span><span class="p">,</span> <span class="nv">State</span><span class="p">};</span>
</span><span class="line">        <span class="n">error</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">user_does_not_exist</span><span class="p">},</span> <span class="nv">State</span><span class="p">}</span>
</span><span class="line">    <span class="k">end</span><span class="p">;</span>
</span><span class="line"><span class="nf">handle_call</span><span class="p">({</span><span class="n">list_presence</span><span class="p">,</span> <span class="nv">UserID</span><span class="p">,</span> <span class="nv">Limit</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">case</span> <span class="nn">dict</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="nv">UserID</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="k">of</span>
</span><span class="line">        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Value</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="nn">lists</span><span class="p">:</span><span class="n">nthtail</span><span class="p">(</span><span class="nv">Limit</span><span class="p">,</span> <span class="nv">Value</span><span class="p">),</span> <span class="nv">State</span><span class="p">};</span>
</span><span class="line">        <span class="n">error</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">user_does_not_exist</span><span class="p">},</span> <span class="nv">State</span><span class="p">}</span>
</span><span class="line">    <span class="k">end</span><span class="p">;</span>
</span><span class="line"><span class="nf">handle_call</span><span class="p">({</span><span class="n">public_list</span><span class="p">,</span> <span class="nv">Limit</span><span class="p">},</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nv">LatestEntries</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="n">flatten</span><span class="p">([</span><span class="n">userfy_list</span><span class="p">(</span><span class="nv">User</span><span class="p">,</span> <span class="nv">List</span><span class="p">)</span> <span class="p">||</span> <span class="p">{</span><span class="nv">User</span><span class="p">,</span> <span class="nv">List</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nn">dict</span><span class="p">:</span><span class="n">to_list</span><span class="p">(</span><span class="nv">State</span><span class="p">)]),</span>
</span><span class="line">    <span class="nv">Sorted</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="n">sort</span><span class="p">(</span><span class="k">fun</span><span class="p">({_,</span> <span class="nv">A</span><span class="p">,</span> <span class="p">_},</span> <span class="p">{_,</span> <span class="nv">B</span><span class="p">,</span> <span class="p">_})</span> <span class="o">-&gt;</span> <span class="nv">A</span> <span class="o">&gt;</span> <span class="nv">B</span> <span class="k">end</span><span class="p">,</span> <span class="nv">LatestEntries</span><span class="p">),</span>
</span><span class="line">    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="n">slice</span><span class="p">(</span><span class="nv">Sorted</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">Limit</span><span class="p">),</span> <span class="nv">State</span><span class="p">};</span>
</span><span class="line"><span class="nf">handle_call</span><span class="p">(_</span><span class="nv">Request</span><span class="p">,</span> <span class="p">_</span><span class="nv">From</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="p">{</span><span class="n">reply</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="nv">State</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure><p>The first version of <tt class="docutils literal">handle_call</tt> is very straightforward.  It simply looks
up the list of presence information for a given user and returns that in
the reply.  The second version does a similar thing, but calls <tt class="docutils literal">lists:nthtail</tt>
on the value to limit the number of presence data that is included in that list.</p>
<p>The final version of <tt class="docutils literal">handle_call</tt> is the most complicated, because we want to
get information about everyone, order it by the date that it was posted, and
limit the number of returned results by the specified limit.  An added
complexity is that we have to change the data format to include the name of the
user who posted it.</p>
<p>First it uses a list comprehension to take the state dictionary and run our
<tt class="docutils literal">userfy_list</tt> function on every User/List pair.  This will add the user to the
presence tuple.  Then we flatten that list to be just a single list of userfied
tuples.  Then, we sort that by the middle value (the timestamp of the presence).
Finally, we use our newly-created slice function to take just the slice of
information that we care about and return it to the user.  Again, there is a
catchall <tt class="docutils literal">handle_call</tt> which discards incorrectly-formatted messages.</p>
<div class="section" id="demo">
<h2>Demo</h2>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="mi">1</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">(</span><span class="n">presence_database</span><span class="p">).</span>
</span><span class="line"><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="n">presence_database</span><span class="p">}</span>
</span><span class="line"><span class="mi">2</span><span class="o">&gt;</span> <span class="nn">presence_database</span><span class="p">:</span><span class="n">start_link</span><span class="p">().</span>
</span><span class="line"><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">37</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">}</span>
</span><span class="line"><span class="mi">3</span><span class="o">&gt;</span> <span class="nn">presence_database</span><span class="p">:</span><span class="n">post_presence</span><span class="p">(</span><span class="s">&quot;ericflo&quot;</span><span class="p">,</span> <span class="s">&quot;I am at Super Happy Dev House&quot;</span><span class="p">).</span>
</span><span class="line"><span class="n">ok</span>
</span><span class="line"><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">presence_database</span><span class="p">:</span><span class="n">post_presence</span><span class="p">(</span><span class="s">&quot;ericflo&quot;</span><span class="p">,</span> <span class="s">&quot;I am writing erlang code&quot;</span><span class="p">).</span>
</span><span class="line"><span class="n">ok</span>
</span><span class="line"><span class="mi">5</span><span class="o">&gt;</span> <span class="nn">presence_database</span><span class="p">:</span><span class="n">post_presence</span><span class="p">(</span><span class="s">&quot;dreid&quot;</span><span class="p">,</span> <span class="s">&quot;I am having fun at SHDH&quot;</span><span class="p">).</span>
</span><span class="line"><span class="n">ok</span>
</span><span class="line"><span class="mi">6</span><span class="o">&gt;</span> <span class="nn">presence_database</span><span class="p">:</span><span class="n">list_presence</span><span class="p">(</span><span class="s">&quot;ericflo&quot;</span><span class="p">).</span>
</span><span class="line"><span class="p">[{{</span><span class="mi">1226</span><span class="p">,</span><span class="mi">816100</span><span class="p">,</span><span class="mi">955</span><span class="p">},</span><span class="s">&quot;I am at Super Happy Dev House&quot;</span><span class="p">},</span>
</span><span class="line"> <span class="p">{{</span><span class="mi">1226</span><span class="p">,</span><span class="mi">816113</span><span class="p">,</span><span class="mi">249498</span><span class="p">},</span><span class="s">&quot;I am writing erlang code&quot;</span><span class="p">}]</span>
</span><span class="line"><span class="mi">7</span><span class="o">&gt;</span> <span class="nn">presence_database</span><span class="p">:</span><span class="n">list_presence</span><span class="p">(</span><span class="s">&quot;dreid&quot;</span><span class="p">).</span>
</span><span class="line"><span class="p">[{{</span><span class="mi">1226</span><span class="p">,</span><span class="mi">816135</span><span class="p">,</span><span class="mi">937300</span><span class="p">},</span><span class="s">&quot;I am having fun at SHDH&quot;</span><span class="p">}]</span>
</span><span class="line"><span class="mi">8</span><span class="o">&gt;</span> <span class="nn">presence_database</span><span class="p">:</span><span class="n">public_list</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span>
</span><span class="line"><span class="p">[{</span><span class="s">&quot;dreid&quot;</span><span class="p">,{</span><span class="mi">1226</span><span class="p">,</span><span class="mi">816135</span><span class="p">,</span><span class="mi">937300</span><span class="p">},</span><span class="s">&quot;I am having fun at SHDH&quot;</span><span class="p">},</span>
</span><span class="line"> <span class="p">{</span><span class="s">&quot;ericflo&quot;</span><span class="p">,{</span><span class="mi">1226</span><span class="p">,</span><span class="mi">816113</span><span class="p">,</span><span class="mi">249498</span><span class="p">},</span><span class="s">&quot;I am writing erlang code&quot;</span><span class="p">},</span>
</span><span class="line"> <span class="p">{</span><span class="s">&quot;ericflo&quot;</span><span class="p">,</span>
</span><span class="line">  <span class="p">{</span><span class="mi">1226</span><span class="p">,</span><span class="mi">816100</span><span class="p">,</span><span class="mi">955</span><span class="p">},</span>
</span><span class="line">  <span class="s">&quot;I am at Super Happy Dev House&quot;</span><span class="p">}]</span>
</span><span class="line"><span class="mi">9</span><span class="o">&gt;</span> <span class="nn">presence_database</span><span class="p">:</span><span class="n">public_list</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span>
</span><span class="line"><span class="p">[{</span><span class="s">&quot;dreid&quot;</span><span class="p">,{</span><span class="mi">1226</span><span class="p">,</span><span class="mi">816135</span><span class="p">,</span><span class="mi">937300</span><span class="p">},</span><span class="s">&quot;I am having fun at SHDH&quot;</span><span class="p">},</span>
</span><span class="line"> <span class="p">{</span><span class="s">&quot;ericflo&quot;</span><span class="p">,{</span><span class="mi">1226</span><span class="p">,</span><span class="mi">816113</span><span class="p">,</span><span class="mi">249498</span><span class="p">},</span><span class="s">&quot;I am writing erlang code&quot;</span><span class="p">}]</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="conclusions">
<h2>Conclusions</h2>
<p>This really isn&#8217;t robust.  If we wanted it to be more robust, we should use
some sort of persistent storage, we should use more than one process and do some
sort of consistent hashing to distribute the load, and we should have a
supervisor process to ensure that crashed processes restart correctly and reload
their data.</p>
<p>All of that is the case, but yet through this simple exercise I&#8217;ve learned a ton
about Erlang&#8217;s <tt class="docutils literal">gen_server</tt> module.  I don&#8217;t know if my explanations will do
people any good, but hopefully they give a glimpse into the world of Erlang.  So
now that all of that is said, show me how to slice in Erlang!</p>
<p><strong>EDIT:</strong> Commenter <em>Mihai</em> has made me aware of the <tt class="docutils literal">lists:sublist</tt> function, which does exactly what I want.  I can now discard my crappy slice function.</p>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/14/easy-multi-database-support-django/">Easy Multi-Database Support for Django</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-14T21:51:44-08:00" pubdate data-updated="true">Nov 14<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="section" id="background">
<h2>Background</h2>
<p>One of the most requested features in Django is that it support connecting to
multiple databases at once.  This can come in several flavors, but the two
most common cases are <a class="reference external" href="http://en.wikipedia.org/wiki/Shard_(database_architecture)">sharding</a>, and (vertical) <a class="reference external" href="http://en.wikipedia.org/wiki/Partition_(database)">partitioning</a>.  If you&#8217;ve been
waching closely, some of the core developers have been saying in various places
for a few months now that this is technically possible, right now, in Django 1.0.</p>
<p>Of course, being technically possible is a long way from being easy.  Right now
there is no public API for dealing with multiple databases.  So why do the
developers say that it&#8217;s possible to do?  The answer is simple: shortly before
Django 1.0 was released, much of the internals of QuerySet objects (Django&#8217;s
interface to the database) were refactored to use object state-level connection
objects instead of a global connection object.</p>
<p>This seemingly-small change opens the doors for multiple databases, even if
there is no API in front of it.  So let&#8217;s create an API.  We&#8217;re going to be
focusing on vertical partitioning, since it&#8217;s slightly easier, but the technique
demonstrated here will be illustrative when implementing sharding as well.  Oh,
and since we&#8217;re poking deep into the core of Django&#8217;s internals, I&#8217;m obliged to
give the standard disclaimer: this is not supported and may break in future
versions of Django, so use these techniques at your own risk.</p>
</div>
<div class="section" id="first-things-first">
<h2>First things first</h2>
<p>The first thing that needs to be done when implementing multiple database
support is to supply Django with the information about all of the databases
that you would like to connect to.  Here&#8217;s how that should look in
<tt class="docutils literal">settings.py</tt>:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">DATABASE_ENGINE</span> <span class="o">=</span> <span class="s">&#39;sqlite3&#39;</span>
</span><span class="line"><span class="n">DATABASE_NAME</span> <span class="o">=</span> <span class="s">&#39;primary.db&#39;</span>
</span><span class="line"><span class="n">DATABASE_USER</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line"><span class="n">DATABASE_PASSWORD</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line"><span class="n">DATABASE_HOST</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line"><span class="n">DATABASE_PORT</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">DATABASES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class="line">    <span class="n">primary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class="line">        <span class="n">DATABASE_ENGINE</span><span class="o">=</span><span class="n">DATABASE_ENGINE</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_NAME</span><span class="o">=</span><span class="n">DATABASE_NAME</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_USER</span><span class="o">=</span><span class="n">DATABASE_USER</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_PASSWORD</span><span class="o">=</span><span class="n">DATABASE_PASSWORD</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_HOST</span><span class="o">=</span><span class="n">DATABASE_HOST</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_PORT</span><span class="o">=</span><span class="n">DATABASE_PORT</span><span class="p">,</span>
</span><span class="line">    <span class="p">),</span>
</span><span class="line">    <span class="n">secondary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class="line">        <span class="n">DATABASE_ENGINE</span><span class="o">=</span><span class="n">DATABASE_ENGINE</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_NAME</span><span class="o">=</span><span class="s">&#39;secondary.db&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_USER</span><span class="o">=</span><span class="n">DATABASE_USER</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_PASSWORD</span><span class="o">=</span><span class="n">DATABASE_PASSWORD</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_HOST</span><span class="o">=</span><span class="n">DATABASE_HOST</span><span class="p">,</span>
</span><span class="line">        <span class="n">DATABASE_PORT</span><span class="o">=</span><span class="n">DATABASE_PORT</span><span class="p">,</span>
</span><span class="line">    <span class="p">),</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>We have not only created the typical database information that Django
requires, but we&#8217;ve also created a dictionary containing information about all
of the databases that we intend to connect to.  In this case, we are connecting
to two sqlite databases in the same directory, named <tt class="docutils literal">primary.db</tt> and
<tt class="docutils literal">secondary.db</tt>.</p>
<p>Let&#8217;s now create an app, named <tt class="docutils literal">blog</tt> (I know, I know, very unoriginal).  The
<tt class="docutils literal">models.py</tt> will look like this:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">datetime</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
</span><span class="line">    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
</span><span class="line">    <span class="n">date_submitted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Link</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>
</span><span class="line">    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">    <span class="n">date_submitted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>And we hook it up to the admin and settings.py in the normal manner.  For more
information on how to do this, follow <a class="reference external" href="http://docs.djangoproject.com/en/dev/#tutorial-writing-your-first-django-application">the official tutorial</a>.  We&#8217;re going to
be storing the <tt class="docutils literal">Post</tt> objects in the primary database, and the <tt class="docutils literal">Link</tt>
objects in the secondary database.  Since they don&#8217;t have any foreign keys, we
don&#8217;t have to worry about joins. (They are possible, but not easy to describe
in one post.)</p>
</div>
<div class="section" id="multiple-databases">
<h2>Multiple databases</h2>
<p>We should probably write some code that will inspect all of our models and
create only the tables that we want in each database.  For the sake of
simplicity and practicality of a blog post, we&#8217;re not going to do that.
Instead, we will simply create all of the schema on both databases.  The
management command to do so might look something like this (I called it
multi_syncdb):</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">NoArgsCommand</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.core.management</span> <span class="kn">import</span> <span class="n">call_command</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">NoArgsCommand</span><span class="p">):</span>
</span><span class="line">    <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;Sync multiple databases.&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">handle_noargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
</span><span class="line">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">database</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATABASES</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
</span><span class="line">            <span class="k">print</span> <span class="s">&quot;Running syncdb for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span>
</span><span class="line">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
</span><span class="line">                <span class="nb">setattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class="line">            <span class="n">call_command</span><span class="p">(</span><span class="s">&#39;syncdb&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>All of this has been fine, but the real workhorse of multiple database support
lies in the model&#8217;s <tt class="docutils literal">Manager</tt>.  Let&#8217;s write a multi-db aware manager right
now:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">sql</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.db.transaction</span> <span class="kn">import</span> <span class="n">savepoint_state</span>
</span><span class="line">
</span><span class="line"><span class="k">try</span><span class="p">:</span>
</span><span class="line">    <span class="kn">import</span> <span class="nn">thread</span>
</span><span class="line"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span class="line">    <span class="kn">import</span> <span class="nn">dummy_thread</span> <span class="kn">as</span> <span class="nn">thread</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MultiDBManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
</span><span class="line">        <span class="nb">super</span><span class="p">(</span><span class="n">MultiDBManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_query_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MultiDBManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_query_set</span><span class="p">()</span>
</span><span class="line">        <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_wrapper</span><span class="p">()</span>
</span><span class="line">        <span class="k">return</span> <span class="n">qs</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_db_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="n">database</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATABASES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">]</span>
</span><span class="line">        <span class="n">backend</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;django.db.backends.&#39;</span> <span class="o">+</span> <span class="n">database</span><span class="p">[</span><span class="s">&#39;DATABASE_ENGINE&#39;</span><span class="p">]</span>
</span><span class="line">            <span class="o">+</span> <span class="s">&quot;.base&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">])</span>
</span><span class="line">        <span class="n">backup</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
</span><span class="line">            <span class="n">backup</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span class="line">            <span class="nb">setattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class="line">        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">DatabaseWrapper</span><span class="p">()</span>
</span><span class="line">        <span class="n">wrapper</span><span class="o">.</span><span class="n">_cursor</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span class="line">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">backup</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
</span><span class="line">            <span class="nb">setattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="n">wrapper</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">raw_values</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
</span><span class="line">        <span class="n">query</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">InsertQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_db_wrapper</span><span class="p">())</span>
</span><span class="line">        <span class="n">query</span><span class="o">.</span><span class="n">insert_values</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">raw_values</span><span class="p">)</span>
</span><span class="line">        <span class="n">ret</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="n">return_id</span><span class="p">)</span>
</span><span class="line">        <span class="n">query</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>
</span><span class="line">        <span class="n">thread_ident</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span>
</span><span class="line">        <span class="k">if</span> <span class="n">thread_ident</span> <span class="ow">in</span> <span class="n">savepoint_state</span><span class="p">:</span>
</span><span class="line">            <span class="k">del</span> <span class="n">savepoint_state</span><span class="p">[</span><span class="n">thread_ident</span><span class="p">]</span>
</span><span class="line">        <span class="k">return</span> <span class="n">ret</span>
</span></code></pre></td></tr></table></div></figure><p>I know that&#8217;s a lot of code!  Let&#8217;s go through each piece one-by-one.  In the
<tt class="docutils literal">__init__</tt> function, we&#8217;re just taking in the name of the database that we
want to use, and passing the rest into the inherited <tt class="docutils literal">__init__</tt> function.</p>
<p><tt class="docutils literal">get_query_set</tt> gets the <tt class="docutils literal">QuerySet</tt> instance that it would have gotten, but
replaces the connection on the query object with one provided by the manager,
before returning the <tt class="docutils literal">QuerySet</tt>.  In essence, this <tt class="docutils literal">get_db_wrapper</tt> function
is doing the bulk of the work.</p>
<p><tt class="docutils literal">get_db_wrapper</tt> first gets the dictionary of the database connection
information for the given database name (captured from <tt class="docutils literal">__init__</tt>), then
dynamically imports the correct database backend from Django.  It then sets
the global settings to the values that they should be for that database (while
backing up the original settings for restoration later).  Then, it initializes
that database connection, and restores the settings to their original values.</p>
<p>Most of the database operations are done through the <tt class="docutils literal">QuerySet</tt>, there is
still one operation which takes place elsewhere&#8211;saving.  To account for that,
we needed to override the <tt class="docutils literal">_insert</tt> method on the manager.  In fact, all we&#8217;re
doing here is providing the <tt class="docutils literal">InsertQuery</tt> with the correct connection and
executing that query.  Then, we need to ensure that the query is committed and
do any transaction management that&#8217;s necessary.</p>
<p>That&#8217;s it!</p>
<p>How do we specify that one ore more models will use another database then?
Because so far all that we have done is write this <tt class="docutils literal">MultiDBManager</tt>.  We will
just add one line assigning the manager to our <tt class="docutils literal">Link</tt> model.  The model
now looks like this:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">Link</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>
</span><span class="line">    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">    <span class="n">date_submitted</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">_default_manager</span> <span class="o">=</span> <span class="n">MultiDBManager</span><span class="p">(</span><span class="s">&#39;secondary&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>The <tt class="docutils literal">MultiDBManager</tt> can be re-used for any number of models to be partitioned
on to any number of databases.  The hard part is making sure that none of the
models in one database reference any models in the other database.  It&#8217;s
possible to do it, by storing the foreign key as a regular integer and querying
for all of the referenced model instances through Python instead of using the
database (for obvious reasons), but then it becomes much harder.</p>
<p>It will be great when Django provides a public API for doing this in a more
transparent way, but for now this works.  Please let me know if you use any
of these techniques for large scale Django deployments, and if so, what were the
problems that were encountered along the way?</p>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/13/ide-or-not-ide-question/">&#8220;To IDE or Not to IDE?&#8221;, That Is the Question</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-13T20:24:18-08:00" pubdate data-updated="true">Nov 13<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few years ago, when I first started using Python, I spent an inordinate amount
of time looking for &quot;a good Python IDE.&quot;  The classic <a class="reference external" href="http://wiki.python.org/moin/CategoryIntegratedDevelopmentEnvironment?highlight=((IntegratedDevelopmentEnvironments))">IDE links</a> page on the
Python wiki was around back then, and looked fairly similar to the way it looks
now.  I was used to Java and Eclipse.  Java, if you haven&#8217;t used it, is
difficult at best to use without an IDE.</p>
<p>Understandably, then, I wanted to see what was available (and free).  At the
time, the two reigning free ones were Eric3, and SPE, and PyDev was quickly
gaining popularity.  I found Eric3 to be extremely buggy, crashing every few
minutes.  Everyone seemed to love it, but I couldn&#8217;t get it to work stably for
me, which was a deal breaker.</p>
<p>PyDev seemed too heavyweight.  After all, I was trying to switch <em>away</em> from
Java!  Plus, the fact that it stored metadata in these strange .project files
bugged me to no end.  SPE was one that I actually used for a while.  It was
stable, seemed to be featureful, and had a good community around it.  But
I found that the interface ended up getting in the way more than helping, and
eventually I abandoned that as well.</p>
<p>I tried trial versions of Wing and Komodo, and of course they were the best, but
they sure didn&#8217;t seem like they were worth what their respective companies were
asking for them.  Anyway, at this point several months had gone by, and I had
gotten pretty comfortable with Python.  The search for an IDE ended up making me
proficient enough that I found I didn&#8217;t need an IDE at all!</p>
<p>Today, I code in TextMate.  But I have no strong preference over any other text
editor (in fact, I think my preferred text editor is <a class="reference external" href="http://kate-editor.org/">Kate</a>), but the simplicity
that it brings is pretty much unbeatable.</p>
<p>All of this brings me to my question for anyone who&#8217;s willing to answer: should
I take a second look at any of these IDEs?  A few years after I did this
research and I&#8217;m willing to entertain the idea that it&#8217;s possible an IDE could
make development easier.  Is there a new kid on the block that is sweeping people
off their feet?</p></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/02/16/technology-behind-convore/">The Technology Behind Convore</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/10/10/object-lesson-how-respond-criticism/">An Object Lesson in How to Respond to Criticism</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/09/27/why-node-disappoints-me/">Why node.js disappoints me</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/05/20/we-need-new-word-open/">We need a new word for &#8220;Open&#8221;</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/02/08/how-do-we-kick-our-synchronous-addiction/">How do we kick our synchronous addiction?</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("ericflo", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/ericflo" class="twitter-follow-button" data-show-count="false">Follow @ericflo</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/109591387819364984777?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Eric Florenzano -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
