
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Eric Florenzano's Blog</title>
  <meta name="author" content="Eric Florenzano">

  
  <meta name="description" content="&quot;Another feature that&#8217;s easy to add is a per-entry way to allow or disallow comments.&quot;
From Practical Django Projects by James &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ericflo.github.com/blog/page/4">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Eric Florenzano's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1959803-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Eric Florenzano's Blog</a></h1>
  
    <h2>I am me.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ericflo.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/12/book-meme/">Book Meme</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-12T21:19:41-08:00" pubdate data-updated="true">Nov 12<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>&quot;Another feature that&#8217;s easy to add is a per-entry way to allow or disallow comments.&quot;
From <em>Practical Django Projects</em> by <a class="reference external" href="http://www.b-list.org/">James Bennett</a>.</p>
<p>Meme from <a class="reference external" href="http://jtauber.com/blog/2008/11/12/book_meme/">James Tauber</a>, <a class="reference external" href="http://www.20seven.org/journal/2008/11/book-meme.html">Greg Newman</a>, <a class="reference external" href="http://justinlilly.com/blog/2008/nov/12/book-memery/">Justin Lilly</a> and <a class="reference external" href="http://oebfare.com/blog/2008/nov/12/book-memery/">Brian Rosner</a>.</p>
<blockquote>
<ul class="simple">
<li>Grab the nearest book.</li>
<li>Open it to page 56.</li>
<li>Find the fifth sentence.</li>
<li>Post the text of the sentence in your journal along with these instructions.</li>
<li>Don&#8217;t dig for your favorite book, the cool book, or the intellectual one: pick the CLOSEST.</li>
</ul>
</blockquote>
<p>The MOST ironic part about this all, is that I was not going to do this meme tonight, and instead write a post.  However, I was so busy trying to beat James Bennett&#8217;s score on level 3 of <a class="reference external" href="http://www.mochiads.com/challenge/accept/68dbee0cb670b06e8d0ced46fd616c87">this challenge</a>, that I ran out of time for tonight.</p>
<p>P.S. I dare you to beat my now 357,500 points on level 3 of the game in that link.  I bet you can&#8217;t.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/11/why-use-varchar-when-you-can-use-text/">Why Use a VARCHAR When You Can Use TEXT?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-11T08:23:24-08:00" pubdate data-updated="true">Nov 11<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Admit it, you&#8217;ve done it many times before: you create a database schema,
arbitrarily guessing at upper limits to the lengths of various columns, only to
later have to perform annoying schema upgrades as you change those columns to
fit real-world data.</p>
<p>If you&#8217;re using <a class="reference external" href="http://www.postgresql.org/">PostgreSQL</a>, what you&#8217;re doing is pointless.  There is quite
literally no performance benefit to be had, and possibly a performance penalty
as the database needs to check the length constraint.  This fact can even be
found <a class="reference external" href="http://www.postgresql.org/docs/8.3/interactive/datatype-character.html">right here, in the official documentation</a>.</p>
<p>If you&#8217;re using <a class="reference external" href="http://www.mysql.com/">MySQL</a> with <a class="reference external" href="http://www.innodb.com/">InnoDB</a>, it&#8217;s practically the same situation.  The
data is laid out on disk in exactly the same way for both TEXT and VARCHAR
fields, as explained <a class="reference external" href="http://forums.innodb.com/read.php?4,61,80#msg-80">here</a>.  I couldn&#8217;t find any resources about MyISAM other
than that TEXT is stored externally, but I just fired up a test table and did
some rudimentary benchmarking and the numbers were well within the margin of
error.</p>
<p>If you&#8217;re using <a class="reference external" href="http://www.sqlite.org/">SQLite</a>, everything&#8217;s a TEXT whether you want it to be or not (
with the notable exception of INTEGER PRIMARY KEY) so it doesn&#8217;t matter what
you try to specify, it will be a TEXT.</p>
<p>I&#8217;m as guilty as anyone else on this&#8211;I use varchar all the time!  But come on,
let&#8217;s stop imposing these arbitrary character limits on our columns when the
only reason we&#8217;re doing it is for historical reasons.  Is anyone with me?</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/10/making-django-imports-less-painful/">Making Django Imports Less Painful</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-10T19:25:58-08:00" pubdate data-updated="true">Nov 10<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Way back in the early days of Django, it used to magically import certain functions before any views were ever run.  At some point that bit of magic got stripped out and now we have to explicitly import the things that we are going to use&#8230;much like everything else in Python.  One thing that <a class="reference external" href="http://simonwillison.net/">Simon Willison</a> suggested at DjangoCon is that the core developers might think about including a common set of functions that could be imported and used as shortcuts instead of importing everything again and again.</p>
<p>I shrugged it off at the time, thinking it was a solution in search of a problem, but wanting to keep an open mind, I wanted to try it out in one app to see how it would look.  In this spirit, I created a file called <tt class="docutils literal">dj.py</tt> inside of a project of mine, <a class="reference external" href="http://code.google.com/p/django-avatar/">django-avatar</a>.  I looked around at what some of the most commonly used functions were, and came up with a <tt class="docutils literal">dj.py</tt> file that looked something like this:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>
</span></code></pre></td></tr></table></div></figure><p>Then I went through and deleted all of these imports from throughout the project, and replaced it with a single import:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">avatar</span> <span class="kn">import</span> <span class="n">dj</span>
</span></code></pre></td></tr></table></div></figure><p>Now we have that shortcut module loaded, we can use it.  Here&#8217;s an example of what one view looked like before:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">extra_context</span><span class="o">=</span><span class="p">{},</span> <span class="n">next_override</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="line">    <span class="n">avatars</span> <span class="o">=</span> <span class="n">Avatar</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-primary&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">avatars</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">avatar</span> <span class="o">=</span> <span class="n">avatars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">avatar</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="line">    <span class="n">delete_avatar_form</span> <span class="o">=</span> <span class="n">DeleteAvatarForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
</span><span class="line">        <span class="k">if</span> <span class="n">delete_avatar_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span><span class="line">            <span class="n">ids</span> <span class="o">=</span> <span class="n">delete_avatar_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;choices&#39;</span><span class="p">]</span>
</span><span class="line">            <span class="n">Avatar</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span class="line">            <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">message_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span class="line">                <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Successfully deleted the requested avatars.&quot;</span><span class="p">))</span>
</span><span class="line">            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">next_override</span> <span class="ow">or</span> <span class="n">_get_next</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
</span><span class="line">        <span class="s">&#39;avatar/confirm_delete.html&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="n">extra_context</span><span class="p">,</span>
</span><span class="line">        <span class="n">context_instance</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span>
</span><span class="line">            <span class="n">request</span><span class="p">,</span>
</span><span class="line">            <span class="p">{</span> <span class="s">&#39;avatar&#39;</span><span class="p">:</span> <span class="n">avatar</span><span class="p">,</span>
</span><span class="line">              <span class="s">&#39;avatars&#39;</span><span class="p">:</span> <span class="n">avatars</span><span class="p">,</span>
</span><span class="line">              <span class="s">&#39;delete_avatar_form&#39;</span><span class="p">:</span> <span class="n">delete_avatar_form</span><span class="p">,</span>
</span><span class="line">              <span class="s">&#39;next&#39;</span><span class="p">:</span> <span class="n">next_override</span> <span class="ow">or</span> <span class="n">_get_next</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="p">}</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">    <span class="p">)</span>
</span><span class="line"><span class="n">change</span> <span class="o">=</span> <span class="n">login_required</span><span class="p">(</span><span class="n">change</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>And here&#8217;s what the code looked like afterward:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">avatar</span> <span class="kn">import</span> <span class="n">dj</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">extra_context</span><span class="o">=</span><span class="p">{},</span> <span class="n">next_override</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="line">    <span class="n">avatars</span> <span class="o">=</span> <span class="n">Avatar</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-primary&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">avatars</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">avatar</span> <span class="o">=</span> <span class="n">avatars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">    <span class="k">else</span><span class="p">:</span>
</span><span class="line">        <span class="n">avatar</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="line">    <span class="n">delete_avatar_form</span> <span class="o">=</span> <span class="n">DeleteAvatarForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
</span><span class="line">        <span class="k">if</span> <span class="n">delete_avatar_form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
</span><span class="line">            <span class="n">ids</span> <span class="o">=</span> <span class="n">delete_avatar_form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;choices&#39;</span><span class="p">]</span>
</span><span class="line">            <span class="n">Avatar</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span class="line">            <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">message_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span class="line">                <span class="n">message</span><span class="o">=</span><span class="n">dj</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Successfully deleted the requested avatars.&quot;</span><span class="p">))</span>
</span><span class="line">            <span class="k">return</span> <span class="n">dj</span><span class="o">.</span><span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">next_override</span> <span class="ow">or</span> <span class="n">_get_next</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</span><span class="line">    <span class="k">return</span> <span class="n">dj</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span>
</span><span class="line">        <span class="s">&#39;avatar/confirm_delete.html&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="n">extra_context</span><span class="p">,</span>
</span><span class="line">        <span class="n">context_instance</span> <span class="o">=</span> <span class="n">dj</span><span class="o">.</span><span class="n">RequestContext</span><span class="p">(</span>
</span><span class="line">            <span class="n">request</span><span class="p">,</span>
</span><span class="line">            <span class="p">{</span> <span class="s">&#39;avatar&#39;</span><span class="p">:</span> <span class="n">avatar</span><span class="p">,</span>
</span><span class="line">              <span class="s">&#39;avatars&#39;</span><span class="p">:</span> <span class="n">avatars</span><span class="p">,</span>
</span><span class="line">              <span class="s">&#39;delete_avatar_form&#39;</span><span class="p">:</span> <span class="n">delete_avatar_form</span><span class="p">,</span>
</span><span class="line">              <span class="s">&#39;next&#39;</span><span class="p">:</span> <span class="n">next_override</span> <span class="ow">or</span> <span class="n">_get_next</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="p">}</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">    <span class="p">)</span>
</span><span class="line"><span class="n">change</span> <span class="o">=</span> <span class="n">dj</span><span class="o">.</span><span class="n">login_required</span><span class="p">(</span><span class="n">change</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>It works!  Although after all of that, I have decided that in my opinion it&#8217;s just not worth the effort.  It adds an extra level of indirection when tracing through the code, it litters the view with the <tt class="docutils literal">dj</tt> namespace, and it&#8217;s harder to know what you have available to you.  Maybe you like this style better, though.  If so, what about this style do you like?</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/09/using-couchdb-django/">Using CouchDB With Django</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-09T21:59:59-08:00" pubdate data-updated="true">Nov 9<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ahhh, <a class="reference external" href="http://www.djangoproject.com/">Django</a>: my favorite web framework.  And <a class="reference external" href="http://incubator.apache.org/couchdb/">CouchDB</a>: my favorite new
database technology.  How can I pair these two awesomes together to make an
awesome-er?</p>
<p>One of the features that I would like to add to this site when it&#8217;s time for an
upgrade is a lifestream.  It seems like everyone is doing it these days (isn&#8217;t
this great logic!), so I probably should too.  Originally this was going to be
written in the standard Django way&#8211;write some models, fill it with data, and
slice and dice that data to make it pretty.</p>
<p>After thinking about it, I decided not to go that route.  Why?  Well, let&#8217;s go
over it: There needs to be a <a class="reference external" href="http://twitter.com/">Twitter</a> model, that&#8217;s for sure.  I also want a
<a class="reference external" href="http://pownce.com/">Pownce</a> model, and a <a class="reference external" href="http://flickr.com/">Flickr</a> model.  Already this is becoming tedious!  At this
point we have two options: continue creating these individual models and fill
them with data, or try to find the common bits and group them into Ubermodels
of some sort, with some type of field to use as a discriminator.  Ugh.</p>
<p>This is the perfect use case for a schemaless database, and <a class="reference external" href="http://incubator.apache.org/couchdb/">CouchDB</a> fits that
bill just perfectly.  Plus its <a class="reference external" href="http://code.google.com/p/couchdb-python/">python support</a> is actually quite mature, and
running it on a mac is, quite literally, <a class="reference external" href="http://jan.prima.de/~jan/plok/archives/142-CouchDBX-Revival.html">one click</a>.  So now that we&#8217;ve all
agreed (we all agree, right?) that we want to use <a class="reference external" href="http://incubator.apache.org/couchdb/">CouchDB</a> with <a class="reference external" href="http://www.djangoproject.com/">Django</a>, how
can we make it happen?</p>
<p>First let&#8217;s set some database settings:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">COUCHDB_HOST</span> <span class="o">=</span> <span class="s">&#39;http://localhost:5984/&#39;</span>
</span><span class="line"><span class="n">TWITTER_USERNAME</span> <span class="o">=</span> <span class="s">&#39;ericflo&#39;</span>
</span></code></pre></td></tr></table></div></figure><p>So far, so good.  Now let&#8217;s write some initialization code and put it in to an
application in the <tt class="docutils literal">__init__.py</tt>:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">couchdb</span> <span class="kn">import</span> <span class="n">client</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">CouchDBImproperlyConfigured</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span class="line">    <span class="k">pass</span>
</span><span class="line">
</span><span class="line"><span class="k">try</span><span class="p">:</span>
</span><span class="line">    <span class="n">HOST</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">COUCHDB_HOST</span>
</span><span class="line"><span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span class="line">    <span class="k">raise</span> <span class="n">CouchDBImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;Please ensure that COUCHDB_HOST is &quot;</span> <span class="o">+</span> \
</span><span class="line">        <span class="s">&quot;set in your settings file.&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">DATABASE_NAME</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;COUCHDB_DATABASE_NAME&#39;</span><span class="p">,</span> <span class="s">&#39;couch_lifestream&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">COUCHDB_DESIGN_DOCNAME</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;COUCHDB_DESIGN_DOCNAME&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&#39;couch_lifestream-design&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;couchdb_server&#39;</span><span class="p">):</span>
</span><span class="line">    <span class="n">server</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">HOST</span><span class="p">)</span>
</span><span class="line">    <span class="n">settings</span><span class="o">.</span><span class="n">couchdb_server</span> <span class="o">=</span> <span class="n">server</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;couchdb_db&#39;</span><span class="p">):</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">db</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">DATABASE_NAME</span><span class="p">)</span>
</span><span class="line">    <span class="k">except</span> <span class="n">client</span><span class="o">.</span><span class="n">ResourceConflict</span><span class="p">:</span>
</span><span class="line">        <span class="n">db</span> <span class="o">=</span> <span class="n">server</span><span class="p">[</span><span class="n">DATABASE_NAME</span><span class="p">]</span>
</span><span class="line">    <span class="n">settings</span><span class="o">.</span><span class="n">couchdb_db</span> <span class="o">=</span> <span class="n">db</span>
</span></code></pre></td></tr></table></div></figure><p>In this code, we&#8217;re loading the CouchDB client and either creating or
connecting to a database.  We do a bit of error checking to ensure that if we
forgot to add <tt class="docutils literal">COUCHDB_HOST</tt> in our settings file, it will yell at us. So how
do we use this?  Let&#8217;s write some data importing stuff!</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">try</span><span class="p">:</span>
</span><span class="line">    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>
</span><span class="line"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span class="line">    <span class="kn">import</span> <span class="nn">json</span>
</span><span class="line">
</span><span class="line"><span class="n">TWITTER_USERNAME</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;TWITTER_USERNAME&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">fetched</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;http://twitter.com/statuses/user_timeline.json?id=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
</span><span class="line">    <span class="n">TWITTER_USERNAME</span><span class="p">,))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class="line"><span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fetched</span><span class="p">)</span>
</span><span class="line"><span class="n">map_fun</span> <span class="o">=</span> <span class="s">&#39;function(doc) { emit(doc.id, null); }&#39;</span>
</span><span class="line"><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class="line">    <span class="n">item</span><span class="p">[</span><span class="s">&#39;item_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;twitter&#39;</span>
</span><span class="line">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">map_fun</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">        <span class="n">db</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>This can go inside a Django management command or in a standalone script.
Essentially what we&#8217;re doing is loading the timeline for a user, and then for
each item in that response we&#8217;re setting the <tt class="docutils literal">item_type</tt> to &#8216;twitter&#8217;.  Then
we&#8217;re checking to see if an item with that current twitter id already exists,
and if not, we&#8217;re creating it.</p>
<p>Now we need a way to query this data.  In <a class="reference external" href="http://incubator.apache.org/couchdb/">CouchDB</a>, the way to query for data is
using <a class="reference external" href="http://wiki.apache.org/couchdb/Views">views</a>.  Views are stored in the database, so they can be entered
manually, but I much prefer to manage views programmatically.  Thankfully,
Python&#8217;s CouchDB library and Django give us all we need to make this very, very
easy:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">signals</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">couch_lifestream</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">COUCHDB_DESIGN_DOCNAME</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">couchdb.design</span> <span class="kn">import</span> <span class="n">ViewDefinition</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
</span><span class="line">
</span><span class="line"><span class="n">by_date</span> <span class="o">=</span> <span class="n">ViewDefinition</span><span class="p">(</span><span class="n">COUCHDB_DESIGN_DOCNAME</span><span class="p">,</span> <span class="s">&#39;by_date&#39;</span><span class="p">,</span>
</span><span class="line">    <span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
</span><span class="line"><span class="s">    function(doc) {</span>
</span><span class="line"><span class="s">        emit(doc.couch_lifestream_date, null);</span>
</span><span class="line"><span class="s">    }</span>
</span><span class="line"><span class="s">&quot;&quot;&quot;</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">create_couchdb_views</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">created_models</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">    <span class="n">ViewDefinition</span><span class="o">.</span><span class="n">sync_many</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="p">[</span><span class="n">by_date</span><span class="p">])</span>
</span><span class="line"><span class="n">signals</span><span class="o">.</span><span class="n">post_syncdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">create_couchdb_views</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">models</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>Make sure that this is placed somewhere that will be loaded when Django&#8217;s
<tt class="docutils literal">manage.py</tt> is called.  In this case, I put it in the <tt class="docutils literal">__init__.py</tt> file
under <tt class="docutils literal">management/</tt>.  What we&#8217;re doing is creating two views&#8211;one which is
keyed by the <tt class="docutils literal">item_type</tt> (we set this earlier to be &#8216;twitter&#8217;), and another
which is keyed simply by date.  When we run <tt class="docutils literal">python manage.py syncdb</tt>, these
views will automatically be re-synced with the database.  Using this method, we
are able to manage these views quickly and easily, and distribute them in a
reusable way.</p>
<p>Now let&#8217;s create some Django views so that we can visualize this data:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">couch_lifestream</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">COUCHDB_DESIGN_DOCNAME</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">couchdb</span> <span class="kn">import</span> <span class="n">client</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">item</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span class="line">    <span class="k">try</span><span class="p">:</span>
</span><span class="line">        <span class="n">obj</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</span><span class="line">    <span class="k">except</span> <span class="n">client</span><span class="o">.</span><span class="n">ResourceNotFound</span><span class="p">:</span>
</span><span class="line">        <span class="k">raise</span> <span class="n">Http404</span>
</span><span class="line">    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;item&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">,</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
</span><span class="line">        <span class="s">&#39;couch_lifestream/item.html&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="n">context</span><span class="p">,</span>
</span><span class="line">        <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class="line">    <span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="line">    <span class="n">item_type_viewname</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/by_date&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">COUCHDB_DESIGN_DOCNAME</span><span class="p">,)</span>
</span><span class="line">    <span class="n">lifestream_items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">item_type_viewname</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line">    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="line">        <span class="s">&#39;items&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">lifestream_items</span><span class="p">),</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span>
</span><span class="line">        <span class="s">&#39;couch_lifestream/list.html&#39;</span><span class="p">,</span>
</span><span class="line">        <span class="n">context</span><span class="p">,</span>
</span><span class="line">        <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class="line">    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>The <tt class="docutils literal">item</tt> view is fairly self-explanatory.  We query the db for the object of
the specified id, and if it doesn&#8217;t exist, we throw a 404.  If it does exist, we
throw it into the context and let the template render the page.  The <tt class="docutils literal">items</tt>
view is slightly more interesting.  In this case, we&#8217;re using that CouchDB view
that we created to query the database by date, and passing that list into the
context.</p>
<p>Obviously there&#8217;s a ton more that we could cover, but these basic building
blocks that I&#8217;ve demonstrated are enough to get you started.  After this it&#8217;s
mostly all presentational work.  I&#8217;ve open sourced all of the code that has been
written so far for the upcoming lifestream portion of this site, even though
right now it only supports <a class="reference external" href="http://twitter.com/">Twitter</a> and <a class="reference external" href="http://pownce.com/">Pownce</a>.  I plan on continuing work
on it to support all of the services that I use.  You can track my progress
at the <a class="reference external" href="http://github.com/ericflo/django-couch-lifestream/tree/master">project&#8217;s page</a>.</p>
<p>I&#8217;ll make sure to blog about this again once the project is more mature, but for
now it should be fun to play around with.  Are you using CouchDB with Django?
If yes, then how are you dealing with that interaction?</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/08/legacy-code/">Legacy Code</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-08T18:45:13-08:00" pubdate data-updated="true">Nov 8<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Prompted by this whole blog post-per-day thing, I&#8217;ve begun looking at the source
code for this site again.  It was my first real Django project in early 2006,
and I was excited about all of the features that it gave me.  The community was
much smaller then, and although I suspect the guys from <a class="reference external" href="http://www.mediaphormedia.com/">Lawrence</a> had a good
idea of where site logic should go, at that time there was not the
<a class="reference external" href="http://www.b-list.org/weblog/2007/mar/27/reusable-django-apps/">widespread</a> <a class="reference external" href="http://pinaxproject.com/">knowledge</a> of <a class="reference external" href="http://apress.com/book/view/1590599969">best</a> <a class="reference external" href="http://www.djangobook.com/">practices</a>.</p>
<p>No knowledge of best practices, still learning Django, and being a relative
web development newbie, means that the code ended up being quite bad.  It was
all under one application, named &#8216;blog&#8217;.  All of the content loaded into the
sidebar was done via context processors (one processor called back to this
<tt class="docutils literal">get_digg_rss</tt> function that I <a class="reference external" href="http://www.eflorenzano.com/blog/post/new-site-live/">blogged about</a>, for example), and all the
templates were housed under that application.</p>
<p>Yeah.  It was that bad.</p>
<p>But over the years, Django evolved, and some code that this blog used were
deprecated while new functionality was added.  Over time as things broke, little
by little things were fixed and broken out into their own apps.  In short, the
site got better.  It was always organic improvement, though, and never a
deliberate effort.  Meaning that while it&#8217;s better than it was, it&#8217;s still not
very good.</p>
<p>Browsing through the code gives me a bit of nostalgia, but overwhelmingly my
urge is to just delete the entire thing and start over, picking from the best
reusable apps and migrating data as needed.  After some consideration, I don&#8217;t
think that urge is a good urge to act upon.  While it would take me a few
afternoons to fix the code of the site, it would take several days to start
from scratch.</p>
<p>This is one of my biggest faults as a programmer.  Instead of working with ugly
code and molding it into better code, I always enjoy starting from a clean slate
and building it up from there&#8211;so much so that I&#8217;ll sacrifice productivity to
do so.  I&#8217;m going to attempt to face this fault by not giving in to the
temptation to rebuild, and instead to work with what I&#8217;ve got.  Who knows, maybe
I&#8217;ll even open-source it.  I won&#8217;t open-source it unless its quality is up to
par with the other open source apps in the Django reusable app ecosystem.</p>
<p>How do you deal with legacy code?  Do you have any tips or tricks on how to do
it?  Do you think that it&#8217;s better to just start from scratch?</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/07/its-caches-all-way-down/">It&#8217;s Caches All the Way Down</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-07T21:52:53-08:00" pubdate data-updated="true">Nov 7<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few years back a non-technical person asked me to explain what, exactly, the
operating system did.  I first started out by speaking in broad generalities,
saying that it takes care of the basic needs of the computer and that it helps
one thing talk to another.  But that answer wasn&#8217;t good enough.  This person
wanted me to go into more detail.  What happens when I&#8217;m in the calculator
application and I type 1+1 and hit enter?  What things need to happen?</p>
<p>That really tripped me up.  It&#8217;s hard to even know where to start when someone
who&#8217;s curious like that asks a relatively innocent question like that.  So I
decided to just start from the basics.  &quot;A processor has these things called
registers&quot;, I said.  &quot;And they store a tiny little amount of information, which
they can do things with, like add and subtract.&quot;  That seemed to basically
satisfy them, but not me.</p>
<p>I made sure to say that, &quot;You can&#8217;t just keep everything in registers, because
there are only a few of those.  So you have to keep some data stored
in this place with more space for data but it&#8217;s slower.&quot;  To which they
responded, &quot;Oh, so is that why when I add more RAM my computer gets faster?&quot;
&quot;No,&quot; I said, &quot;this is all still on the processor.&quot;  &quot;OK, so what&#8217;s RAM then
and why is it supposed to help?&quot; they asked.  &quot;Because we can&#8217;t store everything
on the processor itself, because there&#8217;s not enough space for data, so we have
to store it in this place with much more space for data, but which is slower.&quot;</p>
<p>At this point I realized how redundant this conversation was going to get.  It&#8217;s
the same thing for the hard drive, and (if you&#8217;re old-school) tape drive or (if
you&#8217;re new-school) the internet.  At the same point that person seemed to get
bored&#8211;that moment of curiosity had passed.  Computers just do their thing
and we really didn&#8217;t have to do anything special for all of that data movement
to take place.</p>
<p>That&#8217;s what struck me.  When you come down to it, computers are just a waterfall
of different caches, with systems that determine what piece of data goes where
and when.  For the most part, in user space, we don&#8217;t care about much of that
either.  When writing a web application or even a desktop application, we don&#8217;t
much care whether a bit is in the register, the L1 or L2 cache, RAM, or if it&#8217;s
being swapped to disk.  We just care that whatever system is managing that data,
it&#8217;s doing the best it can to make our application fast.</p>
<p>But then another thing struck me.  Most web developers <em>DO</em> have to worry about
the cache.  We do it every day.  Whether you&#8217;re using memcached or velocity or
some other caching system, everyone&#8217;s manually moving data from the database
to a cache layer, and back again.  Sometimes we do clever things to make sure
this cached data is correct, but sometimes we do some braindead things.  We
certainly manage the cache keys ourselves and we come up with systems again and
again to do the same thing.</p>
<p>Does this strike anyone else as inconsistent?  For practically every cache layer
down the chain, a system (whose algorithms are usually the result of years and
years of work and testing) automatically determines how to best utilize that
cache, yet we do not yet have a <strong>good</strong> system for doing that with databases.
Why do you think that is?  Is it truly one of the two hard problems of
computer science?  Is it impossible to do this automatically?  I honestly don&#8217;t
have the answers, but I&#8217;m interested if you do.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/06/secrets-django-orm/">Secrets of the Django ORM</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-06T09:14:54-08:00" pubdate data-updated="true">Nov 6<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You won&#8217;t see this in the Django documentation, you won&#8217;t see it mentioned on
other blogs, and you certainly won&#8217;t hear the core developers of Django boasting
about it, but Django&#8217;s ORM has a secret weapon: it supports SQL <em>group_by</em> and
<em>having</em> clauses, and it has for quite some time.</p>
<p>It&#8217;s not part of the public <tt class="docutils literal">QuerySet</tt> API, but rather a part of the private
<tt class="docutils literal">Query</tt> API.  But just because it&#8217;s not part of the public API doesn&#8217;t mean
that it&#8217;s not easy to use&#8211;it just means that it might change in the future.
So it&#8217;s really a &quot;use at your own risk&quot; type of deal now.  If you&#8217;re up for
keeping on top of things so that you know what to change when the next version
of Django comes out, then read on.  First, let&#8217;s start with some model
definition:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">TumbleItem</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
</span><span class="line">    <span class="n">item_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>A simple tumblog item.  Very simple, as in, not really useful at all.  But
that&#8217;s OK since this is just a demonstration.  To demonstrate, let&#8217;s create
some data:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="pycon"><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">ti1</span> <span class="o">=</span> <span class="n">TumbleItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Blog Post 1&#39;</span><span class="p">,</span> <span class="n">item_type</span><span class="o">=</span><span class="s">&#39;blog&#39;</span><span class="p">)</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">ti2</span> <span class="o">=</span> <span class="n">TumbleItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Blog Post 2&#39;</span><span class="p">,</span> <span class="n">item_type</span><span class="o">=</span><span class="s">&#39;blog&#39;</span><span class="p">)</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">ti3</span> <span class="o">=</span> <span class="n">TumbleItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Blog Post 3&#39;</span><span class="p">,</span> <span class="n">item_type</span><span class="o">=</span><span class="s">&#39;blog&#39;</span><span class="p">)</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">ti4</span> <span class="o">=</span> <span class="n">TumbleItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Article Dugg 1&#39;</span><span class="p">,</span> <span class="n">item_type</span><span class="o">=</span><span class="s">&#39;digg&#39;</span><span class="p">)</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">ti5</span> <span class="o">=</span> <span class="n">TumbleItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Article Dugg 2&#39;</span><span class="p">,</span> <span class="n">item_type</span><span class="o">=</span><span class="s">&#39;digg&#39;</span><span class="p">)</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">ti6</span> <span class="o">=</span> <span class="n">TumbleItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Link Saved 1&#39;</span><span class="p">,</span> <span class="n">item_type</span><span class="o">=</span><span class="s">&#39;link&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>OK now that we&#8217;ve loaded some data, let&#8217;s use the group_by functionality!</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="pycon"><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span> <span class="o">=</span> <span class="n">TumbleItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">group_by</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;item_type&#39;</span><span class="p">]</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">item_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">item_type</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">item_types</span>
</span><span class="line"><span class="go">[u&#39;blog&#39;, u&#39;digg&#39;, u&#39;link&#39;]</span>
</span></code></pre></td></tr></table></div></figure><p>There we go, it&#8217;s quick, easy, and it seems to Just Work. But let&#8217;s try to grab
only the item_types which have more than one item:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="pycon"><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span> <span class="o">=</span> <span class="n">TumbleItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">group_by</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;item_type&#39;</span><span class="p">]</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">having</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;COUNT(item_type) &gt; 1&#39;</span><span class="p">]</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">item_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">item_type</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">item_types</span>
</span><span class="line"><span class="go">[u&#39;blog&#39;, u&#39;digg&#39;]</span>
</span></code></pre></td></tr></table></div></figure><p>And now we&#8217;ve successfully used the group_by and having functionality in the
Django ORM.  I&#8217;m excited for some aggregation functionality to start being
exposed as a public API, as I&#8217;m sure it will be more elegant than this solution,
but at the same time this is a neat hidden secret in the Django ORM.  Well now
you have the knowledge, so you have the power, and it&#8217;s up to you to use it wisely!</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/05/internet-immediate-danger-collapse/">The Internet Is in Immediate Danger of Collapse</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-05T21:38:48-08:00" pubdate data-updated="true">Nov 5<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Wow, that&#8217;s quite a title!  You&#8217;re already probably queuing up all of your
counterpoints and your rebuttals.  In fact it&#8217;s not quite that serious, but a
seriously worrying trend is emerging that I&#8217;d like to address.</p>
<div class="section" id="the-problem">
<h2>The Problem</h2>
<p>Today many sites are so totally dependent on 3rd-party services that when
certain services go down, a chain of outages end up knocking out many of the
sites that we use on a daily basis&#8211;some for critical business applications.
But I&#8217;m being too abstract, so let&#8217;s take a concrete example of this: Google
Analytics.</p>
<p>Back in late 2007, <a class="reference external" href="http://www.google.com/analytics">Google&#8217;s analytics and monitoring service</a> went
down with no explanation.  Most sites at that time had installed a line of
Javascript in their HTML <tt class="docutils literal">head</tt> element which made a call to
<tt class="docutils literal">document.write</tt>.  This causes the <strong>rest of the site to stop and wait for
Google&#8217;s servers</strong>.  Normally this is not a bad thing, because Google has some
pretty fast and reliable web servers.  But in this 24 hour period, anyone who
had this code in their <tt class="docutils literal">head</tt> element had an absolutely broken site.  Users
could not see their site at all.  And was no fault of either the site developers
or of the users&#8211;just Google&#8217;s fault.</p>
<p>Another example: Earlier this year, Amazon had an outage in their popular <a class="reference external" href="http://aws.amazon.com/s3/">S3</a>
file storage service for several hours.  At the time, you didn&#8217;t need to be very
tech savvy or know much about computers to know that something was seroiusly
wrong with the internet.  Sites from across the net were throwing 500 errors,
looking completely awful without their media files, and the internet simply
became a pretty awful place to get things done.  From one company.  Having a
problem with one service.</p>
<p>And since then we have become even more dependent on 3rd party services for
even more widgets, &quot;cloud computing&quot;, and more.  Frankly this &quot;cloud computing&quot;
craze scares the hell out of me.  The more interconnected our various bits of
HTML and HTTP are, the more chances there are for massive catastrophe.  Just
look at the credit default swaps problem we&#8217;re having in the USA for another
concrete example of how this type of interdependence can fail in catastrophic
ways.</p>
</div>
<div class="section" id="the-solution">
<h2>The Solution</h2>
<p>Services like S3, Google Analytics, and even Twitter are great services.  They
add lots of value for larger businesses and even more for a startup, so there&#8217;s
a large incentive to use them.  I think that&#8217;s absolutely fine and is actually
a good idea.  That being said, we need to manage our use of these services in a
responsible way.  Instead of storing data directly to S3, store it on a server
and asynchronously upload it to S3.  That way, you can set up an S3-pinger and
if it goes down you can have the server automatically switch to serving the
media itself.</p>
<p>We need to build standardized tools that fetch data from webservices locally,
from which they are served to the user.  We need to build systems that
asynchronously sync data bidirectionally from all of these different webservers
and ensure that the integrity of our data on the web is sound.  Right now this
is a tedious, and error-prone task, but we can do better.  We can build
cross-platform tools and libraries that will solve this problem, allow us to
use 3rd-party services, and rest sound knowing that tomorrow no matter what
happens to Amazon, the internet will still be around.</p>
<p>DISCLAIMER: This is almost entirely a ripoff of a talk given by <a class="reference external" href="TimothyFitz">Timothy Fitz</a>
at <a class="reference external" href="http://superhappydevhouse.org/">Super Happy Dev House</a> last month in San Francisco.  While I think it&#8217;s a
really good point I can&#8217;t take credit for having been the first to worry about
it.</p>
</div></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/04/why-sqlalchemy-best-orm-face-planet/">Why SQLAlchemy Is the Best ORM on the Face of the Planet</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-04T18:03:04-08:00" pubdate data-updated="true">Nov 4<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a class="reference external" href="http://www.sqlalchemy.org/">SQLAlchemy</a> started out with a bang.  When it came out, there was really nothing else out there that even came close in terms of features, performance, and ease of use.  <a class="reference external" href="http://www.sqlobject.org/">SQLObject</a> was the reigning champion of Python ORMs, and the Django ORM was around but much less powerful at that time.  So now it&#8217;s 3 years later.  Is SQLAlchemy still the best?  I think it is, and here&#8217;s why:</p>
<ol class="arabic simple">
<li>It has <em>no</em> preconception of how your database should be laid out.  If you haven&#8217;t created your database yet, you can choose to use the ActiveRecord-style layout of one object mapping to one table.  If that&#8217;s not the case for your application, you can even map arbitrary select statements onto objects, if that&#8217;s how much flexibility you want.  So already, SQLAlchemy is an option for thousands of people for which the other ORMs would not be.</li>
<li>It&#8217;s tuned for performance.  Whether it&#8217;s the extremely slick connection pooling feature, or whether it&#8217;s the <a class="reference external" href="http://www.sqlalchemy.org/docs/05/session.html#unitofwork">Unit of Work</a> design pattern which will issue as few queries as possible.  Whether it&#8217;s the ability to specify lazily or eagerly loaded columns, or whether you note the identity map which keeps track of all of the objects that are in memory, SQLAlchemy has lots of performance-tuning abilities.  In my mind, SQLAlchemy gives you all the tools that you need to create a blazing fast application.</li>
<li>It has a wonderful community which is building great tools on top of SQLAlchemy itself.  A clear example of this is the set of plugins that are shipped with SQLAlchemy, by default.  These include a simple <a class="reference external" href="http://www.sqlalchemy.org/docs/05/plugins.html#plugins_declarative">declarative</a> layer, an <a class="reference external" href="http://www.sqlalchemy.org/docs/05/plugins.html#plugins_associationproxy">association proxy</a>, and <a class="reference external" href="http://www.sqlalchemy.org/docs/05/plugins.html#plugins_sqlsoup">SqlSoup</a>, which uses introspection to map tables on the fly.  These are great examples of how the community is creating great libraries that sit on top of SQLAlchemy.  They also serve as proof of the configurability of the ORM itself.</li>
<li>It supports your database.  According to its own website, &quot;SQLAlchemy includes dialects for SQLite, Postgres, MySQL, Oracle, MS-SQL, Firebird, MaxDB, MS Access, Sybase and Informix; IBM has also released a DB2 driver.&quot;  This is a pretty massive list and goes a long way in proving the power of the ORM.</li>
</ol>
<p>It comes down to this.  SQLAlchemy is a well-designed, performant, widely supported ORM which treats SQL with the respect it deserves.  I haven&#8217;t provided any code samples here because you should do that yourselves, with your own apps.  It&#8217;s just that good.  So what are you waiting for?</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/03/database-triggers-arent-evil-and-they-actually-kin/">Database Triggers Aren&#8217;t Evil, and They Actually Kind of Rock</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-03T18:44:19-08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="section" id="who-says-they-suck">
<h2>Who says they suck?</h2>
<p>Nobody that I&#8217;ve seen has come out and actually said that they don&#8217;t like
database triggers, but at the same time, Python (Django) programmers like to
program in Python.  And PL/pgSQL certainly is not Python.  There&#8217;s a tendency to
do everything in Python&#8211;especially with the use of Django&#8217;s dispatcher.</p>
<p>But there&#8217;s some serious overhead with that approach, and roundtrips, and race
conditions, etc.  If you&#8217;re using a good database, there&#8217;s an alternative:
you guessed it, database triggers.</p>
</div>
<div class="section" id="let-s-set-up-some-models">
<h2>Let&#8217;s set up some models</h2>
<p>Here will be our models for the remainder of this post:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">Bookmark</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span class="line">    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">num_votes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">    <span class="n">score</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Vote</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="line">    <span class="n">bookmark</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Bookmark</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;votes&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">value</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure><p>As you can tell, we have a straightforward <tt class="docutils literal">Bookmark</tt> and <tt class="docutils literal">Vote</tt> models here.
But there are also two denormalized fields: <tt class="docutils literal">num_votes</tt>, and <tt class="docutils literal">score</tt>.</p>
</div>
<div class="section" id="doing-it-in-python">
<h2>Doing it in Python</h2>
<p>The advantage of doing this in Python is that it&#8217;s simple and Django supports
it out of the box.  Here&#8217;s how the code for that would look:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">signals</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">update_bookmark_aggregate</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">    <span class="n">bmark</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">bookmark</span>
</span><span class="line">    <span class="n">bmark</span><span class="o">.</span><span class="n">num_votes</span> <span class="o">=</span> <span class="n">bmark</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span class="line">    <span class="n">bmark</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bmark</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</span><span class="line">    <span class="n">bmark</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force_update</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="line"><span class="n">signals</span><span class="o">.</span><span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_bookmark_aggregate</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Vote</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>Very simply, every time a vote is saved, the <tt class="docutils literal">update_bookmark_aggregate</tt>
function is called which updates the bookmark with its new score and num_votes.</p>
</div>
<div class="section" id="doing-it-in-pl-pgsql">
<h2>Doing it in Pl/pgSQL</h2>
<p>Create a new file, named <tt class="docutils literal">management.py</tt> under your bookmarks app directory.
Its contents will be as follows:</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">signals</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">bookmarks</span> <span class="kn">import</span> <span class="n">models</span>
</span><span class="line">
</span><span class="line"><span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class="line"><span class="s">CREATE LANGUAGE plpgsql;</span>
</span><span class="line"><span class="s">CREATE OR REPLACE FUNCTION update_bookmark_aggregate_trigger()</span>
</span><span class="line"><span class="s">    RETURNS &quot;trigger&quot; AS &#39;</span>
</span><span class="line"><span class="s">    DECLARE</span>
</span><span class="line"><span class="s">        new_score INTEGER;</span>
</span><span class="line"><span class="s">        new_num_votes INTEGER;</span>
</span><span class="line"><span class="s">    BEGIN</span>
</span><span class="line"><span class="s">        SELECT COUNT(*) INTO STRICT new_num_votes FROM bookmarks_vote</span>
</span><span class="line"><span class="s">            WHERE bookmark_id = NEW.bookmark_id;</span>
</span><span class="line"><span class="s">        SELECT COALESCE(SUM(value), 0) INTO STRICT new_score FROM bookmarks_vote</span>
</span><span class="line"><span class="s">            WHERE bookmark_id = NEW.bookmark_id;</span>
</span><span class="line"><span class="s">    UPDATE bookmarks_bookmark</span>
</span><span class="line"><span class="s">        SET</span>
</span><span class="line"><span class="s">            score = new_score,</span>
</span><span class="line"><span class="s">            num_votes = new_num_votes</span>
</span><span class="line"><span class="s">        WHERE id = NEW.bookmark_id;</span>
</span><span class="line"><span class="s">    RETURN NEW;</span>
</span><span class="line"><span class="s">    END;&#39; LANGUAGE &#39;plpgsql&#39; VOLATILE;</span>
</span><span class="line">
</span><span class="line"><span class="s">CREATE TRIGGER update_bookmark_aggregate_trigger AFTER INSERT OR UPDATE</span>
</span><span class="line"><span class="s">    ON bookmarks_vote FOR EACH ROW</span>
</span><span class="line"><span class="s">    EXECUTE PROCEDURE update_bookmark_aggregate_trigger();</span>
</span><span class="line"><span class="s">&quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">create_trigger</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">created_models</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">    <span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
</span><span class="line">    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span class="line">    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span><span class="line"><span class="n">signals</span><span class="o">.</span><span class="n">post_syncdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">create_trigger</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">models</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure><p>In this file we have declared two variables, <tt class="docutils literal">new_score</tt>, and
<tt class="docutils literal">new_num_votes</tt>.  We do two queries to get the aggregate data.  And then we
update the bookmark to reflect the new aggregated values.  This script is
executed once when the bookmarks models are first loaded into the database, and
we&#8217;re all set!</p>
</div>
<div class="section" id="let-s-see-how-it-works">
<h2>Let&#8217;s see how it works</h2>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="pycon"><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">bookmarks.models</span> <span class="kn">import</span> <span class="n">Bookmark</span><span class="p">,</span> <span class="n">Vote</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">Bookmark</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Blog&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s">&#39;http://eflorenzano.com/&#39;</span><span class="p">)</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">num_votes</span>
</span><span class="line"><span class="go">0</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">score</span>
</span><span class="line"><span class="go">0</span>
</span><span class="line"><span class="go"># There is no aggregate data yet</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">Vote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bookmark</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line"><span class="go">&lt;Vote: Vote object&gt;</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">Vote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bookmark</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span class="line"><span class="go">&lt;Vote: Vote object&gt;</span>
</span><span class="line"><span class="go"># We need to re-query for the bookmark, due to no identity map in Django.</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">Bookmark</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">num_votes</span>
</span><span class="line"><span class="go">2</span>
</span><span class="line"><span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">score</span>
</span><span class="line"><span class="go">3</span>
</span></code></pre></td></tr></table></div></figure><p>Voila!  This was all done in the database behind the scenes.  Very cool, very
fast, and it kind of rocks.</p>
</div></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/5/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/3/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/02/16/technology-behind-convore/">The Technology Behind Convore</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/10/10/object-lesson-how-respond-criticism/">An Object Lesson in How to Respond to Criticism</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/09/27/why-node-disappoints-me/">Why node.js disappoints me</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/05/20/we-need-new-word-open/">We need a new word for &#8220;Open&#8221;</a>
      </li>
    
      <li class="post">
        <a href="/blog/2010/02/08/how-do-we-kick-our-synchronous-addiction/">How do we kick our synchronous addiction?</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("ericflo", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/ericflo" class="twitter-follow-button" data-show-count="false">Follow @ericflo</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/109591387819364984777?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Eric Florenzano -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
