
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title></title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <link href="/atom.xml" rel="alternate" title="Eric Florenzano's Blog" type="application/atom+xml">

    <link href="/static/css/bootstrap.css" rel="stylesheet">
    <link href="/static/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/static/css/code.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/static/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    
  </head>

  <body>
    <div class="container">
      <div class="center-column">
        <h1 class="blog-header"><a href="/">Eric Florenzano&rsquo;s Blog</a></h1>
        <ul class="blog-header-links">
          <li>Home</li>
          <li><a href="/blog/archives/">Archives</a></li>
          <li><a href="https://twitter.com/ericflo" class="twitter-follow-button" data-show-count="false">Follow @ericflo</a></li>
          <li class="feed"><a href="/atom.xml"><img src="/static/img/feed-icon-28x28.png" width="20" height="20" alt="Subscribe to this blog" /></a></li>
        </ul>
        

  <h3><a href="/blog/2014/04/09/react-part-1-project-structure/">Server/Client With React, Part 1: Getting Started</a></h3>
<p class="datetime">Apr 09, 2014</p>
<div class="document">
<p>A few months ago <a class="reference external" href="http://eflorenzano.com/blog/2014/01/23/react-finally-server-client">I wrote about</a> how React.js has made it possible (and
relatively easy) to write code that renders markup quickly on the server, and
also can be executed on the client to perform all page updates.  Now that we
know what the goal is, we can explore how to put all these pieces together, or
how I've managed to do it anyway.</p>
<div class="section" id="let-s-build-something">
<h4>Let's Build Something!</h4>
<p>It's easiest to talk about concepts if we can also work on something concrete,
so in the next few posts we'll build a little example site called IRLMoji,
which asks users to post pictures that look like emoji.  All credit goes to
<a class="reference external" href="https://twitter.com/dwiskus">&#64;dwiskus</a> for originally starting this <a class="reference external" href="http://betterelevation.com/irlmoji/">meme on Twitter</a>.  But we're going
to turn it into its own app for demo purposes, which will look something like
this:</p>
<a class="reference external image-reference" href="https://www.irlmoji.com/"><img alt="A screenshot of what we are building" src="http://eflorenzano.com.s3-us-west-2.amazonaws.com/irlmoji-screenshot.jpg" style="width: 200px;" /></a>
<p>It's definitely not pretty (sorry), but it's got all the stuff we need to learn
about React including auth, content creation, server communication, integration
with third-party JS libraries, etc.  If you'd like to follow along and see the
code for the finished site, it's all up on GitHub:
<a class="reference external" href="https://github.com/ericflo/irlmoji">https://github.com/ericflo/irlmoji</a>.</p>
</div>
<div class="section" id="let-s-begin">
<h4>Let's Begin</h4>
<p>There will be two entry points to our app: <tt class="docutils literal">server.js</tt>, which will sit at the
project's top level, and <tt class="docutils literal">frontend/javascript/client.js</tt>.  Let's start with
the client, because it's a bit simpler.  First let's start small and build a
<tt class="docutils literal">render()</tt> function, which will take a React component and some options, and
render it to the page:</p>
<pre class="code js literal-block">
<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">reactComp</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{</span><span class="p">};</span>
  <span class="kd">var</span> <span class="nx">elt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'react-root'</span><span class="p">);</span>
  <span class="nx">React</span><span class="p">.</span><span class="nx">renderComponent</span><span class="p">(</span><span class="nx">reactComp</span><span class="p">,</span> <span class="nx">elt</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<p>All we're doing here is calling <tt class="docutils literal">React.renderComponent</tt> on the component that
was passed in, rendering the component into that <cite>#react-root</cite> DOM element.
We'll end up making this function do a bit more work in a future post, but for
now let's move on to writing some handlers, and hooking them up to URL routes.</p>
<p>In the past I've used <a class="reference external" href="https://github.com/flatiron/director">director</a> to handle URL routing, but eventually I wrote
<a class="reference external" href="https://github.com/ericflo/irlmoji/blob/master/frontend/javascript/router.js">a small router</a> which escews <a class="reference external" href="http://www.webmonkey.com/2011/02/gawker-learns-the-hard-way-why-hash-bang-urls-are-evil/">hashbang-style</a> URLs in favor of HTML5
pushState.  If needed, we can always fall back to full page reloads, rather
than resort to hashbangs.  Now we've got this router to work with, let's put it
to use, starting with a new file at <tt class="docutils literal">frontend/javascript/routes.js</tt>:</p>
<pre class="code as literal-block">
<span class="cm">/** &#64;jsx React.DOM */</span>

<span class="c1">// Lodash is a fast/light underscore replacement that works better for me
</span><span class="k">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'lodash/dist/lodash.underscore'</span><span class="p">);</span>
<span class="k">var</span> <span class="nx">common</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./components/common'</span><span class="p">);</span>

<span class="c1">// Renders the index page, for now just &quot;Hello, World!&quot;
</span><span class="kd">function</span> <span class="nx">handleIndex</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="o">,</span> <span class="nx">World</span><span class="o">!&lt;/</span><span class="nx">p</span><span class="o">&gt;,</span> <span class="p">{</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">'Welcome'</span><span class="o">,</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Prepares a handler for use. For now all we're doing is making sure
// that 'app' is passed as the first argument to the handler function.
</span><span class="kd">function</span> <span class="nx">prepareHandler</span><span class="p">(</span><span class="nx">app</span><span class="o">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">partial</span><span class="p">(</span><span class="nx">handler</span><span class="o">,</span> <span class="nx">app</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Gets a list of routes to be passed to the router
</span><span class="kd">function</span> <span class="nx">getRoutes</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'/'</span><span class="o">,</span> <span class="nx">prepareHandler</span><span class="p">(</span><span class="nx">app</span><span class="o">,</span> <span class="nx">handleIndex</span><span class="p">)]</span>
  <span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Gets a function that should be called when no routes match
</span><span class="kd">function</span> <span class="nx">getNotFound</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// At the time this post was written, JSX does not allow namespacing,
</span>    <span class="c1">// so we need to grab a reference to the NotFound component class.
</span>    <span class="k">var</span> <span class="nx">NotFound</span> <span class="o">=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">NotFound</span><span class="o">;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">NotFound</span> <span class="o">/&gt;,</span> <span class="p">{</span><span class="nx">statusCode</span><span class="o">:</span> <span class="mi">404</span><span class="p">});</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">getRoutes</span><span class="o">:</span> <span class="nx">getRoutes</span><span class="o">,</span>
  <span class="nx">getNotFound</span><span class="o">:</span> <span class="nx">getNotFound</span>
<span class="p">};</span>
</pre>
<p>&quot;Wait a minute,&quot; you may be thinking.  What is this <tt class="docutils literal">app</tt> thing that every
function seems to refer to?  The <tt class="docutils literal">app</tt> is what I've chosen to call the object
that is used to tie everything together.  It's because of this object that
we're able to use one codebase for both server and client.  Right now all we're
using is the <tt class="docutils literal">render</tt> function that we created earlier, but through the
interface of this <tt class="docutils literal">app</tt> object.  Let's go back to <tt class="docutils literal">client.js</tt> and create
a basic app object.</p>
<pre class="code js literal-block">
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">render</span><span class="o">:</span> <span class="nx">render</span><span class="p">,</span>
  <span class="nx">isServer</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">getUrl</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">''</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">getPath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre>
<p>Here we've got a basic <tt class="docutils literal">app</tt> object, with access to a render function and a
few helpers like the ability to get the current path or get the full URL or to
detect whether we're on the server or the client.  We're building this in
<tt class="docutils literal">client.js</tt>, so we know we're not on the server, and can just return false.</p>
<p>Now that we have our app, and our routes, let's tie them together:</p>
<pre class="code js literal-block">
<span class="c1">// Import the routes we created earlier
</span><span class="kd">var</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./routes'</span><span class="p">);</span>
<span class="c1">// ...and the simple router we're using
</span><span class="kd">var</span> <span class="nx">makeRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./router'</span><span class="p">).</span><span class="nx">makeRouter</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="nx">makeRouter</span><span class="p">(</span><span class="nx">routes</span><span class="p">.</span><span class="nx">getRoutes</span><span class="p">(</span><span class="nx">app</span><span class="p">),</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">getNotFound</span><span class="p">(</span><span class="nx">app</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="p">);</span>
</pre>
<p>To finish up this part, we still have to create that NotFound React component,
so let's create a new file in <tt class="docutils literal">frontend/javascript/components/common.js</tt> with
this as its content:</p>
<pre class="code as literal-block">
<span class="cm">/** &#64;jsx React.DOM */</span>

<span class="k">var</span> <span class="nx">React</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'react/addons'</span><span class="p">);</span>

<span class="k">var</span> <span class="nx">NotFound</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">That</span> <span class="nx">page</span> <span class="nx">could</span> <span class="nx">not</span> <span class="nx">be</span> <span class="nx">found</span><span class="p">.</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span><span class="nx">NotFound</span><span class="o">:</span> <span class="nx">NotFound</span><span class="p">};</span>
</pre>
</div>
<div class="section" id="what-s-next">
<h4>What's Next?</h4>
<p>It would be great if we could fire up our browsers now and see in action what
we've built so far.  Unfortunately, however, we haven't built the server yet.
Here are some of the high level things that we're going to cover next:</p>
<ul class="simple">
<li>Set up <a class="reference external" href="http://gulpjs.com/">Gulp</a> and <a class="reference external" href="http://browserify.org/">Browserify</a> to compile our node JavaScript into Browser JS</li>
<li>Write the <tt class="docutils literal">server.js</tt> that mimics the <tt class="docutils literal">client.js</tt> we've been building and
acts as http server.</li>
<li>Build the communications layer between the frontend and the API</li>
<li>Ensure that the client re-uses the same data the server used when it rendered</li>
<li>Oh yeah, write our app :)</li>
</ul>
</div>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/react/">React</a></li>
      
        <li><a href="/blog/categories/reactjs/">ReactJS</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/server/">Server</a></li>
      
        <li><a href="/blog/categories/client/">Client</a></li>
      
        <li><a href="/blog/categories/javascript/">Javascript</a></li>
      
    </ul>
  </div>
  <hr />

  <h3><a href="/blog/2014/01/23/react-finally-server-client/">React: Finally, a great server/client web stack</a></h3>
<p class="datetime">Jan 23, 2014</p>
<div class="document">
<p>We started with static websites, simple pages that could link between each
other.  Then we started constructing those pages on demand, customizing the
contents of the page for each individual user.  Next we started using
Javascript to add more interactivity, and these pages started to become more
like applications.  But now we have XMLHttpRequest, and most new projects are
moving towards building their pages entirely in the browser.</p>
<p>But when we do it purely in the browser, we have to make quite a few
concessions: search engines have a hard time indexing that content, for
example. It also takes longer for users to see the rendered content (not in
every case, but in many, many cases.)  Also if you're using a lot of plugins
for your favorite library, or a heavyweight MVC framework, sometimes it can
slow down interactivity.</p>
<p>I've thought for a long time (<a class="reference external" href="http://eflorenzano.com/blog/2010/09/27/why-node-disappoints-me/">and blogged about it previously</a>) that the
ideal solution would fully render the markup on the server, deliver it to the
client so that it can be shown to the user instantly.  Then it would
asynchronously load some Javascript that would attach to the rendered markup,
and invisibly promote the page into a full app that can render its own markup.
This code would also have to be fast enough to meet or exceed the performance
of other modern solutions, or it won't be worth it.</p>
<p>What I've discovered is that enough of the pieces have come together, that this
futuristic-sounding web environment is actually surprisingly easy to do now
with <a class="reference external" href="http://facebook.github.io/react/">React.js</a>.  React isn't a full-fledged framework, it's a library, so
you'll have to build your own foundation and write some glue code.  I've been
rewriting an existing website in React (usually a terrible idea, we'll see
about this time), and now that the code is settling down a little bit, I'd like
to share how it works.  This post will just be an overview, but up next I'll
share some of my glue code and lessons learned etc.</p>
<div class="section" id="react-js">
<h4><a class="reference external" href="http://facebook.github.io/react/">React.js</a></h4>
<p>First, a bit about React.  It was released by Facebook and was apparently a
collaboration between the Instagram and Facebook web engineers.  It looks
similar in shape but not in size to Angular.js, but even though it looks
similar, it has a very different philosophy underneath.  React has a few key
ideas: a virtual DOM, a component framework, and a Javascript syntax extension.</p>
<div class="section" id="virtual-dom">
<h2>Virtual DOM</h2>
<p>The key innovation of React is that it has a pure-Javascript reimplementation
of the browser's DOM.  It builds the DOM tree in Javascript and then has two
options for output: a root browser element, or a string.  How can it output
to a root browser element without having horrible performance?  Core to React
is a tree diffing algorithm that can look at the in-memory virtual DOM, and the
real browser DOM, and build the optimal diff.  Then it applies that diff to the
browser's DOM.</p>
<p>The second option for output is equally interesting to me though.  If you can
walk this virtual DOM tree and render to a string, then you can do that all
on the server and then send it down to the client.  And since it's a tree,
React simply stores a checksum in a data attribute on the root node, and if
those checksums match, then React will simply attach its event handlers and do
nothing more.</p>
</div>
<div class="section" id="component-framework">
<h2>Component Framework</h2>
<p>React's component framework is how you construct that virtual DOM.  Each
component has a <tt class="docutils literal">render()</tt> function which returns a virtual DOM node with any
number of children and event handlers attached.  So at its core, React
components are widgets that can render themselves and react to user input.  At
render time, components should only access two instance objects: <tt class="docutils literal">props</tt>, and
<tt class="docutils literal">state</tt>.</p>
<p>Props are passed-in and are immutable, whereas state is assigned and updated
entirely by the component itself.  Callback functions can be passed from parent
node to child node, as <tt class="docutils literal">props</tt>, and attached directly to the virtual DOM
nodes in the <tt class="docutils literal">render()</tt> function.  In fact, that's the primary way that
components communicate with each other.</p>
<p>These components have a lifecycle, and ways to hook into state and prop
changes.  They also support mixins, which can hook into the component lifecycle
and take care of things easily, like canceling timers when a component is
removed from the DOM, for example.</p>
</div>
<div class="section" id="jsx-a-javascript-syntax-extension">
<h2>JSX (A Javascript syntax extension)</h2>
<p>JSX lets you write components without pulling your hair out.  Instead of
writing tedious code like this:</p>
<pre class="code js literal-block">
<span class="nx">React</span><span class="p">.</span><span class="nx">DOM</span><span class="p">.</span><span class="nx">a</span><span class="p">(</span><span class="p">{</span><span class="nx">href</span><span class="o">:</span> <span class="s1">'/about'</span><span class="p">},</span> <span class="s1">'About this site'</span><span class="p">)</span>
</pre>
<p>It allows you to just write this right alongside your javascript:</p>
<pre class="code html literal-block">
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/about&quot;</span><span class="nt">&gt;</span>About this site<span class="nt">&lt;/a&gt;</span>
</pre>
<p>The transformer is smart enough to not need any special indicators about where
the markup blocks are, but it also allows you to drop into Javascript, like
so:</p>
<pre class="code html literal-block">
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">{this.props.aboutUrl}</span><span class="nt">&gt;</span>About this site<span class="nt">&lt;/a&gt;</span>
</pre>
<p>You can choose not to use this, but after getting over my initial distaste for
it (&quot;Ack! Who got markup in my code!&quot;), I could never go back to not using it.</p>
</div>
<div class="section" id="next">
<h2>Next</h2>
<p>In a future post, I'll talk about all the other parts you'll need to pull in to
build a fuller framework for your site.</p>
<ul class="simple">
<li>HTTP middleware and server (<a class="reference external" href="http://www.senchalabs.org/connect/">Connect</a>)</li>
<li>API client (<a class="reference external" href="http://visionmedia.github.io/superagent/">Superagent</a> and optionally <a class="reference external" href="https://github.com/nodejitsu/node-http-proxy">node-http-proxy</a>)</li>
<li>URL routing (<a class="reference external" href="https://github.com/flatiron/director">Director</a>)</li>
<li>Asset management</li>
<li>Interfacing with legacy Javascript</li>
<li>Useful mixins for components</li>
</ul>
<p>Also, I'm not sure if this is interesting for anyone else other than myself, so
let me know if I should post that stuff, or any other feedback.  I'm always
yapping on Twitter, so <a class="reference external" href="https://twitter.com/ericflo">catch me over there</a>!</p>
</div>
</div>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/react/">React</a></li>
      
        <li><a href="/blog/categories/reactjs/">ReactJS</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/server/">Server</a></li>
      
        <li><a href="/blog/categories/client/">Client</a></li>
      
        <li><a href="/blog/categories/javascript/">Javascript</a></li>
      
    </ul>
  </div>
  <hr />

  <h3><a href="/blog/2013/07/01/fix-it/">So fix it!</a></h3>
<p class="datetime">Jul 01, 2013</p>
<div class="document">
<p>&quot;Uhh, why is this single controller method 500 lines of code?&quot; - Me, a few
months into my first job after college.  I remember saying it out loud,
expecting to hear a faint chuckle from my co-workers, as if it were a joke. &quot;We
should really break this up into smaller functions,&quot; I said, confident that I
was right.</p>
<p>What <a class="reference external" href="https://twitter.com/donovanpreston">my coworker</a> said in response surprised me in the best possible way, and
what I learned then is something I still remind myself of to this day.  He
said, &quot;You're right, that's too long. So fix it!&quot;  I responded with, &quot;yeah, we
really should.&quot;  To which he responded, &quot;You are one of us, so fix it!&quot;</p>
<p>This became somewhat of a refrain.  Someone would complain about something and
another person would shout back at them, &quot;So fix it!&quot;</p>
<p>It's interesting how easy it is for us to associate with a group so strongly
that it becomes part of our identity--part of who we are--yet in some
situations it's easy to diffuse that responsibility and dismiss it as not being
our own.</p>
<p>But, of course, he was right--I was one of &quot;we&quot;, and &quot;we&quot; should fix it,
so I should fix it!  If you're running a small startup with just a few people,
this mentality is easy to have.  There are so few people contributing that you
don't have much choice in the matter.</p>
<p>As a company grows, people start to specialize, to carve out their area, and to
take some ownership.  This can be a good thing!  By allowing people to
specialize, and hiring more people, we can build something bigger.  But
everyone's still in it together, and the individual is still part of &quot;we&quot;.  If
you ever find yourself thinking &quot;that's not my job,&quot; then it's a red flag that
you've let things go too far.</p>
<p>All this being said, you have to find a balance.  You can't fix every code
smell you find, or you'd never get anything done.  In fact there may be code
that you recognize as bad, but you just don't have the knowledge or resources
to fix it.  That's just the name of the game, and that's fine, but you also
can't fix nothing, or your tech debt will grow unbounded and that will end in
disaster as well.</p>
<p>Anyway, it's been almost a year since I made the jump from working at
<a class="reference external" href="http://www.crunchbase.com/company/clutch-io">a company of 2</a>, to working at a company that's <a class="reference external" href="https://twitter.com">much much larger</a>, and this
early lesson is one thing that I often find myself thinking and reminding
myself of.</p>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/opinion/">Opinion</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/maintenance/">Maintenance</a></li>
      
    </ul>
  </div>
  <hr />

  <h3><a href="/blog/2012/04/18/using-twitter-ios5-integration-single-sign-on/">Using Twitter&#39;s iOS5 Integration for Single Sign-On</a></h3>
<p class="datetime">Apr 18, 2012</p>
<div class="document">
<p>Apple has included integration with Twitter in iOS5, which can be really handy to allow your users to easily tweet or log in. The only problem is that, as far as documentation of this feature is concerned, you're largely on your own. This blog post is an attempt to correct that, at least in the case of sign-on.</p>
<div class="section" id="add-the-twitter-and-accounts-libraries-to-your-project">
<h4>Add the Twitter and Accounts libraries to your project</h4>
<p>Click on your project file, and then on your build target. Make sure you're on the &quot;build phases&quot; tab. Under the &quot;Link Binary With Libraries&quot; section, click the plus symbol to the bottom left, and search for <tt class="docutils literal">Accounts.framework</tt> and add it. Then do the same for <tt class="docutils literal">Twitter.framework</tt>. This will link all of the necessary libraries into your project so that we can use the Twitter integration.</p>
</div>
<div class="section" id="requesting-access-to-a-user-s-twitter-account">
<h4>Requesting access to a user's twitter account</h4>
<p>The first thing to do when you want to let a user sign-on with Twitter is to create a long-lived (save it as an instance variable, for example) instance of ACAccountStore and request access to the Twitter accounts contained within:</p>
<pre class="code objc literal-block">
<span class="n">ACAccountStore</span> <span class="o">*</span><span class="n">store</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ACAccountStore</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span> <span class="c1">// Long-lived
</span><span class="n">ACAccountType</span> <span class="o">*</span><span class="n">twitterType</span> <span class="o">=</span> <span class="p">[</span><span class="n">store</span> <span class="nl">accountTypeWithAccountTypeIdentifier:</span><span class="n">ACAccountTypeIdentifierTwitter</span><span class="p">];</span>
<span class="p">[</span><span class="n">store</span> <span class="nl">requestAccessToAccountsWithType:</span><span class="n">twitterType</span> <span class="nl">withCompletionHandler:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">granted</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">granted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Access has been granted, now we can access the accounts
</span>    <span class="p">}</span>
    <span class="c1">// Handle any error state here as you wish
</span><span class="p">}];</span>
</pre>
<p>What do we do once we have access to the accounts? Well, we get a list of 'em. If they don't have any accounts, then we can show a dialog asking them to connect one in the iOS settings app:</p>
<pre class="code objc literal-block">
<span class="c1">// Remember that twitterType was instantiated above
</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">twitterAccounts</span> <span class="o">=</span> <span class="p">[</span><span class="n">store</span> <span class="nl">accountsWithType:</span><span class="n">twitterType</span><span class="p">];</span>

<span class="c1">// If there are no accounts, we need to pop up an alert
</span><span class="k">if</span><span class="p">(</span><span class="n">twitterAccounts</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">twitterAccounts</span> <span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UIAlertView</span> <span class="o">*</span><span class="n">alert</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIAlertView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTitle:</span><span class="s">&#64;&quot;No Twitter Accounts&quot;</span>
                                                    <span class="nl">message:</span><span class="s">&#64;&quot;There are no Twitter accounts configured. You can add or create a Twitter account in Settings.&quot;</span>
                                                   <span class="nl">delegate:</span><span class="nb">nil</span>
                                          <span class="nl">cancelButtonTitle:</span><span class="s">&#64;&quot;OK&quot;</span>
                                          <span class="nl">otherButtonTitles:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">[</span><span class="n">alert</span> <span class="n">show</span><span class="p">];</span>
    <span class="p">[</span><span class="n">alert</span> <span class="n">release</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">ACAccount</span> <span class="o">*</span><span class="n">account</span> <span class="o">=</span> <span class="p">[</span><span class="n">twitterAccounts</span> <span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
    <span class="c1">// Do something with their Twitter account
</span><span class="p">}</span>
</pre>
</div>
<div class="section" id="now-what">
<h4>Now what?</h4>
<p>Well, now you have an access token to read some information about the user from their Twitter stream. The vast majority of apps will just want to grab the user's basic info to get things like a username, real name, and maybe their location. Here's how that would look:</p>
<pre class="code objc literal-block">
<span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">&#64;&quot;http://api.twitter.com/1/account/verify_credentials.json&quot;</span><span class="p">];</span>
<span class="n">TWRequest</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TWRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL:</span><span class="n">url</span>
                                     <span class="nl">parameters:</span><span class="nb">nil</span>
                                  <span class="nl">requestMethod:</span><span class="n">TWRequestMethodGET</span><span class="p">];</span>

<span class="c1">// Important: attach the user's Twitter ACAccount object to the request
</span><span class="n">req</span><span class="p">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">account</span><span class="p">;</span>

<span class="p">[</span><span class="n">req</span> <span class="nl">performRequestWithHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="n">responseData</span><span class="p">,</span>
                                 <span class="n">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">urlResponse</span><span class="p">,</span>
                                 <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// If there was an error making the request, display a message to the user
</span>    <span class="k">if</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UIAlertView</span> <span class="o">*</span><span class="n">alert</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIAlertView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTitle:</span><span class="s">&#64;&quot;Twitter Error&quot;</span>
                                                        <span class="nl">message:</span><span class="s">&#64;&quot;There was an error talking to Twitter. Please try again later.&quot;</span>
                                                       <span class="nl">delegate:</span><span class="nb">nil</span>
                                              <span class="nl">cancelButtonTitle:</span><span class="s">&#64;&quot;OK&quot;</span>
                                              <span class="nl">otherButtonTitles:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="p">[</span><span class="n">alert</span> <span class="n">show</span><span class="p">];</span>
        <span class="p">[</span><span class="n">alert</span> <span class="n">release</span><span class="p">];</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Parse the JSON response
</span>    <span class="n">NSError</span> <span class="o">*</span><span class="n">jsonError</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="kt">id</span> <span class="n">resp</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData:</span><span class="n">responseData</span>
                                                      <span class="nl">options:</span><span class="mi">0</span>
                                                        <span class="nl">error:</span><span class="o">&amp;</span><span class="n">jsonError</span><span class="p">];</span>

    <span class="c1">// If there was an error decoding the JSON, display a message to the user
</span>    <span class="k">if</span><span class="p">(</span><span class="n">jsonError</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UIAlertView</span> <span class="o">*</span><span class="n">alert</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIAlertView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTitle:</span><span class="s">&#64;&quot;Twitter Error&quot;</span>
                                                        <span class="nl">message:</span><span class="s">&#64;&quot;Twitter is not acting properly right now. Please try again later.&quot;</span>
                                                       <span class="nl">delegate:</span><span class="nb">nil</span>
                                              <span class="nl">cancelButtonTitle:</span><span class="s">&#64;&quot;OK&quot;</span>
                                              <span class="nl">otherButtonTitles:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="p">[</span><span class="n">alert</span> <span class="n">show</span><span class="p">];</span>
        <span class="p">[</span><span class="n">alert</span> <span class="n">release</span><span class="p">];</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">NSString</span> <span class="o">*</span><span class="n">screenName</span> <span class="o">=</span> <span class="p">[</span><span class="n">resp</span> <span class="nl">objectForKey:</span><span class="s">&#64;&quot;screen_name&quot;</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">fullName</span> <span class="o">=</span> <span class="p">[</span><span class="n">resp</span> <span class="nl">objectForKey:</span><span class="s">&#64;&quot;name&quot;</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">location</span> <span class="o">=</span> <span class="p">[</span><span class="n">resp</span> <span class="nl">objectForKey:</span><span class="s">&#64;&quot;location&quot;</span><span class="p">];</span>

    <span class="c1">// Make sure to perform our operation back on the main thread
</span>    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
        <span class="c1">// Do something with the fetched data
</span>    <span class="p">});</span>
<span class="p">}];</span>
</pre>
<p>Most of the code here is actually error handling code. The meat of what we're doing is simply fetching the user's credentials from Twitter, parsing the JSON, and doing something with it. (What exactly you want to do with the username and name data is left as an excercise for the reader.)</p>
</div>
<div class="section" id="that-s-it">
<h4>That's it?</h4>
<p>Yep, that's it. You should be able to implement Twitter sign-on for your app with the simple code I've shown here. The only bummer is the case when the user doesn't have a Twitter account registered. We're <a class="reference external" href="http://stackoverflow.com/questions/10055853/opening-ios-settings-preferences">not allowed</a> to help the user out by sending them to the Settings app. All we can do is tell users to go there and hope they can figure it out.</p>
<p>Any other tips or tricks you have for implementing sign-on with Twitter on iOS? Be sure to <a class="reference external" href="http://twitter.com/ericflo">tweet me</a> about it!</p>
<p>P.S. If you're building mobile apps, my startup <a class="reference external" href="https://clutch.io/">clutch.io</a> can help you build and iterate faster on them. Check us out :)</p>
</div>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/login/">Login</a></li>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/registration/">Registration</a></li>
      
        <li><a href="/blog/categories/sign-on/">Sign-On</a></li>
      
        <li><a href="/blog/categories/twitter/">Twitter</a></li>
      
        <li><a href="/blog/categories/ios/">iOS</a></li>
      
    </ul>
  </div>
  <hr />

  <h3><a href="/blog/2012/01/02/reducing-code-nesting/">Reducing Code Nesting</a></h3>
<p class="datetime">Jan 02, 2012</p>
<div class="document">
<p>&quot;This guy's code sucks!&quot;  It's something we've all said or thought when we run
into code we don't like.  Sometimes it's because it's buggy, sometimes it's
because it conforms to a style we don't like, and sometimes it's because it
just feels wrong.  Recently I found myself thinking this, and automatically
jumping to the conclusion that the developer who wrote it was a novice.  The
code had a distinct property that I dislike: lots of nesting.  But the more I
think about it, the more I realized that it's not really something I've heard
discussed much.</p>
<p>So let's talk about it.  I'm going to first talk about what I mean by nesting,
why I think it's a bad quality, and then I'm going to go over some tricks I've
learned over the years to reduce it.</p>
<div class="section" id="what-do-i-mean-by-code-nesting-and-why-is-it-bad">
<h4>What do I mean by code nesting, and why is it bad?</h4>
<p>It's easier to demonstrate rather than talk about it.  This is what I mean by
deep code nesting, with my apologies for the contrived example:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">get_cached_user</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Returns a cached user object either by their user_id or by their username.
    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_user_by_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_by_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">'User not found'</span><span class="p">)</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">set_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span>
</pre>
<p>You can see in this Python code just by looking at the indentation level that
there's lots of nesting.  Before we can determine that the user was not found,
we must pass through four conditionals, and each conditional is nested within
the previous conditional.</p>
<p>I argue that this is bad code.  Every added level of nesting is another piece
of context that your brain has to keep track of.  Each nested block is one you
have to line up by eye to see what conditional it lines up with (even if your
editor helps at this with visuals, it doesn't remove the issue entirely.)  And
this is just a straightforward example where we just return the user at the
end, let's take a look at an example that does something more complicated:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">get_media_details</span><span class="p">(</span><span class="n">media</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;
    Returns a dictionary of extra data about the given media object.
    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">media</span><span class="o">.</span><span class="n">is_video</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s">'kind'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'video'</span>
        <span class="k">if</span> <span class="n">media</span><span class="o">.</span><span class="n">is_youtube</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">'url'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'http://youtube.com/'</span>
        <span class="k">if</span> <span class="n">media</span><span class="o">.</span><span class="n">is_vimeo</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">'vimeo'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">media</span><span class="o">.</span><span class="n">vimeo_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s">'url'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'http://vimeo.com/v2/'</span>
        <span class="k">if</span> <span class="s">'url'</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">'secure_url'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'url'</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'http:'</span><span class="p">,</span> <span class="s">'https:'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">media</span><span class="o">.</span><span class="n">is_audio</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s">'kind'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'audio'</span>
    <span class="k">elif</span> <span class="n">media</span><span class="o">.</span><span class="n">is_text</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s">'kind'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'text'</span>
    <span class="k">if</span> <span class="s">'kind'</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s">'kind_verbose'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'video'</span><span class="p">:</span> <span class="s">'Video Stream'</span><span class="p">,</span>
            <span class="s">'audio'</span><span class="p">:</span> <span class="s">'Audio File'</span><span class="p">,</span>
            <span class="s">'text'</span><span class="p">:</span> <span class="s">'Text Content'</span><span class="p">,</span>
        <span class="p">}[</span><span class="n">data</span><span class="p">[</span><span class="s">'kind'</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">data</span>
</pre>
<p>It was unbelievably hard for me to even write that last example.  It's
obviously contrived and such, but the point is that it's so difficult to
even understand what it's doing.  Unlike the previous example, this doesn't
simply nest and then return; it nests and then un-nests, and then nests again,
and then finally returns.</p>
</div>
<div class="section" id="how-to-avoid-nesting">
<h4>How to Avoid Nesting</h4>
<p>The best way that I've discovered to avoid nesting is to return early.  Caching
is the perfect example of this.  Instead of testing for a cache failure and
fetching from the database inside the conditional, check for cache success and
return that early.</p>
<p>So this code:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">get_cached_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="c"># The main logic all happens in this nested block</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">set_user_for_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span>
</pre>
<p>Becomes this:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">get_cached_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span>
    <span class="c"># The main logic happens outside of the nested block</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set_user_for_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span>
</pre>
<p>In the simple case, it doesn't seem to improve much, but what happens if we
apply this technique to our first example?  It's dramatically improved:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">get_cached_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
    <span class="c"># First check the cache by id</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="c"># Now check the cache by username</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_user_by_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="c"># Both caches failed, so try hitting the db for the id</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">set_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="c"># Looks like that didn't exist, try the username</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_user_by_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">'User not found'</span><span class="p">)</span>

    <span class="c"># Cache our final user value for future use</span>
    <span class="n">cache</span><span class="o">.</span><span class="n">set_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span>
</pre>
<p>Not only does it make it easier to read top-to-bottom, and force us to keep
track of way less context, and make our code editors do less line wrapping,
but it also makes it easier to separate the blocks of code and more easily
comment them.</p>
<p>So what other techniques can we use?  It starts to depend more on the
situation.  Are you nesting because you're writing a bunch of callbacks?  If
so, you can usually restructure your code to use named functions instead of
anonymous functions.  Here's how that would might look before refactoring:</p>
<pre class="code javascript literal-block">
<span class="kd">function</span> <span class="nx">getCachedUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cache</span><span class="p">.</span><span class="nx">setUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre>
<p>Note that in this example we even applied the technique of returning early in
the first callback function, but as you can see there's still a bunch of
nesting going on.  Now if we switch to using named functions?</p>
<pre class="code javascript literal-block">
<span class="kd">function</span> <span class="nx">curry</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">slice</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="kr">final</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">dbResult</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="p">.</span><span class="nx">setUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">curry</span><span class="p">(</span><span class="kr">final</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">user</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">cacheResult</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">curry</span><span class="p">(</span><span class="nx">dbResult</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">userId</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getCachedUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="p">.</span><span class="nx">getUser</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">curry</span><span class="p">(</span><span class="nx">cacheResult</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">userId</span><span class="p">));</span>
<span class="p">}</span>
</pre>
<p>This is a lot better in terms of nesting.  Unfortunately we had to write a
helper function called curry, but that only has to be written once and can be
re-used for all code written in this style.  Also unfortunately I still find
this kind of code difficult to follow, which is why I avoid writing much
callback-style code.  However, at least you can reduce the nesting.  In all
honesty, there are probably better ways of reducing nesting that I'm not aware
of.  If you can rewrite the <tt class="docutils literal">getCachedUser</tt> function in JS in a better way,
please blog it!</p>
<p>Another way to reduce nesting is to assign an intermediate variable.  Here's
an example in Erlang of some file function that nests a case statement within
another case statement.</p>
<pre class="code erlang literal-block">
<span class="nf">do_some_file_thing</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="n">open</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="p">[</span><span class="n">raw</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">read</span><span class="p">])</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Fd</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nv">Start</span> <span class="o">=</span> <span class="n">now</span><span class="p">(),</span>
            <span class="k">case</span> <span class="n">process_file_data</span><span class="p">(</span><span class="nv">Fd</span><span class="p">)</span> <span class="k">of</span>
                <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Processed</span><span class="p">}</span> <span class="o">-&gt;</span>
                    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="nv">Processed</span><span class="p">};</span>
                <span class="nv">Error</span> <span class="o">-&gt;</span>
                    <span class="nv">Error</span>
            <span class="k">end</span><span class="p">;</span>
        <span class="nv">Error</span> <span class="o">-&gt;</span>
            <span class="nv">Error</span>
    <span class="k">end</span><span class="p">.</span>
</pre>
<p>We can assign to an intermediate &quot;Resp&quot; variable, and bring that second case
statement out into the function's main code block, like so:</p>
<pre class="code erlang literal-block">
<span class="nf">do_some_file_thing</span><span class="p">(</span><span class="nv">File</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Resp</span> <span class="o">=</span> <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="n">open</span><span class="p">(</span><span class="nv">File</span><span class="p">,</span> <span class="p">[</span><span class="n">raw</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="n">read</span><span class="p">])</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Fd</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="p">{</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="n">process_file_data</span><span class="p">(</span><span class="nv">Fd</span><span class="p">)};</span>
        <span class="nv">Error</span> <span class="o">-&gt;</span>
            <span class="nv">Error</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="k">case</span> <span class="nv">Resp</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">timestamp</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Processed</span><span class="p">}}</span> <span class="o">-&gt;</span>
            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="nv">Processed</span><span class="p">};</span>
        <span class="p">{</span><span class="n">timestamp</span><span class="p">,</span> <span class="nv">Start</span><span class="p">,</span> <span class="nv">Error</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nv">Error</span><span class="p">;</span>
        <span class="nv">Error</span> <span class="o">-&gt;</span>
            <span class="nv">Error</span>
    <span class="k">end</span><span class="p">.</span>
</pre>
</div>
<div class="section" id="what-does-this-all-mean">
<h4>What does this all mean?</h4>
<p>At the end of the day, this isn't going to make or break you as a programmer.
In fact, nothing I've mentioned even changes the code's logic, but simply its
implementation.  It's simply something to think about as you code, as you read
other people's code.  Hopefully you agree with me that less nesting is an
admirable goal, and you find more and more ways to achieve it.</p>
<p>Discuss this post <a class="reference external" href="http://news.ycombinator.com/item?id=3414526">on Hacker News</a>.</p>
</div>
</div>

<div class="categories">
    Posted in:
    <ul>
      
        <li><a href="/blog/categories/programming/">Programming</a></li>
      
        <li><a href="/blog/categories/observations/">Observations</a></li>
      
    </ul>
  </div>
  <hr />

<h3 class="archive-link"><a href="/blog/archives/">Blog Archives</a></h3>

      </div>
    </div>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-1959803-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
  </body>
</html>